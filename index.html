<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyCargo - Complete Delivery Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
         <style>
        @font-face {
            font-family: 'Faruma';
            src: url('fonts/Mv_MAG_Round_XBold.otf');
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            overflow-x: hidden;
            color: #333;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            width: 100%;
            max-width: 100%;
            background: rgba(255, 255, 255, 0.95);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .dashboard-container {
            width: 100%;
            max-width: 100%;
            background: rgba(255, 255, 255, 0.95);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            display: none;
        }

        .top-panel {
            background: linear-gradient(135deg, #1a2a6c, #4cc9f0);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            position: relative;
            overflow: hidden;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1;
            margin-bottom: 10px;
        }

        .hero-text h1 {
            font-size: 24px;
            margin-bottom: 5px;
            line-height: 1.2;
            font-family: 'Faruma';
        }

        .hero-text p {
            font-size: 14px;
            opacity: 0.9;
        }

        .login-panel {
            padding: 25px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
            min-height: calc(100vh - 140px);
        }

        .login-form {
            display: block;
        }

        .login-form h2 {
            font-size: 22px;
            margin-bottom: 10px;
            color: #1a2a6c;
            text-align: center;
        }

        .login-form p {
            color: #666;
            margin-bottom: 25px;
            font-size: 14px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: #fff;
            color: #333;
        }

        .form-group input::placeholder, .form-group textarea::placeholder {
            color: #999;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #4cc9f0;
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.2);
            outline: none;
        }

        .options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .remember {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #333;
        }

        .remember input {
            width: 18px;
            height: 18px;
        }

        .forgot {
            color: #4cc9f0;
            text-decoration: none;
            font-weight: 500;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(to right, #1a2a6c, #4cc9f0);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(0, 0, 0, 0.1);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .signup {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }

        .signup a {
            color: #4cc9f0;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .truck-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .truck {
            font-size: 60px;
            color: #1a2a6c;
            filter: drop-shadow(0 0 10px rgba(76, 201, 240, 0.7));
            will-change: transform;
        }

        @keyframes smoothDrive {
            0% {
                transform: translateX(-200px) scale(0.8);
                opacity: 1;
            }
            10% {
                transform: translateX(-150px) scale(0.9);
                opacity: 1;
            }
            20% {
                transform: translateX(-100px) scale(1.0);
                opacity: 1;
            }
            30% {
                transform: translateX(-50px) scale(1.1);
                opacity: 1;
            }
            40% {
                transform: translateX(0) scale(1.2);
                opacity: 1;
            }
            50% {
                transform: translateX(50px) scale(1.3);
                opacity: 1;
            }
            60% {
                transform: translateX(100px) scale(1.4);
                opacity: 1;
            }
            70% {
                transform: translateX(150px) scale(1.5);
                opacity: 1;
            }
            80% {
                transform: translateX(200px) scale(1.6);
                opacity: 0.9;
            }
            90% {
                transform: translateX(250px) scale(1.7);
                opacity: 0.8;
            }
            100% {
                transform: translateX(300px) scale(1.8);
                opacity: 0;
            }
        }

        .driving {
            animation: smoothDrive 2s linear forwards;
        }

        .social-login {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .social-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }

        .social-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .social-btn i {
            font-size: 18px;
        }

        .facebook { color: #3b5998; }
        .google { color: #db4437; }
        .apple { color: #000; }

        .packages {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .package {
            position: absolute;
            color: rgba(26, 42, 108, 0.3);
            font-size: 30px;
            opacity: 0;
        }

        .package1 { top: 20%; left: 10%; }
        .package2 { top: 40%; left: 70%; }
        .package3 { top: 60%; left: 30%; }

        @keyframes packageFade {
            0% { opacity: 0; }
            50% { opacity: 0.7; }
            100% { opacity: 0; }
        }

        .package-animate {
            animation: packageFade 2s forwards;
        }

        /* Success message */
        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
            width: 90%;
            max-width: 350px;
        }

        .success-message.show {
            opacity: 1;
            visibility: visible;
        }

        .success-message i {
            font-size: 50px;
            color: #4cc9f0;
            margin-bottom: 15px;
        }

        .success-message h3 {
            font-size: 24px;
            color: #1a2a6c;
            margin-bottom: 10px;
        }

        .success-message p {
            color: #666;
            margin-bottom: 20px;
        }

        .continue-btn {
            padding: 12px 25px;
            background: linear-gradient(to right, #1a2a6c, #4cc9f0);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .continue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(0, 0, 0, 0.1);
        }

        /* Dashboard Styles */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #1a2a6c, #4cc9f0);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 100;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px;
            border-radius: 4px;
        }

        .menu-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
        }

        .user-role {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: linear-gradient(180deg, #1a2a6c 0%, #4cc9f0 100%);
            z-index: 200;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .close-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            padding: 5px;
            border-radius: 4px;
        }

        .close-sidebar:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            padding: 0;
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: rgba(255, 255, 255, 0.5);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: white;
        }

        .nav-link i {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: white;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-size: 16px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .logout-btn i {
            font-size: 18px;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .dashboard-content {
            padding: 20px;
            min-height: calc(100vh - 80px);
            transition: margin-left 0.3s ease;
        }

        .dashboard-section {
            display: none;
        }

        .dashboard-section.active {
            display: block;
        }

        .section-title {
            font-size: 24px;
            color: #1a2a6c;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-container {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }

        .form-title {
            font-size: 18px;
            color: #1a2a6c;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-field {
            width: 100%;
        }

        .form-field label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-field input, .form-field textarea, .form-field select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: #fff;
            color: #333;
        }

        .form-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-field input::placeholder, .form-field textarea::placeholder {
            color: #999;
        }

        .form-field input:focus, .form-field textarea:focus, .form-field select:focus {
            border-color: #4cc9f0;
            box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.2);
            outline: none;
        }

        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 12px;
            border: 1px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-label:hover {
            background: #f9f9f9;
        }

        .file-upload-label i {
            margin-right: 8px;
        }

        .submit-btn {
            padding: 12px 25px;
            background: linear-gradient(to right, #1a2a6c, #4cc9f0);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .data-container {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            min-width: 800px;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            font-size: 14px;
        }

        .data-table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #1a2a6c;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: #f9f9f9;
        }

        .empty-message {
            text-align: center;
            padding: 30px;
            color: #666;
            font-style: italic;
        }

        /* Progress tracking styles */
        .progress-container {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }

        .progress-tracker {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin: 30px 0;
        }

        .progress-tracker::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 4px;
            background: #f0f0f0;
            z-index: 1;
        }

        .progress-bar {
            position: absolute;
            top: 15px;
            left: 0;
            height: 4px;
            background: #4cc9f0;
            z-index: 2;
            transition: width 0.5s ease;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 3;
            flex: 1;
        }

        .progress-step-icon {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: all 0.3s;
            color: #666;
        }

        .progress-step.active .progress-step-icon {
            background: #4cc9f0;
            color: white;
            box-shadow: 0 0 0 4px rgba(76, 201, 240, 0.3);
        }

        .progress-step.completed .progress-step-icon {
            background: #4cc9f0;
            color: white;
        }

        .progress-step-label {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .progress-step.active .progress-step-label {
            color: #4cc9f0;
            font-weight: 600;
        }

        .progress-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .progress-btn {
            padding: 10px 20px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            color: #333;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .progress-btn:hover {
            background: #e9e9e9;
        }

        .progress-btn.primary {
            background: #4cc9f0;
            color: white;
            border-color: #4cc9f0;
        }

        .progress-btn.primary:hover {
            background: #3ab0d6;
        }

        /* Customer search */
        .search-container {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }

        .search-box {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .search-input {
            width: 100%;
        }

        .search-btn {
            padding: 12px 25px;
            background: #4cc9f0;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .search-btn:hover {
            background: #3ab0d6;
        }

        .customer-details {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }

        .customer-details.active {
            display: block;
        }

        .customer-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .delivery-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            border: 1px solid #f0f0f0;
        }

        .delivery-image.active {
            display: block;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .status-placed { background: #ff9800; }
        .status-processing { background: #2196f3; }
        .status-transit { background: #9c27b0; }
        .status-out { background: #ff5722; }
        .status-delivered { background: #4caf50; }
        .status-under-review { background: #ff9800; }
        .status-paid { background: #4caf50; }
        .status-pending { background: #f44336; }

        /* Status update modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            padding: 20px;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: #fff;
            border-radius: 16px;
            padding: 25px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .modal-title {
            font-size: 20px;
            color: #1a2a6c;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .modal-btn.cancel {
            background: #e0e0e0;
            color: #333;
        }

        .modal-btn.confirm {
            background: #4cc9f0;
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        /* Action buttons in tables */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            text-align: center;
        }

        .update-btn {
            background: #4cc9f0;
            color: white;
        }

        .delete-btn {
            background: #f44336;
            color: white;
        }

        .view-btn {
            background: #9c27b0;
            color: white;
        }

        .review-btn {
            background: #ff9800;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(26, 42, 108, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: all 0.3s;
            max-width: 300px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-content {
            flex: 1;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
        }

        .notification-slide-out {
            transform: translateX(100%);
            opacity: 0;
        }

        /* Package weight and pricing styles */
        .weight-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .weight-option {
            flex: 1;
            min-width: 120px;
        }

        .weight-btn {
            width: 100%;
            padding: 12px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .weight-btn:hover {
            background: #e9e9e9;
        }

        .weight-btn.active {
            background: #4cc9f0;
            color: white;
            border-color: #4cc9f0;
        }

        .price-display {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .price-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .price-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a2a6c;
        }

        .currency {
            font-size: 16px;
            color: #4cc9f0;
        }

        /* Payment modal */
        .payment-modal {
            background: #fff;
            border-radius: 16px;
            padding: 25px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .bank-details {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .bank-info {
            margin-bottom: 10px;
        }

        .bank-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .bank-value {
            font-size: 16px;
            font-weight: 600;
            color: #1a2a6c;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-btn {
            background: #4cc9f0;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: #3ab0d6;
        }

        .payment-actions {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 20px;
        }

        .payment-btn {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            flex: 1;
        }

        .payment-btn.cancel {
            background: #e0e0e0;
            color: #333;
        }

        .payment-btn.confirm {
            background: #4cc9f0;
            color: white;
        }

        .payment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        /* Price management section */
        .price-management {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }

        .price-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .price-input-group {
            display: flex;
            gap: 15px;
        }

        .price-input {
            flex: 1;
        }

        .add-price-btn {
            padding: 12px 20px;
            background: #4cc9f0;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-price-btn:hover {
            background: #3ab0d6;
        }

        .price-list {
            margin-top: 20px;
        }

        .price-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .price-item:last-child {
            border-bottom: none;
        }

        .price-range {
            font-weight: 500;
        }

        .price-amount {
            font-weight: 600;
            color: #1a2a6c;
        }

        .price-actions {
            display: flex;
            gap: 10px;
        }

        .edit-price-btn, .remove-price-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .edit-price-btn {
            background: #4cc9f0;
            color: white;
        }

        .remove-price-btn {
            background: #f44336;
            color: white;
        }

        /* Bank slip modal */
        .slip-modal {
            background: #fff;
            border-radius: 16px;
            padding: 25px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .slip-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #f0f0f0;
        }

        /* User management styles */
        .user-management {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }

        .user-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .user-input-group {
            display: flex;
            gap: 15px;
        }

        .user-input {
            flex: 1;
        }

        .add-user-btn {
            padding: 12px 20px;
            background: #4cc9f0;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-user-btn:hover {
            background: #3ab0d6;
        }

        .user-list {
            margin-top: 20px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .user-email {
            font-size: 14px;
            color: #666;
        }

        .user-role {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            background: #4cc9f0;
        }

        .user-role.admin {
            background: #ff9800;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .edit-user-btn, .remove-user-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .edit-user-btn {
            background: #4cc9f0;
            color: white;
        }

        .remove-user-btn {
            background: #f44336;
            color: white;
        }

        /* Create account form */
        .create-account-form {
            display: none;
        }

        .create-account-form.active {
            display: block;
        }

        .back-to-login {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }

        .back-to-login a {
            color: #4cc9f0;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        /* Records Management Tabs */
        .records-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .records-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .records-tab.active {
            background: #4cc9f0;
            color: white;
        }

        .records-content {
            display: none;
        }

        .records-content.active {
            display: block;
        }

        /* Permanent Notifications Panel */
        .notifications-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: #fff;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 300;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .notifications-panel.active {
            right: 0;
        }

        .notifications-header {
            padding: 20px;
            background: linear-gradient(135deg, #1a2a6c, #4cc9f0);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notifications-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .notifications-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .notification-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4cc9f0;
            background: #f9f9f9;
            transition: all 0.3s;
            position: relative;
        }

        .notification-item.unread {
            background: #e8f4fd;
            border-left-color: #4caf50;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: 600;
            color: #1a2a6c;
            font-size: 16px;
        }

        .notification-time {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            margin-left: 10px;
        }

        .notification-message {
            color: #555;
            font-size: 14px;
            line-height: 1.4;
        }

        .notification-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff5722;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .notifications-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4cc9f0;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 250;
            transition: all 0.3s;
        }

        .notifications-toggle:hover {
            background: #3ab0d6;
            transform: scale(1.05);
        }

        .notifications-toggle.has-unread::after {
            content: '';
            position: absolute;
            top: 5px;
            right: 5px;
            width: 12px;
            height: 12px;
            background: #ff5722;
            border-radius: 50%;
            border: 2px solid white;
        }

        /* Revenue Dashboard Styles */
        .revenue-dashboard {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }

        .revenue-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .revenue-card {
            background: linear-gradient(135deg, #1a2a6c, #4cc9f0);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .revenue-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .revenue-card .amount {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .revenue-card .period {
            font-size: 14px;
            opacity: 0.8;
        }

        .revenue-chart {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e0e0e0;
        }

        .revenue-chart h3 {
            margin-bottom: 15px;
            color: #1a2a6c;
        }

        /* Reference number styles */
        .reference-link {
            color: #1a2a6c;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .reference-link:hover {
            color: #4cc9f0;
            text-decoration: underline;
        }

        .reference-completed {
            color: #4caf50;
        }

        .reference-pending {
            color: #f44336;
        }

        /* New styles for countdown timer */
        .countdown-timer {
            background: linear-gradient(135deg, #1a2a6c, #4cc9f0);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .countdown-label {
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .countdown-display {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .countdown-unit {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 50px;
        }

        .countdown-value {
            font-size: 24px;
            line-height: 1;
        }

        .countdown-label-small {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Price Management Tabs */
        .price-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .price-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .price-tab.active {
            background: #4cc9f0;
            color: white;
        }

        .price-content {
            display: none;
        }

        .price-content.active {
            display: block;
        }

        /* Price overlap validation styles */
        .price-overlap-warning {
            color: #f44336;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .price-range-validation {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
        }

        .validation-message {
            font-size: 14px;
            padding: 5px;
            border-radius: 4px;
        }

        .validation-success {
            background-color: #e8f5e9;
            color: #4caf50;
        }

        .validation-error {
            background-color: #ffebee;
            color: #f44336;
        }

        /* Mobile-specific adjustments */
        @media (min-width: 769px) {
            .sidebar {
                left: 0;
            }
            
            .dashboard-content {
                margin-left: 280px;
            }
            
            .menu-toggle {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .dashboard-content {
                padding: 15px;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th, .data-table td {
                padding: 8px;
            }
            
            .progress-tracker {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .progress-step {
                flex: 0 0 33%;
                margin-bottom: 10px;
            }
            
            .weight-options {
                flex-direction: column;
            }
            
            .price-input-group {
                flex-direction: column;
            }
            
            .user-input-group {
                flex-direction: column;
            }
            
            .notifications-panel {
                width: 100%;
                right: -100%;
            }
            
            .revenue-stats {
                grid-template-columns: 1fr;
            }
            
            .countdown-display {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 480px) {
            .login-panel {
                padding: 20px 15px;
            }
            
            .dashboard-content {
                padding: 15px 10px;
            }
            
            .form-container, .data-container, .search-container, .progress-container {
                padding: 15px;
            }
            
            .progress-step {
                flex: 0 0 50%;
            }
            
            .payment-actions {
                flex-direction: column;
            }
        }

        /* New styles for reference numbers panel */
        .references-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: #fff;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 300;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .references-panel.active {
            right: 0;
        }

        .references-header {
            padding: 20px;
            background: linear-gradient(135deg, #1a2a6c, #4cc9f0);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .references-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .references-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .references-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .references-toggle {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #4cc9f0;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 250;
            transition: all 0.3s;
        }

        .references-toggle:hover {
            background: #3ab0d6;
            transform: scale(1.05);
        }

        .reference-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4cc9f0;
            background: #f9f9f9;
            transition: all 0.3s;
            cursor: pointer;
        }

        .reference-item:hover {
            background: #e8f4fd;
        }

        .reference-item.completed {
            border-left-color: #4caf50;
        }

        .reference-item.pending {
            border-left-color: #ff9800;
        }

        .reference-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .reference-number {
            font-weight: 600;
            color: #1a2a6c;
            font-size: 16px;
        }

        .reference-type {
            font-size: 12px;
            color: #666;
            background: #e0e0e0;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .reference-details {
            color: #555;
            font-size: 14px;
            line-height: 1.4;
        }

        .reference-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            margin-top: 8px;
        }

        .status-delivered { background: #4caf50; }
        .status-pending { background: #ff9800; }
        .status-processing { background: #2196f3; }

        /* Date filter styles */
        .date-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            min-width: 150px;
        }

        .date-input-group label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .date-filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .filter-btn {
            padding: 10px 20px;
            background: #4cc9f0;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: #3ab0d6;
        }

        .filter-btn.reset {
            background: #e0e0e0;
            color: #333;
        }

        .filter-btn.reset:hover {
            background: #d0d0d0;
        }

        /* Location-specific fields */
        .location-specific {
            display: none;
        }

        .location-specific.active {
            display: block;
        }

        /* Greater Male City Styles */
        .item-size-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .item-size-option {
            flex: 1;
        }

        .item-size-btn {
            width: 100%;
            padding: 12px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .item-size-btn:hover {
            background: #e9e9e9;
        }

        .item-size-btn.active {
            background: #4cc9f0;
            color: white;
            border-color: #4cc9f0;
        }

        .item-size-icon {
            font-size: 20px;
        }

        .vehicle-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .vehicle-option {
            flex: 1;
        }

        .vehicle-btn {
            width: 100%;
            padding: 12px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .vehicle-btn:hover {
            background: #e9e9e9;
        }

        .vehicle-btn.active {
            background: #4cc9f0;
            color: white;
            border-color: #4cc9f0;
        }

        .vehicle-btn.disabled {
            background: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }

        .vehicle-icon {
            font-size: 24px;
        }

        .quantity-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .quantity-btn {
            width: 40px;
            height: 40px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .quantity-btn:hover {
            background: #e9e9e9;
        }

        .quantity-input input {
            flex: 1;
            text-align: center;
            padding: 10px;
        }

        .destination-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .destination-option {
            flex: 1;
        }

        .destination-btn {
            width: 100%;
            padding: 12px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .destination-btn:hover {
            background: #e9e9e9;
        }

        .destination-btn.active {
            background: #4cc9f0;
            color: white;
            border-color: #4cc9f0;
        }

        .price-breakdown {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .price-item-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .price-item-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .price-total {
            font-weight: 700;
            font-size: 18px;
            color: #1a2a6c;
        }

        /* Management Panel Styles */
        .management-panel {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }
        
        .management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .management-title {
            font-size: 18px;
            color: #1a2a6c;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .management-actions {
            display: flex;
            gap: 10px;
        }
        
        .management-list {
            margin-top: 20px;
        }
        
        .management-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .management-item:last-child {
            border-bottom: none;
        }
        
        .management-item-details {
            flex: 1;
        }
        
        .management-item-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .management-item-description {
            font-size: 14px;
            color: #666;
        }
        
        .management-item-actions {
            display: flex;
            gap: 10px;
        }
        
        .add-management-btn {
            padding: 10px 20px;
            background: #4cc9f0;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .add-management-btn:hover {
            background: #3ab0d6;
        }
        
        /* Social Login Links */
        .social-login a {
            text-decoration: none;
            color: inherit;
        }

        /* NEW STYLES FOR IMPROVED TRACKING SYSTEM */
        
        /* Customer search results with all references */
        .customer-references {
            margin-top: 20px;
            display: none;
        }
        
        .customer-references.active {
            display: block;
        }
        
        .reference-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .reference-card {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .reference-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .reference-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .reference-card-type {
            font-size: 12px;
            color: #666;
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .reference-card-details {
            font-size: 14px;
            color: #555;
        }
        
        .reference-card-date {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }
        
        /* Item size visualization */
        .item-size-visual {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .item-size-image {
            width: 60px;
            height: 60px;
            background: #f0f0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 24px;
            color: #4cc9f0;
        }
        
        .item-size-description {
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        
        /* Enhanced references panel */
        .references-panel .reference-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #4cc9f0;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .references-panel .reference-item:hover {
            background: #e8f4fd;
        }
        
        .references-panel .reference-item.completed {
            border-left-color: #4caf50;
        }
        
        .references-panel .reference-item.pending {
            border-left-color: #ff9800;
        }
        
        .references-panel .reference-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }
        
        .references-panel .reference-number {
            font-weight: 600;
            color: #1a2a6c;
            font-size: 14px;
        }
        
        .references-panel .reference-type {
            font-size: 10px;
            color: #666;
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 8px;
        }
        
        .references-panel .reference-details {
            color: #555;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .references-panel .reference-date {
            font-size: 11px;
            color: #888;
            margin-top: 5px;
        }
        
        .references-panel .reference-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            color: white;
            margin-top: 5px;
        }
    </style>
    <style>
        /* All CSS styles from your original code */
        @font-face {
            font-family: 'Faruma';
            src: url('fonts/Mv_MAG_Round_XBold.otf');
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            overflow-x: hidden;
            color: #333;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            width: 100%;
            max-width: 100%;
            background: rgba(255, 255, 255, 0.95);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .dashboard-container {
            width: 100%;
            max-width: 100%;
            background: rgba(255, 255, 255, 0.95);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            display: none;
        }

        /* ... All other CSS styles from your original code ... */

        /* Google Maps Integration Styles */
        .map-container {
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }

        .map-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f9f9f9;
            border-bottom: 1px solid #e0e0e0;
        }

        .map-toggle-label {
            font-weight: 500;
            color: #333;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4cc9f0;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .map-content {
            padding: 15px;
            background: white;
        }

        .map-search-container {
            margin-bottom: 15px;
        }

        .map-search-box {
            position: relative;
            margin-bottom: 10px;
        }

        .map-search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .map-search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .map-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .map-btn {
            padding: 10px 15px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .map-btn:hover {
            background: #e9e9e9;
        }

        .map-btn.primary {
            background: #4cc9f0;
            color: white;
            border-color: #4cc9f0;
        }

        .map-btn.primary:hover {
            background: #3ab0d6;
        }

        .map-display {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .map-marker-preview {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .marker-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .marker-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .marker-color.pickup {
            background-color: #4caf50;
        }

        .marker-color.destination {
            background-color: #ff5722;
        }

        .marker-label {
            font-size: 14px;
            color: #333;
        }

        .selected-location-info {
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .location-details {
            margin-bottom: 10px;
        }

        .location-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .location-value {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .coordinates {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #666;
        }

        .coordinate-item {
            display: flex;
            flex-direction: column;
        }

        .coordinate-label {
            font-size: 12px;
            color: #999;
        }

        .coordinate-value {
            font-size: 14px;
            color: #333;
        }

        .map-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }

        .map-loading i {
            font-size: 48px;
            margin-bottom: 10px;
            color: #4cc9f0;
        }

        .map-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #f44336;
            text-align: center;
            padding: 20px;
        }

        .map-error i {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* Area-based pricing styles */
        .area-pricing-container {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }

        .area-pricing-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .area-input-group {
            display: flex;
            gap: 15px;
        }

        .area-input {
            flex: 1;
        }

        .area-list {
            margin-top: 20px;
        }

        .area-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .area-item:last-child {
            border-bottom: none;
        }

        .area-details {
            flex: 1;
        }

        .area-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .area-coordinates {
            font-size: 14px;
            color: #666;
        }

        .area-price {
            font-weight: 600;
            color: #1a2a6c;
            margin-right: 15px;
        }

        .area-actions {
            display: flex;
            gap: 10px;
        }

        .add-area-btn {
            padding: 12px 20px;
            background: #4cc9f0;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-area-btn:hover {
            background: #3ab0d6;
        }

        /* Area visualization on map */
        .area-polygon {
            fill-opacity: 0.3;
            stroke-width: 2;
        }

        /* Enhanced map controls */
        .map-mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .map-mode-btn {
            padding: 8px 15px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .map-mode-btn.active {
            background: #4cc9f0;
            color: white;
            border-color: #4cc9f0;
        }

        .map-selection-info {
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .location-selection {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .location-selection-item {
            flex: 1;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
        }

        .location-selection-title {
            font-weight: 500;
            margin-bottom: 10px;
            color: #333;
        }

        .location-selection-details {
            font-size: 14px;
            color: #666;
        }

        /* Responsive adjustments for maps */
        @media (max-width: 768px) {
            .map-actions {
                flex-direction: column;
            }
            
            .area-input-group {
                flex-direction: column;
            }
            
            .coordinates {
                flex-direction: column;
                gap: 5px;
            }
            
            .location-selection {
                flex-direction: column;
            }
        }
    </style>
    <style>
        /* All other CSS styles from your original code */
        /* ... (All the CSS from your original code) ... */
        
        /* Additional styles for map-based pricing */
        .map-pricing-info {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .pricing-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .pricing-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .pricing-item:last-child {
            border-bottom: none;
        }
        
        .pricing-label {
            font-weight: 500;
            color: #333;
        }
        
        .pricing-value {
            font-weight: 600;
            color: #1a2a6c;
        }
        
        .pricing-total {
            font-size: 18px;
            font-weight: 700;
            color: #1a2a6c;
        }
        
        .location-link {
            color: #4cc9f0;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            margin-top: 5px;
            display: inline-block;
        }
        
        .location-link:hover {
            text-decoration: underline;
        }
        
        .records-location-link {
            color: #4cc9f0;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        
        .records-location-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Audio element for notification sound -->
    <audio id="notificationSound" preload="auto" style="display: none;">
        <source src="new-notification-09-352705.mp3" type="audio/mpeg">
    </audio>

    <!-- Login Container -->
    <div class="container" id="loginContainer">
        <div class="top-panel">
            <div class="logo">
                <i class="fas fa-truck"></i>
                <span>EasyCargo</span>
            </div>
            <div class="hero-text">
                <h1>ދިވެހިރާއްޖެ</h1>
                <p>Your cargo, our commitment</p>
            </div>
        </div>
        
        <div class="login-panel" id="loginPanel">
            <div class="packages">
                <i class="fas fa-box package package1"></i>
                <i class="fas fa-box package package2"></i>
                <i class="fas fa-box package package3"></i>
            </div>
            <!-- Login Form -->
            <div class="login-form" id="loginFormSection">
                <h2>Welcome to EasyCargo</h2>
                <p>Sign in to track and manage shipments</p>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginUsername">Username or Email</label>
                        <input type="text" id="loginUsername" placeholder="Enter your username or email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" placeholder="Enter your password" required>
                    </div>
                    
                    <div class="options">
                        <div class="remember">
                            <input type="checkbox" id="remember">
                            <label for="remember">Remember me</label>
                        </div>
                        <a href="#" class="forgot">Forgot password?</a>
                    </div>
                    
                    <button type="submit" class="login-btn" id="loginBtn">
                        <span>Sign In</span>
                        <i class="fas fa-truck-loading"></i>
                    </button>
                </form>
                
                <div class="social-login">
                    <a href="https://web.facebook.com/profile.php?id=61581778516619" target="_blank" class="social-btn facebook">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="https://google.com" target="_blank" class="social-btn google">
                        <i class="fab fa-google"></i>
                    </a>
                    <a href="https://apple.com" target="_blank" class="social-btn apple">
                        <i class="fab fa-apple"></i>
                    </a>
                </div>
                
                <div class="signup">
                    Don't have an account? <a id="showCreateAccount">Create account</a>
                </div>
            </div>
            
            <!-- Create Account Form -->
            <div class="login-form create-account-form" id="createAccountSection">
                <h2>Create Account</h2>
                <p>Sign up for a new account</p>
                
                <form id="createAccountForm">
                    <div class="form-group">
                        <label for="createUsername">Username</label>
                        <input type="text" id="createUsername" placeholder="Enter your username" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="createEmail">Email Address</label>
                        <input type="email" id="createEmail" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="createContact">Contact Number</label>
                        <input type="tel" id="createContact" placeholder="Enter your contact number" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="createPassword">Password</label>
                        <input type="password" id="createPassword" placeholder="Create a password" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                    </div>
                    
                    <button type="submit" class="login-btn" id="createAccountBtn">
                        <span>Create Account</span>
                        <i class="fas fa-user-plus"></i>
                    </button>
                </form>
                
                <div class="back-to-login">
                    Already have an account? <a id="showLoginForm">Sign in</a>
                </div>
            </div>
        </div>
        
        <div class="truck-container" id="truckContainer">
            <i class="fas fa-truck truck" id="truck"></i>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Notifications Panel -->
        <div class="notifications-panel" id="notificationsPanel">
            <div class="notifications-header">
                <div class="notifications-title">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                </div>
                <button class="notifications-close" id="closeNotifications">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="notifications-content" id="notificationsContent">
                <!-- Notifications will be populated here -->
            </div>
        </div>

        <!-- References Panel -->
        <div class="references-panel" id="referencesPanel">
            <div class="references-header">
                <div class="references-title">
                    <i class="fas fa-list"></i>
                    <span>All Delivery References</span>
                </div>
                <button class="references-close" id="closeReferences">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="references-content" id="referencesContent">
                <!-- References will be populated here -->
            </div>
        </div>

        <!-- Notifications Toggle -->
        <button class="notifications-toggle" id="notificationsToggle">
            <i class="fas fa-bell"></i>
        </button>

        <!-- References Toggle -->
        <button class="references-toggle" id="referencesToggle">
            <i class="fas fa-list"></i>
        </button>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-truck"></i>
                    <span>EasyCargo</span>
                </div>
                <button class="close-sidebar" id="closeSidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="sidebar-nav" id="sidebarNav">
                <!-- Navigation items will be populated based on user role -->
            </div>
            
            <div class="sidebar-footer">
                <button class="logout-btn" id="sidebarLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </div>
        
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <div class="user-name" id="userName">User Name</div>
                    <div class="user-role" id="userRole">Role</div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- Cargo Delivery Section -->
            <div class="dashboard-section active" id="cargo-delivery">
                <h2 class="section-title">Cargo Delivery Management</h2>
                
                <div class="form-container">
                    <h3 class="form-title"><i class="fas fa-truck"></i> Cargo Delivery Form</h3>
                    <form id="cargoForm">
                        <div class="form-group">
                            <label for="customerName">Customer Name</label>
                            <input type="text" id="customerName" placeholder="Enter customer name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="customerContact">Contact Number</label>
                            <input type="tel" id="customerContact" placeholder="Enter contact number" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="pickupLocation">Pickup Location</label>
                            <select id="pickupLocation" required>
                                <option value="">Select Pickup Location</option>
                                <option value="Post Office">Post Office</option>
                                <option value="Pickpost">Pickpost</option>
                                <option value="Redbox">Redbox</option>
                                <option value="Male">Male</option>
                                <option value="Hulhumale">Hulhumale</option>
                                <option value="Phase2">Phase 2</option>
                            </select>
                        </div>
                        
                        <!-- Package Details Field (for Post Office, Pickpost, Redbox) -->
                        <div class="location-specific" id="packageDetailsField">
                            <div class="form-group">
                                <label for="packageDetails">Package Details</label>
                                <textarea id="packageDetails" placeholder="Enter package details" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <!-- Address Field (for Male, Hulhumale, Phase2) -->
                        <div class="location-specific" id="addressField">
                            <div class="form-group">
                                <label for="addressName">Address Name</label>
                                <input type="text" id="addressName" placeholder="Enter full address">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="deliveryLocation">Delivery Location</label>
                            <select id="deliveryLocation" required>
                                <option value="">Select Delivery Location</option>
                                <option value="Addu">Addu</option>
                                <option value="Fuvamulak">Fuvamulak</option>
                                <option value="Laam Gan">Laam Gan</option>
                                <option value="Kulhudhufushi">Kulhudhufushi</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Package Weight Range (kg)</label>
                            <div class="weight-options" id="weightOptions">
                                <!-- Weight options will be populated here -->
                            </div>
                        </div>
                        
                        <div class="price-display" id="priceDisplay">
                            <div class="price-label">Delivery Price</div>
                            <div class="price-value"><span class="currency">MVR</span> <span id="deliveryPrice">0</span></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="deliveryDate">Expected Delivery Date</label>
                            <input type="date" id="deliveryDate" required>
                        </div>
                        
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-save"></i> Save Cargo Delivery
                        </button>
                    </form>
                </div>

                <!-- User's Cargo Reference Numbers -->
                <div class="data-container">
                    <h3 class="form-title"><i class="fas fa-list"></i> My Cargo Delivery Reference Numbers</h3>
                    <div id="userCargoReferences">
                        <!-- User's cargo reference numbers will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Boat Delivery Section -->
            <div class="dashboard-section" id="boat-delivery">
                <h2 class="section-title">Boat Delivery Management</h2>
                
                <div class="form-container">
                    <h3 class="form-title"><i class="fas fa-ship"></i> New Boat Delivery</h3>
                    <form id="boatForm">
                        <div class="form-row">
                            <div class="form-field">
                                <label for="boatCustomerName">Customer Name</label>
                                <input type="text" id="boatCustomerName" placeholder="Enter customer name" required>
                            </div>
                            <div class="form-field">
                                <label for="boatCustomerContact">Contact Number</label>
                                <input type="tel" id="boatCustomerContact" placeholder="Enter contact number" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="pickupMessage">Pickup Message</label>
                                <textarea id="pickupMessage" placeholder="Enter pickup message" required></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="boatName">Boat Name</label>
                                <input type="text" id="boatName" placeholder="Enter boat name" required>
                            </div>
                            <div class="form-field">
                                <label for="island">Island</label>
                                <input type="text" id="island" placeholder="Enter island name" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="packageLabel">Package Label</label>
                                <input type="text" id="packageLabel" placeholder="Enter package label" required>
                            </div>
                            <div class="form-field">
                                <label>Package Weight Range (kg)</label>
                                <div class="weight-options" id="boatWeightOptions">
                                    <!-- Weight options will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="price-display" id="boatPriceDisplay">
                            <div class="price-label">Delivery Price</div>
                            <div class="price-value"><span class="currency">MVR</span> <span id="boatDeliveryPrice">0</span></div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="boatDeliveryDate">Expected Delivery Date</label>
                                <input type="date" id="boatDeliveryDate" required>
                            </div>
                        </div>
                        
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-save"></i> Save Boat Delivery
                        </button>
                    </form>
                </div>

                <!-- User's Boat Reference Numbers -->
                <div class="data-container">
                    <h3 class="form-title"><i class="fas fa-list"></i> My Boat Delivery Reference Numbers</h3>
                    <div id="userBoatReferences">
                        <!-- User's boat reference numbers will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Greater Male City Delivery Section -->
            <div class="dashboard-section" id="greater-male-delivery">
                <h2 class="section-title">Greater Male City Delivery</h2>
                
                <div class="form-container">
                    <h3 class="form-title"><i class="fas fa-city"></i> Greater Male City Delivery Form</h3>
                    <form id="greaterMaleForm">
                        <div class="form-group">
                            <label for="greaterMaleCustomerName">Customer Name</label>
                            <input type="text" id="greaterMaleCustomerName" placeholder="Enter customer name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="greaterMaleCustomerContact">Contact Number</label>
                            <input type="tel" id="greaterMaleCustomerContact" placeholder="Enter contact number" required>
                        </div>

                        <!-- Google Maps Integration -->
                        <div class="map-container">
                            <div class="map-toggle">
                                <span class="map-toggle-label">Use Google Maps for Location Selection</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableMap">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div id="mapContent" class="map-content" style="display: none;">
                                <div class="map-search-container">
                                    <div class="map-search-box">
                                        <input type="text" id="mapSearchInput" class="map-search-input" 
                                               placeholder="Search for pickup location...">
                                        <i class="fas fa-search map-search-icon"></i>
                                    </div>
                                    
                                    <div class="map-mode-selector">
                                        <button type="button" class="map-mode-btn active" id="pickupModeBtn">
                                            <i class="fas fa-map-marker-alt"></i>
                                            Pickup Location
                                        </button>
                                        <button type="button" class="map-mode-btn" id="destinationModeBtn">
                                            <i class="fas fa-flag-checkered"></i>
                                            Destination
                                        </button>
                                    </div>
                                    
                                    <div class="map-actions">
                                        <button type="button" class="map-btn" id="useCurrentLocation">
                                            <i class="fas fa-location-arrow"></i>
                                            Current Location
                                        </button>
                                        <button type="button" class="map-btn" id="searchLocation">
                                            <i class="fas fa-search"></i>
                                            Search Area
                                        </button>
                                        <button type="button" class="map-btn" id="clearMap">
                                            <i class="fas fa-trash"></i>
                                            Clear Map
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="mapDisplay" class="map-display">
                                    <div id="mapLoading" class="map-loading">
                                        <i class="fas fa-map-marked-alt"></i>
                                        <p>Loading Google Maps...</p>
                                    </div>
                                    <div id="mapError" class="map-error" style="display: none;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <p>Failed to load Google Maps. Please check your internet connection.</p>
                                    </div>
                                    <div id="map" style="height: 100%; width: 100%; display: none;"></div>
                                </div>
                                
                                <div class="map-marker-preview">
                                    <div class="marker-item">
                                        <div class="marker-color pickup"></div>
                                        <span class="marker-label">Pickup Location</span>
                                    </div>
                                    <div class="marker-item">
                                        <div class="marker-color destination"></div>
                                        <span class="marker-label">Destination</span>
                                    </div>
                                </div>
                                
                                <div class="location-selection">
                                    <div class="location-selection-item">
                                        <div class="location-selection-title">Pickup Location</div>
                                        <div class="location-selection-details" id="pickupLocationDetails">Not selected</div>
                                    </div>
                                    <div class="location-selection-item">
                                        <div class="location-selection-title">Destination</div>
                                        <div class="location-selection-details" id="destinationLocationDetails">Not selected</div>
                                    </div>
                                </div>
                                
                                <div id="selectedLocationInfo" class="selected-location-info" style="display: none;">
                                    <div class="location-details">
                                        <div class="location-label">Selected Location</div>
                                        <div class="location-value" id="selectedLocationName">No location selected</div>
                                    </div>
                                    <div class="coordinates">
                                        <div class="coordinate-item">
                                            <div class="coordinate-label">Latitude</div>
                                            <div class="coordinate-value" id="selectedLatitude">0.000000</div>
                                        </div>
                                        <div class="coordinate-item">
                                            <div class="coordinate-label">Longitude</div>
                                            <div class="coordinate-value" id="selectedLongitude">0.000000</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Map-based Pricing Information -->
                                <div id="mapPricingInfo" class="map-pricing-info" style="display: none;">
                                    <h4>Pricing Details</h4>
                                    <div class="pricing-details">
                                        <div class="pricing-item">
                                            <span class="pricing-label">Item Price:</span>
                                            <span class="pricing-value" id="mapItemPrice">0 MVR</span>
                                        </div>
                                        <div class="pricing-item">
                                            <span class="pricing-label">Vehicle Fee:</span>
                                            <span class="pricing-value" id="mapVehiclePrice">0 MVR</span>
                                        </div>
                                        <div class="pricing-item">
                                            <span class="pricing-label">Destination Fee:</span>
                                            <span class="pricing-value" id="mapDestinationPrice">0 MVR</span>
                                        </div>
                                        <div class="pricing-item pricing-total">
                                            <span class="pricing-label">Total:</span>
                                            <span class="pricing-value" id="mapTotalPrice">0 MVR</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="button" class="map-btn primary" id="confirmLocation" style="width: 100%; margin-top: 15px;">
                                    <i class="fas fa-check"></i>
                                    Confirm Map Locations
                                </button>
                            </div>
                        </div>

                        <!-- Manual Location Selection (shown when map is disabled) -->
                        <div id="manualLocationSection">
                            <div class="form-group">
                                <label for="greaterMalePickupLocation">Pickup Location</label>
                                <select id="greaterMalePickupLocation" required>
                                    <option value="">Select Pickup Location</option>
                                    <!-- Pickup locations will be populated from management -->
                                </select>
                            </div>
                            
                            <!-- Address Field for Male, Hulhumale, Phase2 -->
                            <div class="form-group" id="greaterMaleAddressField">
                                <label for="greaterMaleAddressName">Address Name</label>
                                <input type="text" id="greaterMaleAddressName" placeholder="Enter full address">
                            </div>
                            
                            <!-- Package Details Field for Redbox, Post Office, Pickpost -->
                            <div class="form-group" id="greaterMalePackageDetailsField">
                                <label for="greaterMalePackageDetails">Package Details</label>
                                <textarea id="greaterMalePackageDetails" placeholder="Enter package details" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Select Destination</label>
                                <div class="destination-options" id="destinationOptions">
                                    <!-- Destination options will be populated from management -->
                                </div>
                            </div>
                            
                            <!-- Boat Name Field for Male to Boat and Hulhumale to Boat -->
                            <div class="form-group" id="boatNameField">
                                <label for="boatNameInput">Boat Name</label>
                                <input type="text" id="boatNameInput" placeholder="Enter boat name">
                            </div>
                            
                            <!-- Address Name Field for other destinations -->
                            <div class="form-group" id="destinationAddressField">
                                <label for="destinationAddressName">Address Name</label>
                                <input type="text" id="destinationAddressName" placeholder="Enter destination address">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Select Delivery Item Size</label>
                            <div class="item-size-options" id="itemSizeOptions">
                                <!-- Item size options will be populated from management -->
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="itemQuantity">Quantity</label>
                            <div class="quantity-input">
                                <button type="button" class="quantity-btn" id="decreaseQuantity">-</button>
                                <input type="number" id="itemQuantity" value="1" min="1" max="10">
                                <button type="button" class="quantity-btn" id="increaseQuantity">+</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Select Vehicle</label>
                            <div class="vehicle-options" id="vehicleOptions">
                                <!-- Vehicle options will be populated from management -->
                            </div>
                        </div>
                        
                        <div class="price-breakdown" id="greaterMalePriceBreakdown">
                            <div class="price-item-row">
                                <span>Item Price:</span>
                                <span id="itemPriceValue">0 MVR</span>
                            </div>
                            <div class="price-item-row">
                                <span>Vehicle Fee:</span>
                                <span id="vehiclePriceValue">0 MVR</span>
                            </div>
                            <div class="price-item-row">
                                <span>Destination Fee:</span>
                                <span id="destinationPriceValue">0 MVR</span>
                            </div>
                            <div class="price-item-row price-total">
                                <span>Total:</span>
                                <span id="greaterMaleTotalPrice">0 MVR</span>
                            </div>
                        </div>
                        
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-save"></i> Save Greater Male Delivery
                        </button>
                    </form>
                </div>

                <!-- User's Greater Male City Reference Numbers -->
                <div class="data-container">
                    <h3 class="form-title"><i class="fas fa-list"></i> My Greater Male City Delivery Reference Numbers</h3>
                    <div id="userGreaterMaleReferences">
                        <!-- User's Greater Male City reference numbers will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Area-Based Pricing Section -->
            <div class="dashboard-section" id="area-pricing">
                <h2 class="section-title">Area-Based Pricing Management</h2>
                
                <div class="area-pricing-container">
                    <h3 class="form-title"><i class="fas fa-map-marker-alt"></i> Define Delivery Areas and Prices</h3>
                    
                    <div class="area-pricing-form">
                        <div class="area-input-group">
                            <div class="form-field area-input">
                                <label for="areaName">Area Name</label>
                                <input type="text" id="areaName" placeholder="Enter area name">
                            </div>
                            <div class="form-field area-input">
                                <label for="areaPrice">Price (MVR)</label>
                                <input type="number" id="areaPrice" placeholder="Price in MVR" min="0" step="0.01">
                            </div>
                        </div>
                        
                        <div class="map-container">
                            <div class="map-content">
                                <div class="map-search-container">
                                    <div class="map-search-box">
                                        <input type="text" id="areaSearchInput" class="map-search-input" 
                                               placeholder="Search for area...">
                                        <i class="fas fa-search map-search-icon"></i>
                                    </div>
                                    
                                    <div class="map-actions">
                                        <button type="button" class="map-btn" id="drawArea">
                                            <i class="fas fa-draw-polygon"></i>
                                            Draw Area
                                        </button>
                                        <button type="button" class="map-btn" id="clearArea">
                                            <i class="fas fa-trash"></i>
                                            Clear Area
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="areaMapDisplay" class="map-display">
                                    <div id="areaMapLoading" class="map-loading">
                                        <i class="fas fa-map-marked-alt"></i>
                                        <p>Loading Google Maps...</p>
                                    </div>
                                    <div id="areaMapError" class="map-error" style="display: none;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <p>Failed to load Google Maps. Please check your internet connection.</p>
                                    </div>
                                    <div id="areaMap" style="height: 100%; width: 100%; display: none;"></div>
                                </div>
                                
                                <div id="areaCoordinatesInfo" class="selected-location-info" style="display: none;">
                                    <div class="location-details">
                                        <div class="location-label">Area Coordinates</div>
                                        <div class="location-value" id="areaCoordinatesCount">0 points selected</div>
                                    </div>
                                    <div class="coordinates">
                                        <div class="coordinate-item">
                                            <div class="coordinate-label">Area Size</div>
                                            <div class="coordinate-value" id="areaSize">0 sq km</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button class="add-area-btn" id="addAreaBtn">
                            <i class="fas fa-plus"></i> Add Area Pricing
                        </button>
                    </div>
                    
                    <div class="area-list" id="areaList">
                        <!-- Area list will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Records Management Section -->
            <div class="dashboard-section" id="records-management">
                <h2 class="section-title">Records Management</h2>
                
                <div class="records-tabs">
                    <button class="records-tab active" data-tab="cargo-records">Cargo Records</button>
                    <button class="records-tab" data-tab="boat-records">Boat Records</button>
                    <button class="records-tab" data-tab="greater-male-records">Greater Male Records</button>
                    <button class="records-tab" data-tab="area-records">Area-Based Records</button>
                </div>
                
                <!-- Cargo Records -->
                <div class="records-content active" id="cargo-records">
                    <div class="data-container">
                        <h3 class="form-title"><i class="fas fa-list"></i> Cargo Delivery Records</h3>
                        <div id="cargoData">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Reference</th>
                                        <th>Customer</th>
                                        <th>Contact</th>
                                        <th>Pickup</th>
                                        <th>Delivery</th>
                                        <th>Weight</th>
                                        <th>Price</th>
                                        <th>Expected Delivery</th>
                                        <th>Countdown</th>
                                        <th>Status</th>
                                        <th>Payment</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="cargoTableBody">
                                    <!-- Cargo data will be populated here -->
                                </tbody>
                            </table>
                            <div class="empty-message" id="cargoEmptyMessage">No cargo delivery records found</div>
                        </div>
                    </div>
                </div>
                
                <!-- Boat Records -->
                <div class="records-content" id="boat-records">
                    <div class="data-container">
                        <h3 class="form-title"><i class="fas fa-list"></i> Boat Delivery Records</h3>
                        <div id="boatData">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Reference</th>
                                        <th>Customer</th>
                                        <th>Contact</th>
                                        <th>Boat Name</th>
                                        <th>Island</th>
                                        <th>Package</th>
                                        <th>Weight</th>
                                        <th>Price</th>
                                        <th>Expected Delivery</th>
                                        <th>Countdown</th>
                                        <th>Status</th>
                                        <th>Payment</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="boatTableBody">
                                    <!-- Boat data will be populated here -->
                                </tbody>
                            </table>
                            <div class="empty-message" id="boatEmptyMessage">No boat delivery records found</div>
                        </div>
                    </div>
                </div>
                
                <!-- Greater Male Records -->
                <div class="records-content" id="greater-male-records">
                    <div class="data-container">
                        <h3 class="form-title"><i class="fas fa-list"></i> Greater Male City Delivery Records</h3>
                        <div id="greaterMaleData">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Reference</th>
                                        <th>Customer</th>
                                        <th>Contact</th>
                                        <th>Pickup</th>
                                        <th>Item Size</th>
                                        <th>Quantity</th>
                                        <th>Vehicle</th>
                                        <th>Destination</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>Payment</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="greaterMaleTableBody">
                                    <!-- Greater Male data will be populated here -->
                                </tbody>
                            </table>
                            <div class="empty-message" id="greaterMaleEmptyMessage">No Greater Male City delivery records found</div>
                        </div>
                    </div>
                </div>
                
                <!-- Area-Based Records -->
                <div class="records-content" id="area-records">
                    <div class="data-container">
                        <h3 class="form-title"><i class="fas fa-list"></i> Area-Based Delivery Records</h3>
                        <div id="areaData">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Reference</th>
                                        <th>Customer</th>
                                        <th>Contact</th>
                                        <th>Area</th>
                                        <th>Coordinates</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>Payment</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="areaTableBody">
                                    <!-- Area-based data will be populated here -->
                                </tbody>
                            </table>
                            <div class="empty-message" id="areaEmptyMessage">No area-based delivery records found</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Track Delivery Section -->
            <div class="dashboard-section" id="track-delivery">
                <h2 class="section-title">Track Delivery & Customer Search</h2>
                
                <div class="search-container">
                    <h3 class="form-title"><i class="fas fa-search"></i> Search Customer by Contact Number</h3>
                    <div class="search-box">
                        <div class="form-field search-input">
                            <input type="tel" id="searchContact" placeholder="Enter customer contact number">
                        </div>
                        <button class="search-btn" id="searchBtn">Search</button>
                    </div>
                    
                    <!-- Customer References Results -->
                    <div class="customer-references" id="customerReferences">
                        <h3 class="form-title"><i class="fas fa-list"></i> All Delivery References for This Customer</h3>
                        <div class="reference-list" id="referenceList">
                            <!-- Customer references will be populated here -->
                        </div>
                    </div>
                    
                    <div class="customer-details" id="customerDetails">
                        <h3 class="form-title"><i class="fas fa-user"></i> Customer Details</h3>
                        <div class="customer-info" id="customerInfo">
                            <!-- Customer info will be populated here -->
                        </div>
                        
                        <div class="progress-container">
                            <h3 class="form-title"><i class="fas fa-truck-loading"></i> Delivery Progress</h3>
                            <div class="progress-tracker" id="progressTracker">
                                <div class="progress-step" data-step="1">
                                    <div class="progress-step-icon">
                                        <i class="fas fa-box"></i>
                                    </div>
                                    <div class="progress-step-label">Order Placed</div>
                                </div>
                                <div class="progress-step" data-step="2">
                                    <div class="progress-step-icon">
                                        <i class="fas fa-warehouse"></i>
                                    </div>
                                    <div class="progress-step-label">Processing</div>
                                </div>
                                <div class="progress-step" data-step="3">
                                    <div class="progress-step-icon">
                                        <i class="fas fa-shipping-fast"></i>
                                    </div>
                                    <div class="progress-step-label">In Transit</div>
                                </div>
                                <div class="progress-step" data-step="4">
                                    <div class="progress-step-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="progress-step-label">Out for Delivery</div>
                                </div>
                                <div class="progress-step" data-step="5">
                                    <div class="progress-step-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="progress-step-label">Delivered</div>
                                </div>
                                <div class="progress-bar" id="progressBar"></div>
                            </div>
                            
                            <div class="form-field" style="margin-top: 20px;">
                                <label>Delivery Proof Image</label>
                                <img id="deliveryPreview" class="delivery-image" alt="Delivery proof">
                                <div class="empty-message" id="noImageMessage">No delivery proof image available</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Revenue Dashboard Section -->
            <div class="dashboard-section" id="revenue-dashboard">
                <h2 class="section-title">Revenue Dashboard</h2>
                
                <div class="revenue-dashboard">
                    <h3 class="form-title"><i class="fas fa-chart-line"></i> Revenue Overview</h3>
                    
                    <!-- Date Filter -->
                    <div class="date-filter">
                        <div class="date-input-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="date-input-group">
                            <label for="endDate">End Date</label>
                            <input type="date" id="endDate">
                        </div>
                        <div class="date-filter-actions">
                            <button class="filter-btn" id="applyFilter">Apply Filter</button>
                            <button class="filter-btn reset" id="resetFilter">Reset</button>
                        </div>
                    </div>
                    
                    <div class="revenue-stats" id="revenueStats">
                        <!-- Revenue stats will be populated here -->
                    </div>
                    
                    <div class="revenue-chart">
                        <h3>Revenue Trend</h3>
                        <canvas id="revenueChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Price Management Section -->
            <div class="dashboard-section" id="price-management">
                <h2 class="section-title">Price Management</h2>
                
                <div class="price-tabs">
                    <button class="price-tab active" data-tab="cargo-prices">Cargo Prices</button>
                    <button class="price-tab" data-tab="boat-prices">Boat Prices</button>
                    <button class="price-tab" data-tab="greater-male-prices">Greater Male Prices</button>
                    <button class="price-tab" data-tab="area-prices">Area Prices</button>
                </div>
                
                <!-- Cargo Price Management -->
                <div class="price-content active" id="cargo-prices">
                    <div class="price-management">
                        <h3 class="form-title"><i class="fas fa-money-bill-wave"></i> Set Cargo Delivery Prices by Weight Range</h3>
                        
                        <div class="price-form">
                            <div class="price-input-group">
                                <div class="form-field price-input">
                                    <label for="cargoMinWeight">Minimum Weight (kg)</label>
                                    <input type="number" id="cargoMinWeight" placeholder="Min weight" min="0" step="0.1">
                                </div>
                                <div class="form-field price-input">
                                    <label for="cargoMaxWeight">Maximum Weight (kg)</label>
                                    <input type="number" id="cargoMaxWeight" placeholder="Max weight" min="0" step="0.1">
                                </div>
                                <div class="form-field price-input">
                                    <label for="cargoPriceValue">Price (MVR)</label>
                                    <input type="number" id="cargoPriceValue" placeholder="Price in MVR" min="0" step="0.01">
                                </div>
                            </div>
                            
                            <!-- Price range validation messages -->
                            <div class="price-range-validation" id="cargoPriceValidation">
                                <div class="validation-message" id="cargoValidationMessage"></div>
                            </div>
                            
                            <button class="add-price-btn" id="addCargoPriceBtn">
                                <i class="fas fa-plus"></i> Add Cargo Price
                            </button>
                        </div>
                        
                        <div class="price-list" id="cargoPriceList">
                            <!-- Cargo price list will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Boat Price Management -->
                <div class="price-content" id="boat-prices">
                    <div class="price-management">
                        <h3 class="form-title"><i class="fas fa-money-bill-wave"></i> Set Boat Delivery Prices by Weight Range</h3>
                        
                        <div class="price-form">
                            <div class="price-input-group">
                                <div class="form-field price-input">
                                    <label for="boatMinWeight">Minimum Weight (kg)</label>
                                    <input type="number" id="boatMinWeight" placeholder="Min weight" min="0" step="0.1">
                                </div>
                                <div class="form-field price-input">
                                    <label for="boatMaxWeight">Maximum Weight (kg)</label>
                                    <input type="number" id="boatMaxWeight" placeholder="Max weight" min="0" step="0.1">
                                </div>
                                <div class="form-field price-input">
                                    <label for="boatPriceValue">Price (MVR)</label>
                                    <input type="number" id="boatPriceValue" placeholder="Price in MVR" min="0" step="0.01">
                                </div>
                            </div>
                            
                            <!-- Price range validation messages -->
                            <div class="price-range-validation" id="boatPriceValidation">
                                <div class="validation-message" id="boatValidationMessage"></div>
                            </div>
                            
                            <button class="add-price-btn" id="addBoatPriceBtn">
                                <i class="fas fa-plus"></i> Add Boat Price
                            </button>
                        </div>
                        
                        <div class="price-list" id="boatPriceList">
                            <!-- Boat price list will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Greater Male Price Management -->
                <div class="price-content" id="greater-male-prices">
                    <div class="price-management">
                        <h3 class="form-title"><i class="fas fa-money-bill-wave"></i> Set Greater Male City Delivery Prices</h3>
                        
                        <div class="price-form">
                            <div class="price-input-group">
                                <div class="form-field price-input">
                                    <label for="itemType">Item Type</label>
                                    <select id="itemType">
                                        <!-- Item types will be populated from management -->
                                    </select>
                                </div>
                                <div class="form-field price-input">
                                    <label for="itemPrice">Price (MVR)</label>
                                    <input type="number" id="itemPrice" placeholder="Price in MVR" min="0" step="0.01">
                                </div>
                            </div>
                            
                            <button class="add-price-btn" id="addItemPriceBtn">
                                <i class="fas fa-plus"></i> Add Item Price
                            </button>
                        </div>
                        
                        <div class="price-list" id="itemPriceList">
                            <!-- Item price list will be populated here -->
                        </div>
                        
                        <div class="price-form" style="margin-top: 30px;">
                            <h3 class="form-title"><i class="fas fa-route"></i> Set Destination Prices</h3>
                            <div class="price-input-group">
                                <div class="form-field price-input">
                                    <label for="destinationType">Destination</label>
                                    <select id="destinationType">
                                        <!-- Destinations will be populated from management -->
                                    </select>
                                </div>
                                <div class="form-field price-input">
                                    <label for="destinationPrice">Price (MVR)</label>
                                    <input type="number" id="destinationPrice" placeholder="Price in MVR" min="0" step="0.01">
                                </div>
                            </div>
                            
                            <button class="add-price-btn" id="addDestinationPriceBtn">
                                <i class="fas fa-plus"></i> Add Destination Price
                            </button>
                        </div>
                        
                        <div class="price-list" id="destinationPriceList">
                            <!-- Destination price list will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Area Price Management -->
                <div class="price-content" id="area-prices">
                    <div class="price-management">
                        <h3 class="form-title"><i class="fas fa-money-bill-wave"></i> Set Area-Based Delivery Prices</h3>
                        
                        <div class="price-list" id="areaPriceList">
                            <!-- Area price list will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Management Section -->
            <div class="dashboard-section" id="user-management">
                <h2 class="section-title">User Management</h2>
                
                <div class="user-management">
                    <h3 class="form-title"><i class="fas fa-users"></i> Add New User</h3>
                    
                    <div class="user-form">
                        <div class="user-input-group">
                            <div class="form-field user-input">
                                <label for="newUsername">Username</label>
                                <input type="text" id="newUsername" placeholder="Enter username">
                            </div>
                            <div class="form-field user-input">
                                <label for="newUserEmail">Email</label>
                                <input type="email" id="newUserEmail" placeholder="Enter email">
                            </div>
                        </div>
                        
                        <div class="user-input-group">
                            <div class="form-field user-input">
                                <label for="newUserContact">Contact</label>
                                <input type="tel" id="newUserContact" placeholder="Enter contact number">
                            </div>
                            <div class="form-field user-input">
                                <label for="newUserPassword">Password</label>
                                <input type="password" id="newUserPassword" placeholder="Enter password">
                            </div>
                        </div>
                        
                        <div class="user-input-group">
                            <div class="form-field user-input">
                                <label for="newUserRole">Role</label>
                                <select id="newUserRole">
                                    <option value="staff">Staff</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="add-user-btn" id="addUserBtn">
                            <i class="fas fa-plus"></i> Add User
                        </button>
                    </div>
                    
                    <div class="user-list" id="userList">
                        <!-- User list will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Management Section -->
            <div class="dashboard-section" id="management">
                <h2 class="section-title">System Management</h2>
                
                <div class="management-panel">
                    <div class="management-header">
                        <div class="management-title">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Pickup Location Management</span>
                        </div>
                        <button class="add-management-btn" id="addPickupLocationBtn">
                            <i class="fas fa-plus"></i> Add Location
                        </button>
                    </div>
                    
                    <div class="management-list" id="pickupLocationList">
                        <!-- Pickup locations will be populated here -->
                    </div>
                </div>
                
                <div class="management-panel">
                    <div class="management-header">
                        <div class="management-title">
                            <i class="fas fa-route"></i>
                            <span>Destination Management</span>
                        </div>
                        <button class="add-management-btn" id="addDestinationBtn">
                            <i class="fas fa-plus"></i> Add Destination
                        </button>
                    </div>
                    
                    <div class="management-list" id="destinationList">
                        <!-- Destinations will be populated here -->
                    </div>
                </div>
                
                <div class="management-panel">
                    <div class="management-header">
                        <div class="management-title">
                            <i class="fas fa-box"></i>
                            <span>Item Size Management</span>
                        </div>
                        <button class="add-management-btn" id="addItemSizeBtn">
                            <i class="fas fa-plus"></i> Add Item Size
                        </button>
                    </div>
                    
                    <div class="management-list" id="itemSizeList">
                        <!-- Item sizes will be populated here -->
                    </div>
                </div>
                
                <div class="management-panel">
                    <div class="management-header">
                        <div class="management-title">
                            <i class="fas fa-truck"></i>
                            <span>Vehicle Management</span>
                        </div>
                        <button class="add-management-btn" id="addVehicleBtn">
                            <i class="fas fa-plus"></i> Add Vehicle
                        </button>
                    </div>
                    
                    <div class="management-list" id="vehicleList">
                        <!-- Vehicles will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div class="success-message" id="successMessage">
        <i class="fas fa-check-circle"></i>
        <h3 id="successTitle">Login Successful!</h3>
        <p id="successText">Welcome to CargoConnect Delivery Portal</p>
        <button class="continue-btn" id="continueBtn">Continue</button>
    </div>

    <!-- Status Update Modal -->
    <div class="modal-overlay" id="statusModal">
        <div class="modal">
            <h3 class="modal-title">Update Delivery Status</h3>
            <div class="form-field">
                <label for="statusSelect">Select Status</label>
                <select id="statusSelect">
                    <option value="Order Placed">Order Placed</option>
                    <option value="Processing">Processing</option>
                    <option value="In Transit">In Transit</option>
                    <option value="Out for Delivery">Out for Delivery</option>
                    <option value="Delivered">Delivered</option>
                </select>
            </div>
            <div class="form-field" id="proofUploadContainer" style="display: none;">
                <label>Upload Delivery Proof (Required for Completed Delivery)</label>
                <div class="file-upload">
                    <input type="file" id="proofImage" accept="image/*">
                    <label for="proofImage" class="file-upload-label">
                        <i class="fas fa-cloud-upload-alt"></i> Choose Proof Image
                    </label>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancelStatus">Cancel</button>
                <button class="modal-btn confirm" id="confirmStatus">Update Status</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal">
        <div class="payment-modal">
            <h3 class="modal-title">Payment Required</h3>
            <p style="text-align: center; margin-bottom: 20px;">Please make payment to complete your delivery order</p>
            
            <div class="bank-details">
                <h4 style="margin-bottom: 15px; color: #1a2a6c;">Bank Transfer Details</h4>
                <div class="bank-info">
                    <div class="bank-label">Bank Name</div>
                    <div class="bank-value">
                        <span>Bank of Maldives</span>
                    </div>
                </div>
                <div class="bank-info">
                    <div class="bank-label">Account Name</div>
                    <div class="bank-value">
                        <span>SYM CODERMV</span>
                    </div>
                </div>
                <div class="bank-info">
                    <div class="bank-label">Account Number</div>
                    <div class="bank-value">
                        <span id="accountNumber">7730000770230</span>
                        <button class="copy-btn" id="copyAccountBtn">Copy</button>
                    </div>
                </div>
                <div class="bank-info">
                    <div class="bank-label">Amount to Pay</div>
                    <div class="bank-value"><span id="paymentAmount">0</span> MVR</div>
                </div>
            </div>
            
            <div class="form-field">
                <label>Upload Payment Slip (Required)</label>
                <div class="file-upload">
                    <input type="file" id="paymentSlip" accept="image/*" required>
                    <label for="paymentSlip" class="file-upload-label">
                        <i class="fas fa-cloud-upload-alt"></i> Choose Payment Slip
                    </label>
                </div>
            </div>
            
            <div class="payment-actions">
                <button class="payment-btn cancel" id="cancelPayment">Cancel</button>
                <button class="payment-btn confirm" id="confirmPayment">Confirm Payment</button>
            </div>
        </div>
    </div>

    <!-- Bank Slip Modal -->
    <div class="modal-overlay" id="slipModal">
        <div class="slip-modal">
            <h3 class="modal-title">Payment Slip</h3>
            <img id="slipImage" class="slip-image" alt="Bank slip">
            <div class="modal-actions">
                <button class="modal-btn cancel" id="closeSlip">Close</button>
            </div>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div class="modal-overlay" id="userEditModal">
        <div class="modal">
            <h3 class="modal-title">Edit User</h3>
            <div class="form-field">
                <label for="editUsername">Username</label>
                <input type="text" id="editUsername" placeholder="Enter username">
            </div>
            <div class="form-field">
                <label for="editUserEmail">Email</label>
                <input type="email" id="editUserEmail" placeholder="Enter email">
            </div>
            <div class="form-field">
                <label for="editUserContact">Contact</label>
                <input type="tel" id="editUserContact" placeholder="Enter contact number">
            </div>
            <div class="form-field">
                <label for="editUserPassword">Password (leave blank to keep current)</label>
                <input type="password" id="editUserPassword" placeholder="Enter new password">
            </div>
            <div class="form-field">
                <label for="editUserRole">Role</label>
                <select id="editUserRole">
                    <option value="staff">Staff</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancelUserEdit">Cancel</button>
                <button class="modal-btn confirm" id="confirmUserEdit">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Management Item Modal -->
    <div class="modal-overlay" id="managementModal">
        <div class="modal">
            <h3 class="modal-title" id="managementModalTitle">Add Item</h3>
            <div class="form-field">
                <label for="managementName">Name</label>
                <input type="text" id="managementName" placeholder="Enter name">
            </div>
            <div class="form-field">
                <label for="managementDescription">Description</label>
                <textarea id="managementDescription" placeholder="Enter description" rows="3"></textarea>
            </div>
            <div class="form-field" id="managementPriceField" style="display: none;">
                <label for="managementPrice">Price (MVR)</label>
                <input type="number" id="managementPrice" placeholder="Enter price" min="0" step="0.01">
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancelManagement">Cancel</button>
                <button class="modal-btn confirm" id="confirmManagement">Save</button>
            </div>
        </div>
    </div>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_huqokZn3o6D1a5XenNO0FQmQuOKF8pw&libraries=places,drawing,geometry&callback=initApp" async defer></script>


<script> // Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyCZA8Z9AJcC97CyQUZVCRsljTuYBfxjHMw",
    authDomain: "easycargo-9c0cd.firebaseapp.com",
    databaseURL: "https://easycargo-9c0cd-default-rtdb.firebaseio.com",
    projectId: "easycargo-9c0cd",
    storageBucket: "easycargo-9c0cd.firebasestorage.app",
    messagingSenderId: "51689325187",
    appId: "1:51689325187:web:c65cb8fb0af2241a4c91b6",
    measurementId: "G-2LM4FD41LV"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Data storage
let cargoDeliveries = [];
let boatDeliveries = [];
let greaterMaleDeliveries = [];
let areaBasedDeliveries = [];
let currentDelivery = null;
let currentDeliveryType = null;
let currentDeliveryId = null;

// Separate price ranges for cargo and boat deliveries
let cargoPriceRanges = [
    { min: 0, max: 1, price: 50 },
    { min: 2, max: 3, price: 75 },
    { min: 4, max: 6, price: 100 },
    { min: 7, max: 10, price: 150 }
];

let boatPriceRanges = [
    { min: 0, max: 1, price: 40 },
    { min: 2, max: 3, price: 65 },
    { min: 4, max: 6, price: 90 },
    { min: 7, max: 10, price: 130 }
];

// Area-based pricing
let areaPricing = [];

// Greater Male City management data
let pickupLocations = [
    { id: 1, name: "Male", description: "Male City", type: "address" },
    { id: 2, name: "Hulhumale", description: "Hulhumale City", type: "address" },
    { id: 3, name: "Phase2", description: "Phase 2", type: "address" },
    { id: 4, name: "Post Office", description: "Main Post Office", type: "package" },
    { id: 5, name: "Pickpost", description: "Pickpost Location", type: "package" },
    { id: 6, name: "Redbox", description: "Redbox Location", type: "package" }
];

let destinations = [
    { id: 1, name: "Male to Hulhumale", description: "From Male to Hulhumale", price: 30, type: "address" },
    { id: 2, name: "Hulhumale to Male", description: "From Hulhumale to Male", price: 30, type: "address" },
    { id: 3, name: "Male to Phase2", description: "From Male to Phase 2", price: 25, type: "address" },
    { id: 4, name: "Hulhumale to Phase2", description: "From Hulhumale to Phase 2", price: 20, type: "address" },
    { id: 5, name: "Male to Boat", description: "From Male to Boat", price: 15, type: "boat" },
    { id: 6, name: "Hulhumale to Boat", description: "From Hulhumale to Boat", price: 15, type: "boat" }
];

let itemSizes = [
    { id: 1, name: "Small Package", description: "Small package up to 1kg", price: 25, icon: "fas fa-box", visual: "Small envelope or document" },
    { id: 2, name: "Large Package", description: "Large package up to 3kg", price: 40, icon: "fas fa-box-open", visual: "Medium box or bag" },
    { id: 3, name: "Small Box", description: "Small box up to 5kg", price: 30, icon: "fas fa-cube", visual: "Small moving box" },
    { id: 4, name: "Large Box", description: "Large box up to 10kg", price: 50, icon: "fas fa-cubes", visual: "Large moving box" }
];

let vehicles = [
    { id: 1, name: "Motorcycle", description: "Motorcycle delivery", price: 0 },
    { id: 2, name: "Pickup", description: "Pickup truck delivery", price: 20 }
];

// Greater Male City pricing
let greaterMaleItemPrices = {};
let greaterMaleDestinationPrices = {};
let greaterMaleVehiclePrices = {};

// User management
let users = [
    { id: 1, username: "Admin", email: "Cargoconnect@gmail.com", contact: "123456789", password: "8555", role: "admin" }
];
let currentUser = null;
let editingUserId = null;

// Notifications
let notifications = [];
let lastLoginTime = null;

// Management
let currentManagementType = null;
let editingManagementId = null;

// Google Maps variables
let map = null;
let areaMap = null;
let drawingManager = null;
let selectedPolygon = null;
let selectedAreaCoordinates = [];
let markers = [];
let pickupMarker = null;
let destinationMarker = null;
let geocoder = null;
let placesService = null;
let autocomplete = null;
let currentMapMode = 'pickup'; // 'pickup' or 'destination'
let selectedPickupLocation = null;
let selectedDestinationLocation = null;

// DOM elements
const loginContainer = document.getElementById('loginContainer');
const dashboardContainer = document.getElementById('dashboardContainer');
const loginForm = document.getElementById('loginForm');
const createAccountForm = document.getElementById('createAccountForm');
const loginFormSection = document.getElementById('loginFormSection');
const createAccountSection = document.getElementById('createAccountSection');
const showCreateAccount = document.getElementById('showCreateAccount');
const showLoginForm = document.getElementById('showLoginForm');
const cargoForm = document.getElementById('cargoForm');
const boatForm = document.getElementById('boatForm');
const greaterMaleForm = document.getElementById('greaterMaleForm');
const successMessage = document.getElementById('successMessage');
const successTitle = document.getElementById('successTitle');
const successText = document.getElementById('successText');
const continueBtn = document.getElementById('continueBtn');
const sidebar = document.getElementById('sidebar');
const sidebarNav = document.getElementById('sidebarNav');
const closeSidebar = document.getElementById('closeSidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');
const menuToggle = document.getElementById('menuToggle');
const userName = document.getElementById('userName');
const userRole = document.getElementById('userRole');
const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');
const dashboardSections = document.querySelectorAll('.dashboard-section');
const cargoTableBody = document.getElementById('cargoTableBody');
const boatTableBody = document.getElementById('boatTableBody');
const greaterMaleTableBody = document.getElementById('greaterMaleTableBody');
const areaTableBody = document.getElementById('areaTableBody');
const cargoEmptyMessage = document.getElementById('cargoEmptyMessage');
const boatEmptyMessage = document.getElementById('boatEmptyMessage');
const greaterMaleEmptyMessage = document.getElementById('greaterMaleEmptyMessage');
const areaEmptyMessage = document.getElementById('areaEmptyMessage');
const searchBtn = document.getElementById('searchBtn');
const customerDetails = document.getElementById('customerDetails');
const customerInfo = document.getElementById('customerInfo');
const progressSteps = document.querySelectorAll('.progress-step');
const progressBar = document.getElementById('progressBar');
const deliveryPreview = document.getElementById('deliveryPreview');
const noImageMessage = document.getElementById('noImageMessage');
const statusModal = document.getElementById('statusModal');
const statusSelect = document.getElementById('statusSelect');
const proofUploadContainer = document.getElementById('proofUploadContainer');
const proofImage = document.getElementById('proofImage');
const cancelStatus = document.getElementById('cancelStatus');
const confirmStatus = document.getElementById('confirmStatus');
const paymentModal = document.getElementById('paymentModal');
const paymentAmount = document.getElementById('paymentAmount');
const paymentSlip = document.getElementById('paymentSlip');
const cancelPayment = document.getElementById('cancelPayment');
const confirmPayment = document.getElementById('confirmPayment');
const weightOptions = document.getElementById('weightOptions');
const boatWeightOptions = document.getElementById('boatWeightOptions');
const deliveryPrice = document.getElementById('deliveryPrice');
const boatDeliveryPrice = document.getElementById('boatDeliveryPrice');
const addCargoPriceBtn = document.getElementById('addCargoPriceBtn');
const addBoatPriceBtn = document.getElementById('addBoatPriceBtn');
const cargoPriceList = document.getElementById('cargoPriceList');
const boatPriceList = document.getElementById('boatPriceList');
const copyAccountBtn = document.getElementById('copyAccountBtn');
const accountNumber = document.getElementById('accountNumber');
const slipModal = document.getElementById('slipModal');
const slipImage = document.getElementById('slipImage');
const closeSlip = document.getElementById('closeSlip');
const addUserBtn = document.getElementById('addUserBtn');
const userList = document.getElementById('userList');
const recordsTabs = document.querySelectorAll('.records-tab');
const recordsContents = document.querySelectorAll('.records-content');
const priceTabs = document.querySelectorAll('.price-tab');
const priceContents = document.querySelectorAll('.price-content');
const notificationsPanel = document.getElementById('notificationsPanel');
const notificationsToggle = document.getElementById('notificationsToggle');
const closeNotifications = document.getElementById('closeNotifications');
const notificationsContent = document.getElementById('notificationsContent');
const revenueStats = document.getElementById('revenueStats');
const userCargoReferences = document.getElementById('userCargoReferences');
const userBoatReferences = document.getElementById('userBoatReferences');
const userGreaterMaleReferences = document.getElementById('userGreaterMaleReferences');
const notificationSound = document.getElementById('notificationSound');
const pickupLocation = document.getElementById('pickupLocation');
const packageDetailsField = document.getElementById('packageDetailsField');
const addressField = document.getElementById('addressField');
const deliveryLocation = document.getElementById('deliveryLocation');
const userEditModal = document.getElementById('userEditModal');
const editUsername = document.getElementById('editUsername');
const editUserEmail = document.getElementById('editUserEmail');
const editUserContact = document.getElementById('editUserContact');
const editUserPassword = document.getElementById('editUserPassword');
const editUserRole = document.getElementById('editUserRole');
const cancelUserEdit = document.getElementById('cancelUserEdit');
const confirmUserEdit = document.getElementById('confirmUserEdit');
const newUserRole = document.getElementById('newUserRole');
const cargoMinWeight = document.getElementById('cargoMinWeight');
const cargoMaxWeight = document.getElementById('cargoMaxWeight');
const cargoPriceValue = document.getElementById('cargoPriceValue');
const boatMinWeight = document.getElementById('boatMinWeight');
const boatMaxWeight = document.getElementById('boatMaxWeight');
const boatPriceValue = document.getElementById('boatPriceValue');
const cargoValidationMessage = document.getElementById('cargoValidationMessage');
const boatValidationMessage = document.getElementById('boatValidationMessage');
const referencesPanel = document.getElementById('referencesPanel');
const referencesToggle = document.getElementById('referencesToggle');
const closeReferences = document.getElementById('closeReferences');
const referencesContent = document.getElementById('referencesContent');
const startDate = document.getElementById('startDate');
const endDate = document.getElementById('endDate');
const applyFilter = document.getElementById('applyFilter');
const resetFilter = document.getElementById('resetFilter');
const revenueChart = document.getElementById('revenueChart');

// Greater Male City elements
const itemSizeOptions = document.getElementById('itemSizeOptions');
const vehicleOptions = document.getElementById('vehicleOptions');
const destinationOptions = document.getElementById('destinationOptions');
const decreaseQuantity = document.getElementById('decreaseQuantity');
const increaseQuantity = document.getElementById('increaseQuantity');
const itemQuantity = document.getElementById('itemQuantity');
const itemPriceValue = document.getElementById('itemPriceValue');
const vehiclePriceValue = document.getElementById('vehiclePriceValue');
const destinationPriceValue = document.getElementById('destinationPriceValue');
const greaterMaleTotalPrice = document.getElementById('greaterMaleTotalPrice');
const addItemPriceBtn = document.getElementById('addItemPriceBtn');
const addDestinationPriceBtn = document.getElementById('addDestinationPriceBtn');
const itemPriceList = document.getElementById('itemPriceList');
const destinationPriceList = document.getElementById('destinationPriceList');
const greaterMalePickupLocation = document.getElementById('greaterMalePickupLocation');
const greaterMaleAddressField = document.getElementById('greaterMaleAddressField');
const greaterMalePackageDetailsField = document.getElementById('greaterMalePackageDetailsField');
const boatNameField = document.getElementById('boatNameField');
const destinationAddressField = document.getElementById('destinationAddressField');
const boatNameInput = document.getElementById('boatNameInput');
const destinationAddressName = document.getElementById('destinationAddressName');
const greaterMaleAddressName = document.getElementById('greaterMaleAddressName');
const greaterMalePackageDetails = document.getElementById('greaterMalePackageDetails');

// Management elements
const addPickupLocationBtn = document.getElementById('addPickupLocationBtn');
const addDestinationBtn = document.getElementById('addDestinationBtn');
const addItemSizeBtn = document.getElementById('addItemSizeBtn');
const addVehicleBtn = document.getElementById('addVehicleBtn');
const pickupLocationList = document.getElementById('pickupLocationList');
const destinationList = document.getElementById('destinationList');
const itemSizeList = document.getElementById('itemSizeList');
const vehicleList = document.getElementById('vehicleList');
const managementModal = document.getElementById('managementModal');
const managementModalTitle = document.getElementById('managementModalTitle');
const managementName = document.getElementById('managementName');
const managementDescription = document.getElementById('managementDescription');
const managementPriceField = document.getElementById('managementPriceField');
const managementPrice = document.getElementById('managementPrice');
const cancelManagement = document.getElementById('cancelManagement');
const confirmManagement = document.getElementById('confirmManagement');
const itemType = document.getElementById('itemType');
const destinationType = document.getElementById('destinationType');

// NEW ELEMENTS FOR IMPROVED TRACKING
const customerReferences = document.getElementById('customerReferences');
const referenceList = document.getElementById('referenceList');

// Google Maps elements
const enableMap = document.getElementById('enableMap');
const mapContent = document.getElementById('mapContent');
const mapDisplay = document.getElementById('mapDisplay');
const mapLoading = document.getElementById('mapLoading');
const mapError = document.getElementById('mapError');
const mapSearchInput = document.getElementById('mapSearchInput');
const useCurrentLocation = document.getElementById('useCurrentLocation');
const searchLocation = document.getElementById('searchLocation');
const clearMap = document.getElementById('clearMap');
const selectedLocationInfo = document.getElementById('selectedLocationInfo');
const selectedLocationName = document.getElementById('selectedLocationName');
const selectedLatitude = document.getElementById('selectedLatitude');
const selectedLongitude = document.getElementById('selectedLongitude');
const confirmLocation = document.getElementById('confirmLocation');
const manualLocationSection = document.getElementById('manualLocationSection');
const pickupModeBtn = document.getElementById('pickupModeBtn');
const destinationModeBtn = document.getElementById('destinationModeBtn');
const pickupLocationDetails = document.getElementById('pickupLocationDetails');
const destinationLocationDetails = document.getElementById('destinationLocationDetails');
const mapPricingInfo = document.getElementById('mapPricingInfo');
const mapItemPrice = document.getElementById('mapItemPrice');
const mapVehiclePrice = document.getElementById('mapVehiclePrice');
const mapDestinationPrice = document.getElementById('mapDestinationPrice');
const mapTotalPrice = document.getElementById('mapTotalPrice');

// Area-based pricing elements
const areaName = document.getElementById('areaName');
const areaPrice = document.getElementById('areaPrice');
const areaSearchInput = document.getElementById('areaSearchInput');
const drawArea = document.getElementById('drawArea');
const clearArea = document.getElementById('clearArea');
const areaMapDisplay = document.getElementById('areaMapDisplay');
const areaMapLoading = document.getElementById('areaMapLoading');
const areaMapError = document.getElementById('areaMapError');
const areaCoordinatesInfo = document.getElementById('areaCoordinatesInfo');
const areaCoordinatesCount = document.getElementById('areaCoordinatesCount');
const areaSize = document.getElementById('areaSize');
const addAreaBtn = document.getElementById('addAreaBtn');
const areaList = document.getElementById('areaList');
const areaPriceList = document.getElementById('areaPriceList');

// Firebase Database References
const cargoRef = database.ref('cargoDeliveries');
const boatRef = database.ref('boatDeliveries');
const greaterMaleRef = database.ref('greaterMaleDeliveries');
const areaBasedRef = database.ref('areaBasedDeliveries');
const cargoPriceRangesRef = database.ref('cargoPriceRanges');
const boatPriceRangesRef = database.ref('boatPriceRanges');
const areaPricingRef = database.ref('areaPricing');
const pickupLocationsRef = database.ref('pickupLocations');
const destinationsRef = database.ref('destinations');
const itemSizesRef = database.ref('itemSizes');
const vehiclesRef = database.ref('vehicles');
const greaterMaleItemPricesRef = database.ref('greaterMaleItemPrices');
const greaterMaleDestinationPricesRef = database.ref('greaterMaleDestinationPrices');
const greaterMaleVehiclePricesRef = database.ref('greaterMaleVehiclePrices');
const usersRef = database.ref('users');
const notificationsRef = database.ref('notifications');

// Initialize the application
function initApp() {
    // Check if Google Maps is loaded
    if (typeof google === 'undefined') {
        console.error('Google Maps failed to load');
        if (mapError) mapError.style.display = 'flex';
        if (mapLoading) mapLoading.style.display = 'none';
        if (areaMapError) areaMapError.style.display = 'flex';
        if (areaMapLoading) areaMapLoading.style.display = 'none';
        return;
    }
    
    // Initialize Google Maps
    initMap();
    initAreaMap();
    
    // Check if user is already logged in
    checkLoginStatus();
    
    // Load any stored data
    loadStoredData();
}

// Initialize main Google Map
function initMap() {
    // Default center (Male, Maldives)
    const defaultCenter = { lat: 4.1755, lng: 73.5093 };
    
    // Create the map
    const mapElement = document.getElementById('map');
    if (!mapElement) {
        console.error('Map element not found');
        return;
    }
    
    map = new google.maps.Map(mapElement, {
        center: defaultCenter,
        zoom: 14,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        styles: [
            {
                "featureType": "administrative",
                "elementType": "labels.text.fill",
                "stylers": [{"color": "#444444"}]
            },
            {
                "featureType": "landscape",
                "elementType": "all",
                "stylers": [{"color": "#f2f2f2"}]
            },
            {
                "featureType": "poi",
                "elementType": "all",
                "stylers": [{"visibility": "off"}]
            },
            {
                "featureType": "road",
                "elementType": "all",
                "stylers": [{"saturation": -100}, {"lightness": 45}]
            },
            {
                "featureType": "road.highway",
                "elementType": "all",
                "stylers": [{"visibility": "simplified"}]
            },
            {
                "featureType": "road.arterial",
                "elementType": "labels.icon",
                "stylers": [{"visibility": "off"}]
            },
            {
                "featureType": "transit",
                "elementType": "all",
                "stylers": [{"visibility": "off"}]
            },
            {
                "featureType": "water",
                "elementType": "all",
                "stylers": [{"color": "#4cc9f0"}, {"visibility": "on"}]
            }
        ]
    });
    
    // Initialize geocoder
    geocoder = new google.maps.Geocoder();
    
    // Initialize places service
    placesService = new google.maps.places.PlacesService(map);
    
    // Initialize autocomplete for search
    if (mapSearchInput) {
        autocomplete = new google.maps.places.Autocomplete(mapSearchInput);
        autocomplete.bindTo('bounds', map);
    }
    
    // Add click listener to map
    map.addListener('click', function(event) {
        placeMarker(event.latLng, currentMapMode);
    });
    
    // Show the map
    mapElement.style.display = 'block';
    if (mapLoading) mapLoading.style.display = 'none';
}

// Initialize area map for drawing polygons
function initAreaMap() {
    // Default center (Male, Maldives)
    const defaultCenter = { lat: 4.1755, lng: 73.5093 };
    
    // Create the map
    const areaMapElement = document.getElementById('areaMap');
    if (!areaMapElement) {
        console.error('Area map element not found');
        return;
    }
    
    areaMap = new google.maps.Map(areaMapElement, {
        center: defaultCenter,
        zoom: 12,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        styles: [
            {
                "featureType": "administrative",
                "elementType": "labels.text.fill",
                "stylers": [{"color": "#444444"}]
            },
            {
                "featureType": "landscape",
                "elementType": "all",
                "stylers": [{"color": "#f2f2f2"}]
            },
            {
                "featureType": "poi",
                "elementType": "all",
                "stylers": [{"visibility": "off"}]
            },
            {
                "featureType": "road",
                "elementType": "all",
                "stylers": [{"saturation": -100}, {"lightness": 45}]
            },
            {
                "featureType": "road.highway",
                "elementType": "all",
                "stylers": [{"visibility": "simplified"}]
            },
            {
                "featureType": "road.arterial",
                "elementType": "labels.icon",
                "stylers": [{"visibility": "off"}]
            },
            {
                "featureType": "transit",
                "elementType": "all",
                "stylers": [{"visibility": "off"}]
            },
            {
                "featureType": "water",
                "elementType": "all",
                "stylers": [{"color": "#4cc9f0"}, {"visibility": "on"}]
            }
        ]
    });
    
    // Initialize drawing manager
    drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: null,
        drawingControl: true,
        drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_CENTER,
            drawingModes: ['polygon']
        },
        polygonOptions: {
            fillColor: '#4cc9f0',
            fillOpacity: 0.3,
            strokeWeight: 2,
            strokeColor: '#1a2a6c',
            clickable: true,
            editable: true,
            zIndex: 1
        }
    });
    
    drawingManager.setMap(areaMap);
    
    // Add listener for polygon completion
    google.maps.event.addListener(drawingManager, 'polygoncomplete', function(polygon) {
        // Clear any existing polygon
        if (selectedPolygon) {
            selectedPolygon.setMap(null);
        }
        
        selectedPolygon = polygon;
        selectedAreaCoordinates = polygon.getPath().getArray();
        
        // Update area coordinates info
        updateAreaCoordinatesInfo();
        
        // Add listener for polygon edits
        polygon.getPath().addListener('set_at', updateAreaCoordinatesInfo);
        polygon.getPath().addListener('insert_at', updateAreaCoordinatesInfo);
        polygon.getPath().addListener('remove_at', updateAreaCoordinatesInfo);
    });
    
    // Initialize autocomplete for area search
    if (areaSearchInput) {
        const areaAutocomplete = new google.maps.places.Autocomplete(areaSearchInput);
        areaAutocomplete.bindTo('bounds', areaMap);
        areaAutocomplete.addListener('place_changed', function() {
            const place = areaAutocomplete.getPlace();
            if (!place.geometry) {
                return;
            }
            
            if (place.geometry.viewport) {
                areaMap.fitBounds(place.geometry.viewport);
            } else {
                areaMap.setCenter(place.geometry.location);
                areaMap.setZoom(15);
            }
        });
    }
    
    // Show the map
    areaMapElement.style.display = 'block';
    if (areaMapLoading) areaMapLoading.style.display = 'none';
}

// Update area coordinates information
function updateAreaCoordinatesInfo() {
    if (selectedPolygon) {
        const coordinates = selectedPolygon.getPath().getArray();
        selectedAreaCoordinates = coordinates;
        
        // Update display
        if (areaCoordinatesCount) {
            areaCoordinatesCount.textContent = `${coordinates.length} points selected`;
        }
        
        // Calculate area size
        const area = google.maps.geometry.spherical.computeArea(coordinates);
        const areaSqKm = (area / 1000000).toFixed(2);
        if (areaSize) {
            areaSize.textContent = `${areaSqKm} sq km`;
        }
        
        // Show coordinates info
        if (areaCoordinatesInfo) {
            areaCoordinatesInfo.style.display = 'block';
        }
    }
}

// Place a marker on the map
function placeMarker(location, type) {
    // Remove existing marker of the same type
    if (type === 'pickup' && pickupMarker) {
        pickupMarker.setMap(null);
    } else if (type === 'destination' && destinationMarker) {
        destinationMarker.setMap(null);
    }
    
    // Create new marker
    const marker = new google.maps.Marker({
        position: location,
        map: map,
        draggable: true,
        icon: {
            url: type === 'pickup' ? 
                 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="14" fill="#4caf50" stroke="white" stroke-width="2"/><text x="16" y="21" text-anchor="middle" fill="white" font-size="14">P</text></svg>`) :
                 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="14" fill="#ff5722" stroke="white" stroke-width="2"/><text x="16" y="21" text-anchor="middle" fill="white" font-size="14">D</text></svg>`),
            scaledSize: new google.maps.Size(32, 32)
        }
    });
    
    // Store reference to marker
    if (type === 'pickup') {
        pickupMarker = marker;
        selectedPickupLocation = location;
    } else {
        destinationMarker = marker;
        selectedDestinationLocation = location;
    }
    
    // Add to markers array
    markers.push(marker);
    
    // Get address for location
    geocoder.geocode({ location: location }, function(results, status) {
        if (status === 'OK' && results[0]) {
            const address = results[0].formatted_address;
            
            // Update selected location info
            if (selectedLocationName) selectedLocationName.textContent = address;
            if (selectedLatitude) selectedLatitude.textContent = location.lat().toFixed(6);
            if (selectedLongitude) selectedLongitude.textContent = location.lng().toFixed(6);
            
            // Update location details based on type
            if (type === 'pickup') {
                if (pickupLocationDetails) pickupLocationDetails.textContent = address;
                if (greaterMaleAddressName) greaterMaleAddressName.value = address;
            } else {
                if (destinationLocationDetails) destinationLocationDetails.textContent = address;
                if (destinationAddressName) destinationAddressName.value = address;
            }
            
            // Show location info
            if (selectedLocationInfo) selectedLocationInfo.style.display = 'block';
            
            // Calculate pricing based on area
            if (type === 'destination' && selectedPickupLocation && selectedDestinationLocation) {
                calculateMapBasedPricing();
            }
        }
    });
    
    // Add dragend listener
    marker.addListener('dragend', function() {
        const newLocation = marker.getPosition();
        
        // Update selected location info
        if (selectedLatitude) selectedLatitude.textContent = newLocation.lat().toFixed(6);
        if (selectedLongitude) selectedLongitude.textContent = newLocation.lng().toFixed(6);
        
        // Get new address
        geocoder.geocode({ location: newLocation }, function(results, status) {
            if (status === 'OK' && results[0]) {
                if (selectedLocationName) selectedLocationName.textContent = results[0].formatted_address;
                
                // Update location details based on type
                if (type === 'pickup') {
                    if (pickupLocationDetails) pickupLocationDetails.textContent = results[0].formatted_address;
                    if (greaterMaleAddressName) greaterMaleAddressName.value = results[0].formatted_address;
                    selectedPickupLocation = newLocation;
                } else {
                    if (destinationLocationDetails) destinationLocationDetails.textContent = results[0].formatted_address;
                    if (destinationAddressName) destinationAddressName.value = results[0].formatted_address;
                    selectedDestinationLocation = newLocation;
                }
                
                // Calculate pricing based on area
                if (selectedPickupLocation && selectedDestinationLocation) {
                    calculateMapBasedPricing();
                }
            }
        });
    });
}

// Calculate pricing based on map locations and area pricing
function calculateMapBasedPricing() {
    if (!selectedPickupLocation || !selectedDestinationLocation) return;
    
    // Get selected item size and vehicle
    const selectedItemSize = document.querySelector('.item-size-btn.active');
    const selectedVehicle = document.querySelector('.vehicle-btn.active');
    
    if (!selectedItemSize || !selectedVehicle) return;
    
    // Calculate distance between pickup and destination
    const distance = google.maps.geometry.spherical.computeDistanceBetween(
        selectedPickupLocation, 
        selectedDestinationLocation
    );
    
    // Convert distance to kilometers
    const distanceKm = distance / 1000;
    
    // Calculate base price based on distance
    let basePrice = 0;
    
    // Apply area-based pricing if available
    let areaPrice = 0;
    let areaName = '';
    
    for (const area of areaPricing) {
        if (isLocationInArea(selectedDestinationLocation, area.coordinates)) {
            areaPrice = area.price;
            areaName = area.name;
            break;
        }
    }
    
    // If no specific area pricing found, use distance-based pricing
    if (areaPrice === 0) {
        // Simple distance-based pricing model
        if (distanceKm <= 5) {
            basePrice = 30;
        } else if (distanceKm <= 10) {
            basePrice = 50;
        } else if (distanceKm <= 20) {
            basePrice = 80;
        } else {
            basePrice = 100 + Math.floor((distanceKm - 20) / 5) * 10;
        }
    } else {
        basePrice = areaPrice;
    }
    
    // Get item price
    const itemPrice = parseFloat(selectedItemSize.getAttribute('data-price'));
    
    // Get vehicle price
    const vehiclePrice = parseFloat(selectedVehicle.getAttribute('data-price'));
    
    // Get quantity
    const quantity = parseInt(itemQuantity.value);
    
    // Calculate total price
    const totalPrice = (itemPrice * quantity) + vehiclePrice + basePrice;
    
    // Update map pricing display
    if (mapItemPrice) mapItemPrice.textContent = `${itemPrice * quantity} MVR`;
    if (mapVehiclePrice) mapVehiclePrice.textContent = `${vehiclePrice} MVR`;
    if (mapDestinationPrice) mapDestinationPrice.textContent = `${basePrice} MVR`;
    if (mapTotalPrice) mapTotalPrice.textContent = `${totalPrice} MVR`;
    
    // Show pricing info
    if (mapPricingInfo) mapPricingInfo.style.display = 'block';
    
    // Update form fields
    if (itemPriceValue) itemPriceValue.textContent = `${itemPrice * quantity} MVR`;
    if (vehiclePriceValue) vehiclePriceValue.textContent = `${vehiclePrice} MVR`;
    if (destinationPriceValue) destinationPriceValue.textContent = `${basePrice} MVR`;
    if (greaterMaleTotalPrice) greaterMaleTotalPrice.textContent = `${totalPrice} MVR`;
}

// Check if a location is inside a polygon area
function isLocationInArea(location, polygonCoordinates) {
    if (!polygonCoordinates || polygonCoordinates.length < 3) return false;
    
    const point = new google.maps.LatLng(location.lat(), location.lng());
    const polygon = new google.maps.Polygon({
        paths: polygonCoordinates.map(coord => new google.maps.LatLng(coord.lat, coord.lng))
    });
    
    return google.maps.geometry.poly.containsLocation(point, polygon);
}

// Check if user is already logged in
function checkLoginStatus() {
    const loggedInUser = localStorage.getItem('loggedInUser');
    if (loggedInUser) {
        const user = JSON.parse(loggedInUser);
        currentUser = user;
        if (loginContainer) loginContainer.style.display = 'none';
        if (dashboardContainer) dashboardContainer.style.display = 'block';
        setupDashboard();
        loadStoredData();
        
        // Set last login time for notification tracking
        lastLoginTime = new Date().toISOString();
        localStorage.setItem(`lastLogin_${currentUser.email}`, lastLoginTime);
        
        // Check for new notifications
        checkNewNotifications();
        
        // Auto-fill user information in forms
        autoFillUserInfo();
        
        // Load revenue data for admin
        if (currentUser.role === 'admin') {
            loadRevenueData();
        }
        
        // Load user's reference numbers
        loadUserReferences();
    }
}

// Toggle between login and create account forms
if (showCreateAccount) {
    showCreateAccount.addEventListener('click', function() {
        if (loginFormSection) loginFormSection.style.display = 'none';
        if (createAccountSection) createAccountSection.classList.add('active');
    });
}

if (showLoginForm) {
    showLoginForm.addEventListener('click', function() {
        if (createAccountSection) createAccountSection.classList.remove('active');
        if (loginFormSection) loginFormSection.style.display = 'block';
    });
}

// Create account functionality
if (createAccountForm) {
    createAccountForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('createUsername').value;
        const email = document.getElementById('createEmail').value;
        const contact = document.getElementById('createContact').value;
        const password = document.getElementById('createPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (password !== confirmPassword) {
            showNotification('Passwords do not match');
            return;
        }
        
        // Check if user already exists
        if (users.find(user => user.email === email)) {
            showNotification('User with this email already exists');
            return;
        }
        
        // Add new user with staff role (not admin)
        const newUser = {
            id: Date.now(),
            username: username,
            email: email,
            contact: contact,
            password: password,
            role: 'staff'
        };
        
        users.push(newUser);
        saveUsers();
        
        // Show success message
        if (successTitle) successTitle.textContent = 'Account Created!';
        if (successText) successText.textContent = 'Your account has been created successfully';
        if (successMessage) successMessage.classList.add('show');
        
        // Reset form
        createAccountForm.reset();
        
        // Switch back to login form
        setTimeout(() => {
            if (successMessage) successMessage.classList.remove('show');
            if (createAccountSection) createAccountSection.classList.remove('active');
            if (loginFormSection) loginFormSection.style.display = 'block';
        }, 2000);
    });
}

// Login functionality
if (loginForm) {
    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const loginUsername = document.getElementById('loginUsername').value;
        const password = document.getElementById('password').value;
        
        // Find user by username or email
        const user = users.find(u => 
            (u.username === loginUsername || u.email === loginUsername) && 
            u.password === password
        );
        
        if (!user) {
            showNotification('Invalid username/email or password');
            return;
        }
        
        // Set current user
        currentUser = user;
        
        // Save login status to localStorage
        localStorage.setItem('loggedInUser', JSON.stringify(user));
        
        const loginBtn = document.getElementById('loginBtn');
        const truck = document.getElementById('truck');
        const truckContainer = document.getElementById('truckContainer');
        const packages = document.querySelectorAll('.package');
        
        // Reset any previous animation
        if (truck) {
            truck.style.animation = 'none';
            void truck.offsetWidth; // Trigger reflow
            
            // Show truck
            if (truckContainer) truckContainer.style.opacity = '1';
            
            // Add driving animation to truck
            truck.style.animation = 'smoothDrive 2s linear forwards';
        }
        
        // Animate packages
        if (packages) {
            packages.forEach(package => {
                package.classList.add('package-animate');
            });
        }
        
        // Change button text and disable
        if (loginBtn) {
            loginBtn.innerHTML = '<span>Loading...</span>';
            loginBtn.disabled = true;
        }
        
        // Simulate login process
        setTimeout(() => {
            // Show success message
            if (successTitle) successTitle.textContent = 'Login Successful!';
            if (successText) successText.textContent = `Welcome ${user.username} to CargoConnect Delivery Portal`;
            if (successMessage) successMessage.classList.add('show');
            
            // Reset form and button
            if (loginBtn) {
                loginBtn.innerHTML = '<span>Sign In</span><i class="fas fa-truck-loading"></i>';
                loginBtn.disabled = false;
            }
            
            // Hide truck
            if (truckContainer) truckContainer.style.opacity = '0';
            
            // Reset packages
            if (packages) {
                packages.forEach(package => {
                    package.classList.remove('package-animate');
                });
            }
        }, 2000);
    });
}

// Continue to dashboard
if (continueBtn) {
    continueBtn.addEventListener('click', function() {
        if (successMessage) successMessage.classList.remove('show');
        if (loginContainer) loginContainer.style.display = 'none';
        if (dashboardContainer) dashboardContainer.style.display = 'block';
        
        // Set last login time for notification tracking
        lastLoginTime = new Date().toISOString();
        localStorage.setItem(`lastLogin_${currentUser.email}`, lastLoginTime);
        
        // Setup dashboard based on user role
        setupDashboard();
        
        // Load any existing data
        loadWeightOptions();
        loadPriceLists();
        loadUsers();
        loadNotifications();
        loadManagementData();
        loadAreaPricing();
        
        // Check for new notifications
        checkNewNotifications();
        
        // Auto-fill user information in forms
        autoFillUserInfo();
        
        // Load revenue data for admin
        if (currentUser.role === 'admin') {
            loadRevenueData();
        }
        
        // Load user's reference numbers
        loadUserReferences();
    });
}

// Auto-fill user information in forms
function autoFillUserInfo() {
    if (currentUser) {
        // Fill cargo delivery form
        const customerName = document.getElementById('customerName');
        const customerContact = document.getElementById('customerContact');
        if (customerName) customerName.value = currentUser.username;
        if (customerContact) customerContact.value = currentUser.contact;
        
        // Fill boat delivery form
        const boatCustomerName = document.getElementById('boatCustomerName');
        const boatCustomerContact = document.getElementById('boatCustomerContact');
        if (boatCustomerName) boatCustomerName.value = currentUser.username;
        if (boatCustomerContact) boatCustomerContact.value = currentUser.contact;
        
        // Fill Greater Male City delivery form
        const greaterMaleCustomerName = document.getElementById('greaterMaleCustomerName');
        const greaterMaleCustomerContact = document.getElementById('greaterMaleCustomerContact');
        if (greaterMaleCustomerName) greaterMaleCustomerName.value = currentUser.username;
        if (greaterMaleCustomerContact) greaterMaleCustomerContact.value = currentUser.contact;
    }
}

// Setup dashboard based on user role
function setupDashboard() {
    // Update user info in header
    if (userName) userName.textContent = currentUser.username;
    if (userRole) userRole.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
    
    // Clear existing navigation
    if (sidebarNav) sidebarNav.innerHTML = '';
    
    // Add navigation items based on user role
    if (currentUser.role === 'admin') {
        if (sidebarNav) {
            sidebarNav.innerHTML = `
                <div class="nav-item">
                    <a href="#" class="nav-link active" data-section="revenue-dashboard">
                        <i class="fas fa-chart-line"></i>
                        <span>Revenue Dashboard</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="records-management">
                        <i class="fas fa-list"></i>
                        <span>Records Management</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="track-delivery">
                        <i class="fas fa-search"></i>
                        <span>Track Delivery</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="price-management">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Price Management</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="user-management">
                        <i class="fas fa-users"></i>
                        <span>User Management</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="management">
                        <i class="fas fa-cog"></i>
                        <span>System Management</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="area-pricing">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Area-Based Pricing</span>
                    </a>
                </div>
            `;
        }
        
        // Hide cargo and boat delivery forms for admin
        const cargoDeliverySection = document.getElementById('cargo-delivery');
        const boatDeliverySection = document.getElementById('boat-delivery');
        const greaterMaleDeliverySection = document.getElementById('greater-male-delivery');
        if (cargoDeliverySection) cargoDeliverySection.style.display = 'none';
        if (boatDeliverySection) boatDeliverySection.style.display = 'none';
        if (greaterMaleDeliverySection) greaterMaleDeliverySection.style.display = 'none';
    } else {
        if (sidebarNav) {
            sidebarNav.innerHTML = `
                <div class="nav-item">
                    <a href="#" class="nav-link active" data-section="cargo-delivery">
                        <i class="fas fa-truck"></i>
                        <span>Cargo Delivery</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="boat-delivery">
                        <i class="fas fa-ship"></i>
                        <span>Boat Delivery</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="greater-male-delivery">
                        <i class="fas fa-city"></i>
                        <span>Greater Male City</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="track-delivery">
                        <i class="fas fa-search"></i>
                        <span>Track Delivery</span>
                    </a>
                </div>
            `;
        }
        
        // Hide admin-only sections
        const recordsManagement = document.getElementById('records-management');
        const priceManagement = document.getElementById('price-management');
        const userManagement = document.getElementById('user-management');
        const revenueDashboard = document.getElementById('revenue-dashboard');
        const management = document.getElementById('management');
        const areaPricingSection = document.getElementById('area-pricing');
        
        if (recordsManagement) recordsManagement.style.display = 'none';
        if (priceManagement) priceManagement.style.display = 'none';
        if (userManagement) userManagement.style.display = 'none';
        if (revenueDashboard) revenueDashboard.style.display = 'none';
        if (management) management.style.display = 'none';
        if (areaPricingSection) areaPricingSection.style.display = 'none';
    }
    
    // Reattach event listeners to navigation links
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetSection = this.getAttribute('data-section');
            
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            
            // Show target section
            dashboardSections.forEach(section => {
                section.classList.remove('active');
                if (section.id === targetSection) {
                    section.classList.add('active');
                    
                    // Load records data when Records Management section is accessed
                    if (targetSection === 'records-management') {
                        loadCargoData();
                        loadBoatData();
                        loadGreaterMaleData();
                        loadAreaData();
                    }
                    
                    // Load revenue data when Revenue Dashboard is accessed
                    if (targetSection === 'revenue-dashboard') {
                        loadRevenueData();
                    }
                    
                    // Load user references when cargo or boat delivery section is accessed
                    if (targetSection === 'cargo-delivery' || targetSection === 'boat-delivery' || targetSection === 'greater-male-delivery') {
                        loadUserReferences();
                    }
                    
                    // Load users when user management section is accessed
                    if (targetSection === 'user-management') {
                        loadUsers();
                    }
                    
                    // Load price lists when price management section is accessed
                    if (targetSection === 'price-management') {
                        loadPriceLists();
                    }
                    
                    // Load management data when management section is accessed
                    if (targetSection === 'management') {
                        loadManagementData();
                    }
                    
                    // Load area pricing when area-based pricing section is accessed
                    if (targetSection === 'area-pricing') {
                        loadAreaPricing();
                    }
                }
            });
            
            // Reset search if switching to track delivery
            if (targetSection === 'track-delivery') {
                resetSearch();
            }
            
            // Close sidebar on mobile
            if (window.innerWidth < 769) {
                closeSidebarFunc();
            }
        });
    });
    
    // Reattach logout button event
    if (sidebarLogoutBtn) {
        sidebarLogoutBtn.addEventListener('click', function() {
            // Clear login status from localStorage
            localStorage.removeItem('loggedInUser');
            
            if (dashboardContainer) dashboardContainer.style.display = 'none';
            if (loginContainer) loginContainer.style.display = 'block';
            if (loginForm) loginForm.reset();
            currentUser = null;
        });
    }
    
    // Initialize price tabs
    initializePriceTabs();
    
    // Initialize Greater Male City form
    initializeGreaterMaleForm();
    
    // Initialize management
    initializeManagement();
    
    // Initialize Google Maps functionality
    initializeGoogleMaps();
    
    // Initialize area-based pricing
    initializeAreaPricing();
}

// Initialize Google Maps functionality
function initializeGoogleMaps() {
    // Toggle map visibility
    if (enableMap) {
        enableMap.addEventListener('change', function() {
            if (this.checked) {
                if (mapContent) mapContent.style.display = 'block';
                if (manualLocationSection) manualLocationSection.style.display = 'none';
            } else {
                if (mapContent) mapContent.style.display = 'none';
                if (manualLocationSection) manualLocationSection.style.display = 'block';
            }
        });
    }
    
    // Map mode selection
    if (pickupModeBtn && destinationModeBtn) {
        pickupModeBtn.addEventListener('click', function() {
            currentMapMode = 'pickup';
            pickupModeBtn.classList.add('active');
            destinationModeBtn.classList.remove('active');
        });
        
        destinationModeBtn.addEventListener('click', function() {
            currentMapMode = 'destination';
            destinationModeBtn.classList.add('active');
            pickupModeBtn.classList.remove('active');
        });
    }
    
    // Use current location
    if (useCurrentLocation) {
        useCurrentLocation.addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const location = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    if (map) {
                        map.setCenter(location);
                        map.setZoom(16);
                        
                        placeMarker(new google.maps.LatLng(location), currentMapMode);
                    }
                }, function(error) {
                    showNotification('Unable to get your current location');
                });
            } else {
                showNotification('Geolocation is not supported by this browser');
            }
        });
    }
    
    // Search location
    if (searchLocation && autocomplete) {
        searchLocation.addEventListener('click', function() {
            const place = autocomplete.getPlace();
            if (!place.geometry) {
                showNotification('Please select a location from the dropdown');
                return;
            }
            
            if (map) {
                map.setCenter(place.geometry.location);
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setZoom(16);
                }
                
                placeMarker(place.geometry.location, currentMapMode);
            }
        });
    }
    
    // Clear map
    if (clearMap) {
        clearMap.addEventListener('click', function() {
            // Clear markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            pickupMarker = null;
            destinationMarker = null;
            selectedPickupLocation = null;
            selectedDestinationLocation = null;
            
            // Reset location details
            if (pickupLocationDetails) pickupLocationDetails.textContent = 'Not selected';
            if (destinationLocationDetails) destinationLocationDetails.textContent = 'Not selected';
            
            // Hide location info
            if (selectedLocationInfo) selectedLocationInfo.style.display = 'none';
            if (mapPricingInfo) mapPricingInfo.style.display = 'none';
        });
    }
    
    // Confirm location
    if (confirmLocation) {
        confirmLocation.addEventListener('click', function() {
            if (!pickupMarker || !destinationMarker) {
                showNotification('Please select both pickup and destination locations on the map');
                return;
            }
            
            // Update form fields with selected locations
            if (greaterMaleAddressName) greaterMaleAddressName.value = pickupLocationDetails.textContent;
            if (destinationAddressName) destinationAddressName.value = destinationLocationDetails.textContent;
            
            // Show success message
            showNotification('Locations confirmed successfully');
        });
    }
}

// Initialize area-based pricing
function initializeAreaPricing() {
    // Draw area button
    if (drawArea) {
        drawArea.addEventListener('click', function() {
            if (drawingManager) {
                drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
            }
        });
    }
    
    // Clear area button
    if (clearArea) {
        clearArea.addEventListener('click', function() {
            if (selectedPolygon) {
                selectedPolygon.setMap(null);
                selectedPolygon = null;
                selectedAreaCoordinates = [];
                
                // Hide coordinates info
                if (areaCoordinatesInfo) areaCoordinatesInfo.style.display = 'none';
            }
        });
    }
    
    // Add area pricing
    if (addAreaBtn) {
        addAreaBtn.addEventListener('click', function() {
            const name = areaName.value.trim();
            const price = parseFloat(areaPrice.value);
            
            if (!name) {
                showNotification('Please enter an area name');
                return;
            }
            
            if (isNaN(price) || price <= 0) {
                showNotification('Please enter a valid price');
                return;
            }
            
            if (selectedAreaCoordinates.length < 3) {
                showNotification('Please draw a valid area with at least 3 points');
                return;
            }
            
            // Convert coordinates to simple objects
            const coordinates = selectedAreaCoordinates.map(coord => {
                return { lat: coord.lat(), lng: coord.lng() };
            });
            
            // Add area pricing
            const area = {
                id: Date.now(),
                name: name,
                coordinates: coordinates,
                price: price,
                createdAt: new Date().toISOString()
            };
            
            areaPricing.push(area);
            saveAreaPricing();
            loadAreaPricing();
            
            // Reset form
            if (areaName) areaName.value = '';
            if (areaPrice) areaPrice.value = '';
            
            // Clear polygon
            if (selectedPolygon) {
                selectedPolygon.setMap(null);
                selectedPolygon = null;
                selectedAreaCoordinates = [];
                if (areaCoordinatesInfo) areaCoordinatesInfo.style.display = 'none';
            }
            
            showNotification('Area pricing added successfully');
        });
    }
}

// Load area pricing
function loadAreaPricing() {
    if (areaList) {
        areaList.innerHTML = '';
    }
    if (areaPriceList) {
        areaPriceList.innerHTML = '';
    }
    
    if (areaPricing.length === 0) {
        if (areaList) areaList.innerHTML = '<div class="empty-message">No area pricing defined</div>';
        if (areaPriceList) areaPriceList.innerHTML = '<div class="empty-message">No area pricing defined</div>';
        return;
    }
    
    areaPricing.forEach(area => {
        // Add to area list
        if (areaList) {
            const areaItem = document.createElement('div');
            areaItem.className = 'area-item';
            areaItem.innerHTML = `
                <div class="area-details">
                    <div class="area-name">${area.name}</div>
                    <div class="area-coordinates">${area.coordinates.length} points</div>
                </div>
                <div class="area-price">${area.price} MVR</div>
                <div class="area-actions">
                    <button class="edit-user-btn" onclick="editAreaPricing(${area.id})">Edit</button>
                    <button class="remove-user-btn" onclick="removeAreaPricing(${area.id})">Remove</button>
                </div>
            `;
            areaList.appendChild(areaItem);
        }
        
        // Add to price list
        if (areaPriceList) {
            const priceItem = document.createElement('div');
            priceItem.className = 'price-item';
            priceItem.innerHTML = `
                <div class="price-range">${area.name}</div>
                <div class="price-amount">${area.price} MVR</div>
                <div class="price-actions">
                    <button class="edit-price-btn" onclick="editAreaPricing(${area.id})">Edit</button>
                    <button class="remove-price-btn" onclick="removeAreaPricing(${area.id})">Remove</button>
                </div>
            `;
            areaPriceList.appendChild(priceItem);
        }
    });
}

// Edit area pricing
function editAreaPricing(id) {
    const area = areaPricing.find(a => a.id === id);
    if (!area) return;
    
    if (areaName) areaName.value = area.name;
    if (areaPrice) areaPrice.value = area.price;
    
    // Remove the area being edited
    areaPricing = areaPricing.filter(a => a.id !== id);
    saveAreaPricing();
    loadAreaPricing();
    
    // Draw the polygon on the map
    if (selectedPolygon) {
        selectedPolygon.setMap(null);
    }
    
    const polygonCoords = area.coordinates.map(coord => new google.maps.LatLng(coord.lat, coord.lng));
    selectedPolygon = new google.maps.Polygon({
        paths: polygonCoords,
        strokeColor: '#1a2a6c',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: '#4cc9f0',
        fillOpacity: 0.3
    });
    
    selectedPolygon.setMap(areaMap);
    selectedAreaCoordinates = polygonCoords;
    
    // Update area coordinates info
    updateAreaCoordinatesInfo();
    
    // Fit map to polygon bounds
    const bounds = new google.maps.LatLngBounds();
    polygonCoords.forEach(coord => bounds.extend(coord));
    if (areaMap) areaMap.fitBounds(bounds);
}

// Remove area pricing
function removeAreaPricing(id) {
    if (confirm('Are you sure you want to remove this area pricing?')) {
        areaPricing = areaPricing.filter(a => a.id !== id);
        saveAreaPricing();
        loadAreaPricing();
        showNotification('Area pricing removed successfully');
    }
}

// Load area data
function loadAreaData() {
    if (!areaTableBody) return;
    
    areaTableBody.innerHTML = '';
    
    // Filter data based on user role
    let displayAreaDeliveries = areaBasedDeliveries;
    if (currentUser.role !== 'admin') {
        displayAreaDeliveries = areaBasedDeliveries.filter(d => d.createdBy === currentUser.email);
    }
    
    if (displayAreaDeliveries.length === 0) {
        if (areaEmptyMessage) areaEmptyMessage.style.display = 'block';
        return;
    }
    
    if (areaEmptyMessage) areaEmptyMessage.style.display = 'none';
    
    displayAreaDeliveries.forEach(delivery => {
        const statusClass = getStatusClass(delivery.status);
        const paymentClass = getPaymentStatusClass(delivery.paymentStatus);
        const paymentText = getPaymentStatusText(delivery.paymentStatus);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <a class="reference-link ${delivery.status === 'Delivered' ? 'reference-completed' : 'reference-pending'}" onclick="trackDeliveryByReference('${delivery.referenceNumber}')">
                    ${delivery.referenceNumber}
                </a>
            </td>
            <td>${delivery.customerName}</td>
            <td>${delivery.customerContact}</td>
            <td>${delivery.areaName}</td>
            <td>${delivery.coordinates ? `${delivery.coordinates.length} points` : 'N/A'}</td>
            <td>${delivery.totalPrice} MVR</td>
            <td>
                <span class="status-badge ${statusClass}">${delivery.status}</span>
            </td>
            <td>
                <span class="status-badge ${paymentClass}">${paymentText}</span>
                ${delivery.paymentSlip ? `<br><button class="action-btn view-btn" onclick="viewPaymentSlip('${delivery.paymentSlip}')">View Slip</button>` : ''}
            </td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn update-btn" onclick="openStatusModal('area', ${delivery.id})">Update</button>
                    ${currentUser.role === 'admin' && delivery.paymentStatus === 'under_review' ? 
                        `<button class="action-btn review-btn" onclick="approvePayment('area', ${delivery.id})">Approve</button>` : ''}
                    <button class="action-btn delete-btn" onclick="deleteDelivery('area', ${delivery.id})">Delete</button>
                </div>
            </td>
        `;
        areaTableBody.appendChild(row);
    });
}

// Save area-based delivery
function saveAreaBasedDelivery(deliveryData) {
    areaBasedDeliveries.push(deliveryData);
    saveAreaBasedData();
    loadAreaData();
    loadUserReferences();
    
    // Add notification
    addNotification(
        'New Area-Based Delivery Created',
        `Area-based delivery for ${deliveryData.customerName} has been created and is awaiting payment approval. Reference: ${deliveryData.referenceNumber}`,
        currentUser.email
    );
    
    // Show success notification
    showNotification('Area-based delivery saved successfully! Payment is under review.');
}

// Initialize price tabs functionality
function initializePriceTabs() {
    priceTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // Update active tab
            priceTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Show target content
            priceContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === targetTab) {
                    content.classList.add('active');
                }
            });
        });
    });
}

// Initialize Greater Male City form
function initializeGreaterMaleForm() {
    // Pickup location change handler
    if (greaterMalePickupLocation) {
        greaterMalePickupLocation.addEventListener('change', function() {
            const selectedLocation = pickupLocations.find(loc => loc.name === this.value);
            if (selectedLocation) {
                if (selectedLocation.type === 'address') {
                    if (greaterMaleAddressField) greaterMaleAddressField.style.display = 'block';
                    if (greaterMalePackageDetailsField) greaterMalePackageDetailsField.style.display = 'none';
                } else {
                    if (greaterMaleAddressField) greaterMaleAddressField.style.display = 'none';
                    if (greaterMalePackageDetailsField) greaterMalePackageDetailsField.style.display = 'block';
                }
            }
        });
    }
    
    // Destination change handler
    if (destinationOptions) {
        destinationOptions.addEventListener('click', function(e) {
            if (e.target.classList.contains('destination-btn')) {
                // Remove active class from all buttons
                document.querySelectorAll('.destination-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                e.target.classList.add('active');
                
                const selectedDestination = destinations.find(dest => dest.name === e.target.textContent);
                if (selectedDestination) {
                    if (selectedDestination.type === 'boat') {
                        if (boatNameField) boatNameField.style.display = 'block';
                        if (destinationAddressField) destinationAddressField.style.display = 'none';
                    } else {
                        if (boatNameField) boatNameField.style.display = 'none';
                        if (destinationAddressField) destinationAddressField.style.display = 'block';
                    }
                }
                
                // Update price breakdown
                updateGreaterMalePrice();
            }
        });
    }
    
    // Quantity controls
    if (decreaseQuantity && increaseQuantity && itemQuantity) {
        decreaseQuantity.addEventListener('click', function() {
            let currentValue = parseInt(itemQuantity.value);
            if (currentValue > 1) {
                itemQuantity.value = currentValue - 1;
                updateGreaterMalePrice();
            }
        });
        
        increaseQuantity.addEventListener('click', function() {
            let currentValue = parseInt(itemQuantity.value);
            if (currentValue < 10) {
                itemQuantity.value = currentValue + 1;
                updateGreaterMalePrice();
            }
        });
        
        itemQuantity.addEventListener('change', function() {
            let value = parseInt(this.value);
            if (isNaN(value) || value < 1) {
                this.value = 1;
            } else if (value > 10) {
                this.value = 10;
            }
            updateGreaterMalePrice();
        });
    }
    
    // Item size selection handler
    document.addEventListener('click', function(e) {
        if (e.target.closest('.item-size-btn')) {
            const btn = e.target.closest('.item-size-btn');
            
            // Remove active class from all buttons
            document.querySelectorAll('.item-size-btn').forEach(b => {
                b.classList.remove('active');
            });
            
            // Add active class to clicked button
            btn.classList.add('active');
            
            // Update vehicle options based on selected item size
            updateVehicleOptions(btn.getAttribute('data-size'));
            
            // Update price breakdown
            updateGreaterMalePrice();
            
            // Update map pricing if map is enabled
            if (enableMap && enableMap.checked && selectedPickupLocation && selectedDestinationLocation) {
                calculateMapBasedPricing();
            }
        }
    });
    
    // Vehicle selection handler
    document.addEventListener('click', function(e) {
        if (e.target.closest('.vehicle-btn') && !e.target.closest('.vehicle-btn').classList.contains('disabled')) {
            const btn = e.target.closest('.vehicle-btn');
            
            // Remove active class from all buttons
            document.querySelectorAll('.vehicle-btn').forEach(b => {
                b.classList.remove('active');
            });
            
            // Add active class to clicked button
            btn.classList.add('active');
            
            // Update price breakdown
            updateGreaterMalePrice();
            
            // Update map pricing if map is enabled
            if (enableMap && enableMap.checked && selectedPickupLocation && selectedDestinationLocation) {
                calculateMapBasedPricing();
            }
        }
    });
    
    // Form submission
    if (greaterMaleForm) {
        greaterMaleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedItemSize = document.querySelector('.item-size-btn.active');
            const selectedVehicle = document.querySelector('.vehicle-btn.active');
            
            if (!selectedItemSize || !selectedVehicle) {
                showNotification('Please select item size and vehicle');
                return;
            }
            
            // Check if using map or manual selection
            let pickupLocation, destination;
            let pickupAddress, destinationAddress;
            let boatName = '';
            
            if (enableMap && enableMap.checked) {
                // Using map selection
                if (!selectedPickupLocation || !selectedDestinationLocation) {
                    showNotification('Please select both pickup and destination locations on the map');
                    return;
                }
                
                pickupLocation = 'Map Selected';
                destination = 'Map Selected';
                pickupAddress = pickupLocationDetails ? pickupLocationDetails.textContent : '';
                destinationAddress = destinationLocationDetails ? destinationLocationDetails.textContent : '';
            } else {
                // Using manual selection
                const selectedDestination = document.querySelector('.destination-btn.active');
                
                if (!selectedDestination) {
                    showNotification('Please select a destination');
                    return;
                }
                
                pickupLocation = greaterMalePickupLocation ? greaterMalePickupLocation.value : '';
                destination = selectedDestination.textContent;
                
                if (pickupLocation === 'Male' || pickupLocation === 'Hulhumale' || pickupLocation === 'Phase2') {
                    pickupAddress = greaterMaleAddressName ? greaterMaleAddressName.value : '';
                } else {
                    pickupAddress = greaterMalePackageDetails ? greaterMalePackageDetails.value : '';
                }
                
                const selectedDestinationObj = destinations.find(dest => dest.name === destination);
                if (selectedDestinationObj && selectedDestinationObj.type === 'boat') {
                    boatName = boatNameInput ? boatNameInput.value : '';
                    destinationAddress = '';
                } else {
                    destinationAddress = destinationAddressName ? destinationAddressName.value : '';
                }
            }
            
            const referenceNumber = generateReferenceNumber('GMC');
            
            const greaterMaleData = {
                customerName: greaterMaleCustomerName ? greaterMaleCustomerName.value : '',
                customerContact: greaterMaleCustomerContact ? greaterMaleCustomerContact.value : '',
                pickupLocation: pickupLocation,
                addressName: pickupAddress,
                packageDetails: greaterMalePackageDetails ? greaterMalePackageDetails.value : '',
                itemSize: selectedItemSize.getAttribute('data-size'),
                itemSizeDisplay: selectedItemSize.querySelector('span').textContent,
                quantity: parseInt(itemQuantity ? itemQuantity.value : 1),
                vehicle: selectedVehicle.getAttribute('data-vehicle'),
                vehicleDisplay: selectedVehicle.querySelector('span').textContent,
                destination: destination,
                boatName: boatName,
                destinationAddress: destinationAddress,
                totalPrice: calculateGreaterMaleTotalPrice(),
                status: 'Order Placed',
                progress: 1,
                id: Date.now(),
                referenceNumber: referenceNumber,
                type: 'greater-male',
                createdAt: new Date().toISOString(),
                paymentStatus: 'under_review',
                createdBy: currentUser.email
            };
            
            // Add map location data if using map
            if (enableMap && enableMap.checked) {
                greaterMaleData.pickupLatitude = selectedPickupLocation.lat();
                greaterMaleData.pickupLongitude = selectedPickupLocation.lng();
                greaterMaleData.destinationLatitude = selectedDestinationLocation.lat();
                greaterMaleData.destinationLongitude = selectedDestinationLocation.lng();
                greaterMaleData.pickupAddress = pickupAddress;
                greaterMaleData.destinationAddress = destinationAddress;
            }
            
            // Show payment modal
            showPaymentModal(greaterMaleData);
        });
    }
}

// Initialize management functionality
function initializeManagement() {
    // Add pickup location button
    if (addPickupLocationBtn) {
        addPickupLocationBtn.addEventListener('click', function() {
            currentManagementType = 'pickupLocation';
            editingManagementId = null;
            if (managementModalTitle) managementModalTitle.textContent = 'Add Pickup Location';
            if (managementName) managementName.value = '';
            if (managementDescription) managementDescription.value = '';
            if (managementPriceField) managementPriceField.style.display = 'none';
            if (managementModal) managementModal.classList.add('active');
        });
    }
    
    // Add destination button
    if (addDestinationBtn) {
        addDestinationBtn.addEventListener('click', function() {
            currentManagementType = 'destination';
            editingManagementId = null;
            if (managementModalTitle) managementModalTitle.textContent = 'Add Destination';
            if (managementName) managementName.value = '';
            if (managementDescription) managementDescription.value = '';
            if (managementPriceField) managementPriceField.style.display = 'block';
            if (managementPrice) managementPrice.value = '';
            if (managementModal) managementModal.classList.add('active');
        });
    }
    
    // Add item size button
    if (addItemSizeBtn) {
        addItemSizeBtn.addEventListener('click', function() {
            currentManagementType = 'itemSize';
            editingManagementId = null;
            if (managementModalTitle) managementModalTitle.textContent = 'Add Item Size';
            if (managementName) managementName.value = '';
            if (managementDescription) managementDescription.value = '';
            if (managementPriceField) managementPriceField.style.display = 'block';
            if (managementPrice) managementPrice.value = '';
            if (managementModal) managementModal.classList.add('active');
        });
    }
    
    // Add vehicle button
    if (addVehicleBtn) {
        addVehicleBtn.addEventListener('click', function() {
            currentManagementType = 'vehicle';
            editingManagementId = null;
            if (managementModalTitle) managementModalTitle.textContent = 'Add Vehicle';
            if (managementName) managementName.value = '';
            if (managementDescription) managementDescription.value = '';
            if (managementPriceField) managementPriceField.style.display = 'block';
            if (managementPrice) managementPrice.value = '';
            if (managementModal) managementModal.classList.add('active');
        });
    }
    
    // Cancel management
    if (cancelManagement) {
        cancelManagement.addEventListener('click', function() {
            if (managementModal) managementModal.classList.remove('active');
            currentManagementType = null;
            editingManagementId = null;
        });
    }
    
    // Confirm management
    if (confirmManagement) {
        confirmManagement.addEventListener('click', function() {
            const name = managementName ? managementName.value.trim() : '';
            const description = managementDescription ? managementDescription.value.trim() : '';
            const price = managementPrice && managementPrice.value ? parseFloat(managementPrice.value) : 0;
            
            if (!name) {
                showNotification('Please enter a name');
                return;
            }
            
            if ((currentManagementType === 'destination' || currentManagementType === 'itemSize' || currentManagementType === 'vehicle') && isNaN(price)) {
                showNotification('Please enter a valid price');
                return;
            }
            
            if (editingManagementId) {
                // Update existing item
                let item;
                let collection;
                
                switch(currentManagementType) {
                    case 'pickupLocation':
                        collection = pickupLocations;
                        break;
                    case 'destination':
                        collection = destinations;
                        break;
                    case 'itemSize':
                        collection = itemSizes;
                        break;
                    case 'vehicle':
                        collection = vehicles;
                        break;
                }
                
                item = collection.find(i => i.id === editingManagementId);
                if (item) {
                    item.name = name;
                    item.description = description;
                    if (currentManagementType !== 'pickupLocation') {
                        item.price = price;
                    }
                    
                    saveManagementData(currentManagementType);
                    loadManagementData();
                    showNotification(`${currentManagementType} updated successfully`);
                }
            } else {
                // Add new item
                const newItem = {
                    id: Date.now(),
                    name: name,
                    description: description
                };
                
                if (currentManagementType !== 'pickupLocation') {
                    newItem.price = price;
                }
                
                if (currentManagementType === 'pickupLocation') {
                    // For pickup locations, we need to determine the type
                    if (name.toLowerCase().includes('male') || name.toLowerCase().includes('phase')) {
                        newItem.type = 'address';
                    } else {
                        newItem.type = 'package';
                    }
                    pickupLocations.push(newItem);
                } else if (currentManagementType === 'destination') {
                    // For destinations, we need to determine the type
                    if (name.toLowerCase().includes('boat')) {
                        newItem.type = 'boat';
                    } else {
                        newItem.type = 'address';
                    }
                    destinations.push(newItem);
                } else if (currentManagementType === 'itemSize') {
                    itemSizes.push(newItem);
                } else if (currentManagementType === 'vehicle') {
                    vehicles.push(newItem);
                }
                
                saveManagementData(currentManagementType);
                loadManagementData();
                showNotification(`${currentManagementType} added successfully`);
            }
            
            if (managementModal) managementModal.classList.remove('active');
            currentManagementType = null;
            editingManagementId = null;
        });
    }
}

// Load management data
function loadManagementData() {
    // Load pickup locations
    loadPickupLocations();
    
    // Load destinations
    loadDestinations();
    
    // Load item sizes
    loadItemSizes();
    
    // Load vehicles
    loadVehicles();
    
    // Update Greater Male City form options
    updateGreaterMaleFormOptions();
}

// Load pickup locations
function loadPickupLocations() {
    if (!pickupLocationList) return;
    
    pickupLocationList.innerHTML = '';
    
    if (pickupLocations.length === 0) {
        pickupLocationList.innerHTML = '<div class="empty-message">No pickup locations defined</div>';
        return;
    }
    
    pickupLocations.forEach(location => {
        const item = document.createElement('div');
        item.className = 'management-item';
        item.innerHTML = `
            <div class="management-item-details">
                <div class="management-item-name">${location.name}</div>
                <div class="management-item-description">${location.description} (${location.type})</div>
            </div>
            <div class="management-item-actions">
                <button class="edit-user-btn" onclick="editManagementItem('pickupLocation', ${location.id})">Edit</button>
                <button class="remove-user-btn" onclick="removeManagementItem('pickupLocation', ${location.id})">Remove</button>
            </div>
        `;
        pickupLocationList.appendChild(item);
    });
}

// Load destinations
function loadDestinations() {
    if (!destinationList) return;
    
    destinationList.innerHTML = '';
    
    if (destinations.length === 0) {
        destinationList.innerHTML = '<div class="empty-message">No destinations defined</div>';
        return;
    }
    
    destinations.forEach(destination => {
        const item = document.createElement('div');
        item.className = 'management-item';
        item.innerHTML = `
            <div class="management-item-details">
                <div class="management-item-name">${destination.name}</div>
                <div class="management-item-description">${destination.description} (${destination.type}) - ${destination.price} MVR</div>
            </div>
            <div class="management-item-actions">
                <button class="edit-user-btn" onclick="editManagementItem('destination', ${destination.id})">Edit</button>
                <button class="remove-user-btn" onclick="removeManagementItem('destination', ${destination.id})">Remove</button>
            </div>
        `;
        destinationList.appendChild(item);
    });
}

// Load item sizes
function loadItemSizes() {
    if (!itemSizeList) return;
    
    itemSizeList.innerHTML = '';
    
    if (itemSizes.length === 0) {
        itemSizeList.innerHTML = '<div class="empty-message">No item sizes defined</div>';
        return;
    }
    
    itemSizes.forEach(itemSize => {
        const item = document.createElement('div');
        item.className = 'management-item';
        item.innerHTML = `
            <div class="management-item-details">
                <div class="management-item-name">${itemSize.name}</div>
                <div class="management-item-description">${itemSize.description} - ${itemSize.price} MVR</div>
            </div>
            <div class="management-item-actions">
                <button class="edit-user-btn" onclick="editManagementItem('itemSize', ${itemSize.id})">Edit</button>
                <button class="remove-user-btn" onclick="removeManagementItem('itemSize', ${itemSize.id})">Remove</button>
            </div>
        `;
        itemSizeList.appendChild(item);
    });
}

// Load vehicles
function loadVehicles() {
    if (!vehicleList) return;
    
    vehicleList.innerHTML = '';
    
    if (vehicles.length === 0) {
        vehicleList.innerHTML = '<div class="empty-message">No vehicles defined</div>';
        return;
    }
    
    vehicles.forEach(vehicle => {
        const item = document.createElement('div');
        item.className = 'management-item';
        item.innerHTML = `
            <div class="management-item-details">
                <div class="management-item-name">${vehicle.name}</div>
                <div class="management-item-description">${vehicle.description} - ${vehicle.price} MVR</div>
            </div>
            <div class="management-item-actions">
                <button class="edit-user-btn" onclick="editManagementItem('vehicle', ${vehicle.id})">Edit</button>
                <button class="remove-user-btn" onclick="removeManagementItem('vehicle', ${vehicle.id})">Remove</button>
            </div>
        `;
        vehicleList.appendChild(item);
    });
}

// Update Greater Male City form options
function updateGreaterMaleFormOptions() {
    // Update pickup locations dropdown
    if (greaterMalePickupLocation) {
        greaterMalePickupLocation.innerHTML = '<option value="">Select Pickup Location</option>';
        pickupLocations.forEach(location => {
            const option = document.createElement('option');
            option.value = location.name;
            option.textContent = location.name;
            greaterMalePickupLocation.appendChild(option);
        });
    }
    
    // Update item size options
    if (itemSizeOptions) {
        itemSizeOptions.innerHTML = '';
        itemSizes.forEach(itemSize => {
            const option = document.createElement('div');
            option.className = 'item-size-option';
            option.innerHTML = `
                <button type="button" class="item-size-btn" data-size="${itemSize.name}" data-price="${itemSize.price}">
                    <div class="item-size-visual">
                        <div class="item-size-image">
                            <i class="${itemSize.icon}"></i>
                        </div>
                        <div class="item-size-description">${itemSize.visual}</div>
                    </div>
                    <span>${itemSize.name}</span>
                </button>
            `;
            itemSizeOptions.appendChild(option);
        });
    }
    
    // Update vehicle options
    if (vehicleOptions) {
        vehicleOptions.innerHTML = '';
        vehicles.forEach(vehicle => {
            const option = document.createElement('div');
            option.className = 'vehicle-option';
            option.innerHTML = `
                <button type="button" class="vehicle-btn" data-vehicle="${vehicle.name}" data-price="${vehicle.price}">
                    <i class="fas fa-truck vehicle-icon"></i>
                    <span>${vehicle.name}</span>
                </button>
            `;
            vehicleOptions.appendChild(option);
        });
    }
    
    // Update destination options
    if (destinationOptions) {
        destinationOptions.innerHTML = '';
        destinations.forEach(destination => {
            const option = document.createElement('div');
            option.className = 'destination-option';
            option.innerHTML = `
                <button type="button" class="destination-btn" data-destination="${destination.name}" data-price="${destination.price}">
                    ${destination.name}
                </button>
            `;
            destinationOptions.appendChild(option);
        });
    }
    
    // Update price management dropdowns
    if (itemType) {
        itemType.innerHTML = '';
        itemSizes.forEach(itemSize => {
            const option = document.createElement('option');
            option.value = itemSize.name;
            option.textContent = itemSize.name;
            itemType.appendChild(option);
        });
    }
    
    if (destinationType) {
        destinationType.innerHTML = '';
        destinations.forEach(destination => {
            const option = document.createElement('option');
            option.value = destination.name;
            option.textContent = destination.name;
            destinationType.appendChild(option);
        });
    }
}

// Update vehicle options based on selected item size
function updateVehicleOptions(selectedSize) {
    const motorcycleBtn = document.querySelector('.vehicle-btn[data-vehicle="Motorcycle"]');
    const pickupBtn = document.querySelector('.vehicle-btn[data-vehicle="Pickup"]');
    
    // Reset all buttons
    document.querySelectorAll('.vehicle-btn').forEach(btn => {
        btn.classList.remove('active', 'disabled');
    });
    
    // Enable/disable buttons based on item size
    if (selectedSize === 'Small Package' || selectedSize === 'Small Box') {
        // Only motorcycle allowed for small items
        if (motorcycleBtn) {
            motorcycleBtn.classList.remove('disabled');
            motorcycleBtn.classList.add('active');
        }
        if (pickupBtn) {
            pickupBtn.classList.add('disabled');
        }
    } else {
        // Both vehicles allowed for large items
        if (motorcycleBtn) {
            motorcycleBtn.classList.remove('disabled');
            motorcycleBtn.classList.add('active');
        }
        if (pickupBtn) {
            pickupBtn.classList.remove('disabled');
        }
    }
}

// Calculate Greater Male City total price
function calculateGreaterMaleTotalPrice() {
    const selectedItemSize = document.querySelector('.item-size-btn.active');
    const selectedVehicle = document.querySelector('.vehicle-btn.active');
    const selectedDestination = document.querySelector('.destination-btn.active');
    const quantity = itemQuantity ? parseInt(itemQuantity.value) : 1;
    
    if (!selectedItemSize || !selectedVehicle) return 0;
    
    const itemPrice = parseFloat(selectedItemSize.getAttribute('data-price'));
    const vehiclePrice = parseFloat(selectedVehicle.getAttribute('data-price'));
    
    let destinationPrice = 0;
    if (selectedDestination) {
        destinationPrice = parseFloat(selectedDestination.getAttribute('data-price'));
    }
    
    // FIX: Only multiply item price by quantity, not vehicle and destination fees
    return (itemPrice * quantity) + vehiclePrice + destinationPrice;
}

// Update Greater Male City price breakdown
function updateGreaterMalePrice() {
    const selectedItemSize = document.querySelector('.item-size-btn.active');
    const selectedVehicle = document.querySelector('.vehicle-btn.active');
    const selectedDestination = document.querySelector('.destination-btn.active');
    const quantity = itemQuantity ? parseInt(itemQuantity.value) : 1;
    
    if (!selectedItemSize || !selectedVehicle) {
        if (itemPriceValue) itemPriceValue.textContent = '0 MVR';
        if (vehiclePriceValue) vehiclePriceValue.textContent = '0 MVR';
        if (destinationPriceValue) destinationPriceValue.textContent = '0 MVR';
        if (greaterMaleTotalPrice) greaterMaleTotalPrice.textContent = '0 MVR';
        return;
    }
    
    const itemPrice = parseFloat(selectedItemSize.getAttribute('data-price'));
    const vehiclePrice = parseFloat(selectedVehicle.getAttribute('data-price'));
    
    let destinationPrice = 0;
    if (selectedDestination) {
        destinationPrice = parseFloat(selectedDestination.getAttribute('data-price'));
    }
    
    // FIX: Only multiply item price by quantity, not vehicle and destination fees
    const totalPrice = (itemPrice * quantity) + vehiclePrice + destinationPrice;
    
    if (itemPriceValue) itemPriceValue.textContent = `${itemPrice * quantity} MVR`;
    if (vehiclePriceValue) vehiclePriceValue.textContent = `${vehiclePrice} MVR`;
    if (destinationPriceValue) destinationPriceValue.textContent = `${destinationPrice} MVR`;
    if (greaterMaleTotalPrice) greaterMaleTotalPrice.textContent = `${totalPrice} MVR`;
}

// Sidebar functionality
if (menuToggle) {
    menuToggle.addEventListener('click', openSidebar);
}
if (closeSidebar) {
    closeSidebar.addEventListener('click', closeSidebarFunc);
}
if (sidebarOverlay) {
    sidebarOverlay.addEventListener('click', closeSidebarFunc);
}

function openSidebar() {
    if (sidebar) sidebar.classList.add('active');
    if (sidebarOverlay) sidebarOverlay.classList.add('active');
}

function closeSidebarFunc() {
    if (sidebar) sidebar.classList.remove('active');
    if (sidebarOverlay) sidebarOverlay.classList.remove('active');
}

// References Panel functionality
if (referencesToggle) {
    referencesToggle.addEventListener('click', function() {
        if (referencesPanel) referencesPanel.classList.add('active');
        loadAllReferences();
    });
}

if (closeReferences) {
    closeReferences.addEventListener('click', function() {
        if (referencesPanel) referencesPanel.classList.remove('active');
    });
}

// Load all delivery references
function loadAllReferences() {
    if (!referencesContent) return;
    
    referencesContent.innerHTML = '';
    
    // Combine all deliveries
    const allDeliveries = [...cargoDeliveries, ...boatDeliveries, ...greaterMaleDeliveries, ...areaBasedDeliveries];
    
    // Filter based on user role
    let displayDeliveries = allDeliveries;
    if (currentUser.role !== 'admin') {
        displayDeliveries = allDeliveries.filter(d => d.createdBy === currentUser.email);
    }
    
    if (displayDeliveries.length === 0) {
        referencesContent.innerHTML = '<div class="empty-message">No delivery reference numbers found</div>';
        return;
    }
    
    // Sort deliveries by creation date (newest first)
    displayDeliveries.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    displayDeliveries.forEach(delivery => {
        const referenceItem = document.createElement('div');
        referenceItem.className = 'reference-item';
        
        // Add status class
        if (delivery.status === 'Delivered') {
            referenceItem.classList.add('completed');
        } else {
            referenceItem.classList.add('pending');
        }
        
        let typeText = '';
        if (delivery.type === 'cargo') typeText = 'Cargo';
        else if (delivery.type === 'boat') typeText = 'Boat';
        else if (delivery.type === 'greater-male') typeText = 'Greater Male';
        else if (delivery.type === 'area') typeText = 'Area-Based';
        
        referenceItem.innerHTML = `
            <div class="reference-header">
                <div class="reference-number">${delivery.referenceNumber}</div>
                <div class="reference-type">${typeText}</div>
            </div>
            <div class="reference-details">
                <div><strong>Customer:</strong> ${delivery.customerName}</div>
                <div><strong>Contact:</strong> ${delivery.customerContact}</div>
                <div><strong>Created:</strong> ${formatDate(delivery.createdAt)}</div>
            </div>
            <div class="reference-status ${getStatusClass(delivery.status)}">${delivery.status}</div>
        `;
        
        // Add click event to track delivery
        referenceItem.addEventListener('click', function() {
            trackDeliveryByReference(delivery.referenceNumber);
            if (referencesPanel) referencesPanel.classList.remove('active');
        });
        
        referencesContent.appendChild(referenceItem);
    });
}

// Load user's reference numbers
function loadUserReferences() {
    // Clear existing reference lists
    if (userCargoReferences) userCargoReferences.innerHTML = '';
    if (userBoatReferences) userBoatReferences.innerHTML = '';
    if (userGreaterMaleReferences) userGreaterMaleReferences.innerHTML = '';
    
    // Get all deliveries for the current user
    const userCargoDeliveries = cargoDeliveries.filter(d => d.createdBy === currentUser.email);
    const userBoatDeliveries = boatDeliveries.filter(d => d.createdBy === currentUser.email);
    const userGreaterMaleDeliveries = greaterMaleDeliveries.filter(d => d.createdBy === currentUser.email);
    const userAreaBasedDeliveries = areaBasedDeliveries.filter(d => d.createdBy === currentUser.email);
    
    // Load cargo references
    if (userCargoReferences) {
        if (userCargoDeliveries.length === 0) {
            userCargoReferences.innerHTML = '<div class="empty-message">No cargo delivery reference numbers found</div>';
        } else {
            // Sort cargo deliveries by creation date (newest first)
            userCargoDeliveries.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Create cargo reference list
            const cargoReferenceList = document.createElement('div');
            cargoReferenceList.style.display = 'flex';
            cargoReferenceList.style.flexWrap = 'wrap';
            cargoReferenceList.style.gap = '10px';
            cargoReferenceList.style.marginTop = '15px';
            
            userCargoDeliveries.forEach(delivery => {
                const referenceItem = document.createElement('div');
                referenceItem.className = 'reference-link';
                
                // Apply color based on delivery status
                if (delivery.status === 'Delivered') {
                    referenceItem.classList.add('reference-completed');
                } else {
                    referenceItem.classList.add('reference-pending');
                }
                
                referenceItem.textContent = delivery.referenceNumber;
                referenceItem.style.cursor = 'pointer';
                referenceItem.style.padding = '8px 12px';
                referenceItem.style.borderRadius = '6px';
                referenceItem.style.backgroundColor = delivery.status === 'Delivered' ? '#e8f5e9' : '#ffebee';
                referenceItem.style.border = delivery.status === 'Delivered' ? '1px solid #4caf50' : '1px solid #f44336';
                
                // Add click event to track delivery
                referenceItem.addEventListener('click', function() {
                    trackDeliveryByReference(delivery.referenceNumber);
                });
                
                cargoReferenceList.appendChild(referenceItem);
            });
            
            userCargoReferences.appendChild(cargoReferenceList);
        }
    }
    
    // Load boat references
    if (userBoatReferences) {
        if (userBoatDeliveries.length === 0) {
            userBoatReferences.innerHTML = '<div class="empty-message">No boat delivery reference numbers found</div>';
        } else {
            // Sort boat deliveries by creation date (newest first)
            userBoatDeliveries.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Create boat reference list
            const boatReferenceList = document.createElement('div');
            boatReferenceList.style.display = 'flex';
            boatReferenceList.style.flexWrap = 'wrap';
            boatReferenceList.style.gap = '10px';
            boatReferenceList.style.marginTop = '15px';
            
            userBoatDeliveries.forEach(delivery => {
                const referenceItem = document.createElement('div');
                referenceItem.className = 'reference-link';
                
                // Apply color based on delivery status
                if (delivery.status === 'Delivered') {
                    referenceItem.classList.add('reference-completed');
                } else {
                    referenceItem.classList.add('reference-pending');
                }
                
                referenceItem.textContent = delivery.referenceNumber;
                referenceItem.style.cursor = 'pointer';
                referenceItem.style.padding = '8px 12px';
                referenceItem.style.borderRadius = '6px';
                referenceItem.style.backgroundColor = delivery.status === 'Delivered' ? '#e8f5e9' : '#ffebee';
                referenceItem.style.border = delivery.status === 'Delivered' ? '1px solid #4caf50' : '1px solid #f44336';
                
                // Add click event to track delivery
                referenceItem.addEventListener('click', function() {
                    trackDeliveryByReference(delivery.referenceNumber);
                });
                
                boatReferenceList.appendChild(referenceItem);
            });
            
            userBoatReferences.appendChild(boatReferenceList);
        }
    }
    
    // Load Greater Male City references
    if (userGreaterMaleReferences) {
        if (userGreaterMaleDeliveries.length === 0) {
            userGreaterMaleReferences.innerHTML = '<div class="empty-message">No Greater Male City delivery reference numbers found</div>';
        } else {
            // Sort Greater Male City deliveries by creation date (newest first)
            userGreaterMaleDeliveries.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Create Greater Male City reference list
            const greaterMaleReferenceList = document.createElement('div');
            greaterMaleReferenceList.style.display = 'flex';
            greaterMaleReferenceList.style.flexWrap = 'wrap';
            greaterMaleReferenceList.style.gap = '10px';
            greaterMaleReferenceList.style.marginTop = '15px';
            
            userGreaterMaleDeliveries.forEach(delivery => {
                const referenceItem = document.createElement('div');
                referenceItem.className = 'reference-link';
                
                // Apply color based on delivery status
                if (delivery.status === 'Delivered') {
                    referenceItem.classList.add('reference-completed');
                } else {
                    referenceItem.classList.add('reference-pending');
                }
                
                referenceItem.textContent = delivery.referenceNumber;
                referenceItem.style.cursor = 'pointer';
                referenceItem.style.padding = '8px 12px';
                referenceItem.style.borderRadius = '6px';
                referenceItem.style.backgroundColor = delivery.status === 'Delivered' ? '#e8f5e9' : '#ffebee';
                referenceItem.style.border = delivery.status === 'Delivered' ? '1px solid #4caf50' : '1px solid #f44336';
                
                // Add click event to track delivery
                referenceItem.addEventListener('click', function() {
                    trackDeliveryByReference(delivery.referenceNumber);
                });
                
                greaterMaleReferenceList.appendChild(referenceItem);
            });
            
            userGreaterMaleReferences.appendChild(greaterMaleReferenceList);
        }
    }
}

// Notifications functionality
if (notificationsToggle) {
    notificationsToggle.addEventListener('click', function() {
        if (notificationsPanel) notificationsPanel.classList.add('active');
        // Mark all notifications as read when opening panel
        markAllNotificationsAsRead();
    });
}

if (closeNotifications) {
    closeNotifications.addEventListener('click', function() {
        if (notificationsPanel) notificationsPanel.classList.remove('active');
    });
}

// Load notifications
function loadNotifications() {
    if (!notificationsContent) return;
    
    notificationsContent.innerHTML = '';
    
    // Filter notifications for current user
    const userNotifications = notifications.filter(n => 
        n.userEmail === currentUser.email || n.userEmail === 'all'
    );
    
    if (userNotifications.length === 0) {
        notificationsContent.innerHTML = '<div class="empty-message">No notifications</div>';
        return;
    }
    
    // Sort notifications by date (newest first)
    userNotifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    userNotifications.forEach(notification => {
        const notificationItem = document.createElement('div');
        notificationItem.className = 'notification-item';
        
        // Check if notification is unread
        if (!notification.read) {
            notificationItem.classList.add('unread');
        }
        
        notificationItem.innerHTML = `
            <div class="notification-header">
                <div class="notification-title">${notification.title}</div>
                <div class="notification-time">${formatTimeAgo(notification.timestamp)}</div>
            </div>
            <div class="notification-message">${notification.message}</div>
            <div class="notification-actions" style="margin-top: 10px; text-align: right;">
                <button class="action-btn delete-btn" onclick="removeNotification(${notification.id})" style="padding: 5px 10px; font-size: 12px;">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        `;
        
        notificationsContent.appendChild(notificationItem);
    });
}

// Format time ago (1hr ago, 2hr ago, etc.)
function formatTimeAgo(timestamp) {
    const now = new Date();
    const notificationTime = new Date(timestamp);
    const diffInMs = now - notificationTime;
    const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
    const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
    const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
    
    if (diffInMinutes < 1) {
        return 'Just now';
    } else if (diffInMinutes < 60) {
        return `${diffInMinutes} min ago`;
    } else if (diffInHours < 24) {
        return `${diffInHours} hr ago`;
    } else if (diffInDays < 7) {
        return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;
    } else {
        return formatDate(timestamp);
    }
}

// Add notification
function addNotification(title, message, userEmail = 'all') {
    const notification = {
        id: Date.now(),
        title: title,
        message: message,
        userEmail: userEmail,
        timestamp: new Date().toISOString(),
        read: false
    };
    
    notifications.push(notification);
    saveNotifications();
    loadNotifications();
    
    // Update notification badge
    updateNotificationBadge();
    
    // Play notification sound
    playNotificationSound();
    
    // Show toast notification
    showNotification(`${title}: ${message}`);
}

// Play notification sound
function playNotificationSound() {
    try {
        if (notificationSound) {
            notificationSound.currentTime = 0;
            notificationSound.play();
        }
    } catch (error) {
        console.log('Could not play notification sound:', error);
    }
}

// Remove notification
function removeNotification(id) {
    notifications = notifications.filter(n => n.id !== id);
    saveNotifications();
    loadNotifications();
    updateNotificationBadge();
}

// Mark all notifications as read
function markAllNotificationsAsRead() {
    notifications.forEach(notification => {
        if ((notification.userEmail === currentUser.email || notification.userEmail === 'all') && !notification.read) {
            notification.read = true;
        }
    });
    
    saveNotifications();
    loadNotifications();
    updateNotificationBadge();
}

// Update notification badge
function updateNotificationBadge() {
    const unreadCount = notifications.filter(n => 
        (n.userEmail === currentUser.email || n.userEmail === 'all') && !n.read
    ).length;
    
    if (notificationsToggle) {
        if (unreadCount > 0) {
            notificationsToggle.classList.add('has-unread');
        } else {
            notificationsToggle.classList.remove('has-unread');
        }
    }
}

// Check for new notifications since last login
function checkNewNotifications() {
    const lastLogin = localStorage.getItem(`lastLogin_${currentUser.email}`);
    if (!lastLogin) return;
    
    const newNotifications = notifications.filter(n => 
        (n.userEmail === currentUser.email || n.userEmail === 'all') && 
        new Date(n.timestamp) > new Date(lastLogin) && 
        !n.read
    );
    
    if (newNotifications.length > 0) {
        // Show a notification about new notifications
        showNotification(`You have ${newNotifications.length} new notification${newNotifications.length > 1 ? 's' : ''}`);
    }
}

// Load revenue data for admin
function loadRevenueData() {
    if (!revenueStats) return;
    
    revenueStats.innerHTML = '';
    
    // Calculate today's revenue
    const today = new Date().toISOString().split('T')[0];
    const todayRevenue = calculateRevenueForDate(today);
    
    // Calculate yesterday's revenue
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayFormatted = yesterday.toISOString().split('T')[0];
    const yesterdayRevenue = calculateRevenueForDate(yesterdayFormatted);
    
    // Calculate this week's revenue
    const weekStart = new Date();
    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
    const weekRevenue = calculateRevenueForPeriod(weekStart, new Date());
    
    // Calculate this month's revenue
    const monthStart = new Date();
    monthStart.setDate(1);
    const monthRevenue = calculateRevenueForPeriod(monthStart, new Date());
    
    // Create revenue cards
    revenueStats.innerHTML = `
        <div class="revenue-card">
            <h3>Today's Revenue</h3>
            <div class="amount">${todayRevenue} MVR</div>
            <div class="period">${formatDate(today)}</div>
        </div>
        <div class="revenue-card">
            <h3>Yesterday's Revenue</h3>
            <div class="amount">${yesterdayRevenue} MVR</div>
            <div class="period">${formatDate(yesterdayFormatted)}</div>
        </div>
        <div class="revenue-card">
            <h3>This Week</h3>
            <div class="amount">${weekRevenue} MVR</div>
            <div class="period">This Week</div>
        </div>
        <div class="revenue-card">
            <h3>This Month</h3>
            <div class="amount">${monthRevenue} MVR</div>
            <div class="period">This Month</div>
        </div>
    `;
}

// Calculate revenue for a specific date
function calculateRevenueForDate(date) {
    let total = 0;
    
    // Add revenue from cargo deliveries
    cargoDeliveries.forEach(delivery => {
        if (delivery.paidAt && delivery.paidAt.startsWith(date) && delivery.paymentStatus === 'paid') {
            total += delivery.deliveryPrice || delivery.totalPrice || 0;
        }
    });
    
    // Add revenue from boat deliveries
    boatDeliveries.forEach(delivery => {
        if (delivery.paidAt && delivery.paidAt.startsWith(date) && delivery.paymentStatus === 'paid') {
            total += delivery.deliveryPrice || delivery.totalPrice || 0;
        }
    });
    
    // Add revenue from Greater Male City deliveries
    greaterMaleDeliveries.forEach(delivery => {
        if (delivery.paidAt && delivery.paidAt.startsWith(date) && delivery.paymentStatus === 'paid') {
            total += delivery.deliveryPrice || delivery.totalPrice || 0;
        }
    });
    
    // Add revenue from area-based deliveries
    areaBasedDeliveries.forEach(delivery => {
        if (delivery.paidAt && delivery.paidAt.startsWith(date) && delivery.paymentStatus === 'paid') {
            total += delivery.deliveryPrice || delivery.totalPrice || 0;
        }
    });
    
    return total;
}

// Calculate revenue for a period
function calculateRevenueForPeriod(startDate, endDate) {
    let total = 0;
    
    // Add revenue from cargo deliveries
    cargoDeliveries.forEach(delivery => {
        if (delivery.paidAt && delivery.paymentStatus === 'paid') {
            const paidDate = new Date(delivery.paidAt);
            if (paidDate >= startDate && paidDate <= endDate) {
                total += delivery.deliveryPrice || delivery.totalPrice || 0;
            }
        }
    });
    
    // Add revenue from boat deliveries
    boatDeliveries.forEach(delivery => {
        if (delivery.paidAt && delivery.paymentStatus === 'paid') {
            const paidDate = new Date(delivery.paidAt);
            if (paidDate >= startDate && paidDate <= endDate) {
                total += delivery.deliveryPrice || delivery.totalPrice || 0;
            }
        }
    });
    
    // Add revenue from Greater Male City deliveries
    greaterMaleDeliveries.forEach(delivery => {
        if (delivery.paidAt && delivery.paymentStatus === 'paid') {
            const paidDate = new Date(delivery.paidAt);
            if (paidDate >= startDate && paidDate <= endDate) {
                total += delivery.deliveryPrice || delivery.totalPrice || 0;
            }
        }
    });
    
    // Add revenue from area-based deliveries
    areaBasedDeliveries.forEach(delivery => {
        if (delivery.paidAt && delivery.paymentStatus === 'paid') {
            const paidDate = new Date(delivery.paidAt);
            if (paidDate >= startDate && paidDate <= endDate) {
                total += delivery.deliveryPrice || delivery.totalPrice || 0;
            }
        }
    });
    
    return total;
}

// Records management tabs
recordsTabs.forEach(tab => {
    tab.addEventListener('click', function() {
        const targetTab = this.getAttribute('data-tab');
        
        // Update active tab
        recordsTabs.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // Show target content
        recordsContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === targetTab) {
                content.classList.add('active');
            }
        });
    });
});

// Load weight options
function loadWeightOptions() {
    if (weightOptions) weightOptions.innerHTML = '';
    if (boatWeightOptions) boatWeightOptions.innerHTML = '';
    
    // Load cargo weight options
    cargoPriceRanges.forEach(range => {
        const option = document.createElement('div');
        option.className = 'weight-option';
        option.innerHTML = `
            <button type="button" class="weight-btn" data-min="${range.min}" data-max="${range.max}" data-price="${range.price}">
                ${range.min}-${range.max} kg
            </button>
        `;
        if (weightOptions) weightOptions.appendChild(option);
    });
    
    // Load boat weight options
    boatPriceRanges.forEach(range => {
        const boatOption = document.createElement('div');
        boatOption.className = 'weight-option';
        boatOption.innerHTML = `
            <button type="button" class="weight-btn" data-min="${range.min}" data-max="${range.max}" data-price="${range.price}">
                ${range.min}-${range.max} kg
            </button>
        `;
        if (boatWeightOptions) boatWeightOptions.appendChild(boatOption);
    });
    
    // Add event listeners to weight buttons
    document.querySelectorAll('.weight-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all buttons in the same container
            this.parentElement.parentElement.querySelectorAll('.weight-btn').forEach(b => {
                b.classList.remove('active');
            });
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Update price display
            const price = this.getAttribute('data-price');
            const container = this.closest('.form-container');
            if (container) {
                const priceDisplay = container.querySelector('.price-display .price-value span:last-child');
                if (priceDisplay) priceDisplay.textContent = price;
            }
        });
    });
}

// Show/hide location-specific fields based on pickup location selection
if (pickupLocation) {
    pickupLocation.addEventListener('change', function() {
        const selectedLocation = this.value;
        
        // Hide all location-specific fields
        if (packageDetailsField) packageDetailsField.classList.remove('active');
        if (addressField) addressField.classList.remove('active');
        
        // Show appropriate field based on selection
        if (selectedLocation === 'Post Office' || selectedLocation === 'Pickpost' || selectedLocation === 'Redbox') {
            if (packageDetailsField) packageDetailsField.classList.add('active');
        } else if (selectedLocation === 'Male' || selectedLocation === 'Hulhumale' || selectedLocation === 'Phase2') {
            if (addressField) addressField.classList.add('active');
        }
    });
}

// Cargo form submission
if (cargoForm) {
    cargoForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const selectedWeight = weightOptions ? weightOptions.querySelector('.weight-btn.active') : null;
        if (!selectedWeight) {
            showNotification('Please select a weight range');
            return;
        }
        
        const referenceNumber = generateReferenceNumber('CARGO');
        
        const cargoData = {
            customerName: document.getElementById('customerName').value,
            customerContact: document.getElementById('customerContact').value,
            pickupLocation: document.getElementById('pickupLocation').value,
            packageDetails: document.getElementById('packageDetails').value,
            addressName: document.getElementById('addressName').value,
            deliveryLocation: document.getElementById('deliveryLocation').value,
            packageWeight: `${selectedWeight.getAttribute('data-min')}-${selectedWeight.getAttribute('data-max')} kg`,
            weightMin: parseInt(selectedWeight.getAttribute('data-min')),
            weightMax: parseInt(selectedWeight.getAttribute('data-max')),
            deliveryPrice: parseInt(selectedWeight.getAttribute('data-price')),
            deliveryDate: document.getElementById('deliveryDate').value,
            status: 'Order Placed',
            progress: 1,
            id: Date.now(), // Simple ID generation
            referenceNumber: referenceNumber,
            type: 'cargo',
            createdAt: new Date().toISOString(),
            paymentStatus: 'under_review', // Changed from 'pending' to 'under_review'
            createdBy: currentUser.email
        };
        
        // Show payment modal
        showPaymentModal(cargoData);
    });
}

// Boat form submission
if (boatForm) {
    boatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const selectedWeight = boatWeightOptions ? boatWeightOptions.querySelector('.weight-btn.active') : null;
        if (!selectedWeight) {
            showNotification('Please select a weight range');
            return;
        }
        
        const referenceNumber = generateReferenceNumber('BOAT');
        
        const boatData = {
            customerName: document.getElementById('boatCustomerName').value,
            customerContact: document.getElementById('boatCustomerContact').value,
            pickupMessage: document.getElementById('pickupMessage').value,
            boatName: document.getElementById('boatName').value,
            island: document.getElementById('island').value,
            packageLabel: document.getElementById('packageLabel').value,
            packageWeight: `${selectedWeight.getAttribute('data-min')}-${selectedWeight.getAttribute('data-max')} kg`,
            weightMin: parseInt(selectedWeight.getAttribute('data-min')),
            weightMax: parseInt(selectedWeight.getAttribute('data-max')),
            deliveryPrice: parseInt(selectedWeight.getAttribute('data-price')),
            deliveryDate: document.getElementById('boatDeliveryDate').value,
            status: 'Order Placed',
            progress: 1,
            id: Date.now(), // Simple ID generation
            referenceNumber: referenceNumber,
            type: 'boat',
            createdAt: new Date().toISOString(),
            paymentStatus: 'under_review', // Changed from 'pending' to 'under_review'
            createdBy: currentUser.email
        };
        
        // Show payment modal
        showPaymentModal(boatData);
    });
}

// Generate reference number
function generateReferenceNumber(prefix) {
    const timestamp = Date.now().toString().slice(-6);
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `${prefix}-${timestamp}${random}`;
}

// Show payment modal
function showPaymentModal(deliveryData) {
    if (paymentAmount) paymentAmount.textContent = deliveryData.deliveryPrice || deliveryData.totalPrice;
    if (paymentModal) paymentModal.classList.add('active');
    
    // Store delivery data temporarily
    window.tempDeliveryData = deliveryData;
}

// Copy account number
if (copyAccountBtn) {
    copyAccountBtn.addEventListener('click', function() {
        const accountNumberText = accountNumber ? accountNumber.textContent : '';
        navigator.clipboard.writeText(accountNumberText).then(() => {
            showNotification('Account number copied to clipboard');
        }).catch(err => {
            console.error('Failed to copy: ', err);
            showNotification('Failed to copy account number');
        });
    });
}

// Cancel payment
if (cancelPayment) {
    cancelPayment.addEventListener('click', function() {
        if (paymentModal) paymentModal.classList.remove('active');
        if (paymentSlip) paymentSlip.value = '';
        window.tempDeliveryData = null;
    });
}

// Confirm payment
if (confirmPayment) {
    confirmPayment.addEventListener('click', function() {
        if (!paymentSlip || !paymentSlip.files[0]) {
            showNotification('Please upload payment slip');
            return;
        }
        
        const deliveryData = window.tempDeliveryData;
        if (!deliveryData) return;
        
        // Read payment slip
        const reader = new FileReader();
        reader.onload = function(e) {
            deliveryData.paymentSlip = e.target.result;
            deliveryData.paymentStatus = 'under_review';
            deliveryData.paidAt = new Date().toISOString();
            
            // Save delivery based on type
            if (deliveryData.type === 'cargo') {
                saveCargoDelivery(deliveryData);
            } else if (deliveryData.type === 'boat') {
                saveBoatDelivery(deliveryData);
            } else if (deliveryData.type === 'greater-male') {
                saveGreaterMaleDelivery(deliveryData);
            } else if (deliveryData.type === 'area') {
                saveAreaBasedDelivery(deliveryData);
            }
            
            // Reset and close modal
            if (paymentModal) paymentModal.classList.remove('active');
            if (paymentSlip) paymentSlip.value = '';
            window.tempDeliveryData = null;
        };
        reader.readAsDataURL(paymentSlip.files[0]);
    });
}

// Save cargo delivery
function saveCargoDelivery(cargoData) {
    cargoDeliveries.push(cargoData);
    saveCargoData();
    loadCargoData();
    loadUserReferences();
    if (cargoForm) cargoForm.reset();
    resetWeightSelection();
    
    // Auto-fill user info again after form reset
    autoFillUserInfo();
    
    // Add notification
    addNotification(
        'New Cargo Delivery Created',
        `Cargo delivery for ${cargoData.customerName} has been created and is awaiting payment approval. Reference: ${cargoData.referenceNumber}`,
        currentUser.email
    );
    
    // Show success notification
    showNotification('Cargo delivery saved successfully! Payment is under review.');
}

// Save boat delivery
function saveBoatDelivery(boatData) {
    boatDeliveries.push(boatData);
    saveBoatData();
    loadBoatData();
    loadUserReferences();
    if (boatForm) boatForm.reset();
    resetWeightSelection();
    
    // Auto-fill user info again after form reset
    autoFillUserInfo();
    
    // Add notification
    addNotification(
        'New Boat Delivery Created',
        `Boat delivery for ${boatData.customerName} has been created and is awaiting payment approval. Reference: ${boatData.referenceNumber}`,
        currentUser.email
    );
    
    // Show success notification
    showNotification('Boat delivery saved successfully! Payment is under review.');
}

// Save Greater Male City delivery
function saveGreaterMaleDelivery(greaterMaleData) {
    greaterMaleDeliveries.push(greaterMaleData);
    saveGreaterMaleData();
    loadGreaterMaleData();
    loadUserReferences();
    if (greaterMaleForm) greaterMaleForm.reset();
    resetGreaterMaleForm();
    
    // Auto-fill user info again after form reset
    autoFillUserInfo();
    
    // Add notification
    addNotification(
        'New Greater Male City Delivery Created',
        `Greater Male City delivery for ${greaterMaleData.customerName} has been created and is awaiting payment approval. Reference: ${greaterMaleData.referenceNumber}`,
        currentUser.email
    );
    
    // Show success notification
    showNotification('Greater Male City delivery saved successfully! Payment is under review.');
}

// Reset Greater Male City form
function resetGreaterMaleForm() {
    // Reset all selections
    document.querySelectorAll('.item-size-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.vehicle-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.destination-btn').forEach(btn => btn.classList.remove('active'));
    
    // Reset quantity
    if (itemQuantity) itemQuantity.value = 1;
    
    // Reset additional fields
    if (greaterMaleAddressName) greaterMaleAddressName.value = '';
    if (greaterMalePackageDetails) greaterMalePackageDetails.value = '';
    if (boatNameInput) boatNameInput.value = '';
    if (destinationAddressName) destinationAddressName.value = '';
    
    // Hide additional fields
    if (greaterMaleAddressField) greaterMaleAddressField.style.display = 'none';
    if (greaterMalePackageDetailsField) greaterMalePackageDetailsField.style.display = 'none';
    if (boatNameField) boatNameField.style.display = 'none';
    if (destinationAddressField) destinationAddressField.style.display = 'none';
    
    // Reset price breakdown
    updateGreaterMalePrice();
    
    // Reset map if enabled
    if (enableMap && enableMap.checked) {
        if (clearMap) clearMap.click();
        if (mapPricingInfo) mapPricingInfo.style.display = 'none';
    }
}

// Reset weight selection
function resetWeightSelection() {
    document.querySelectorAll('.weight-btn.active').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.price-value span:last-child').forEach(span => {
        span.textContent = '0';
    });
}

// Load cargo data into table
function loadCargoData() {
    if (!cargoTableBody) return;
    
    cargoTableBody.innerHTML = '';
    
    // Filter data based on user role
    let displayCargoDeliveries = cargoDeliveries;
    if (currentUser.role !== 'admin') {
        displayCargoDeliveries = cargoDeliveries.filter(d => d.createdBy === currentUser.email);
    }
    
    if (displayCargoDeliveries.length === 0) {
        if (cargoEmptyMessage) cargoEmptyMessage.style.display = 'block';
        return;
    }
    
    if (cargoEmptyMessage) cargoEmptyMessage.style.display = 'none';
    
    displayCargoDeliveries.forEach(delivery => {
        const statusClass = getStatusClass(delivery.status);
        const paymentClass = getPaymentStatusClass(delivery.paymentStatus);
        const paymentText = getPaymentStatusText(delivery.paymentStatus);
        
        // Create location link for easy navigation
        let locationLink = '';
        if (delivery.pickupLocation && delivery.addressName) {
            const locationQuery = encodeURIComponent(`${delivery.pickupLocation} ${delivery.addressName}`);
            locationLink = `<a href="https://www.google.com/maps/search/?api=1&query=${locationQuery}" target="_blank" class="location-link">View Location</a>`;
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <a class="reference-link ${delivery.status === 'Delivered' ? 'reference-completed' : 'reference-pending'}" onclick="trackDeliveryByReference('${delivery.referenceNumber}')">
                    ${delivery.referenceNumber}
                </a>
            </td>
            <td>${delivery.customerName}</td>
            <td>${delivery.customerContact}</td>
            <td>${delivery.pickupLocation}${delivery.packageDetails ? ` (${delivery.packageDetails})` : delivery.addressName ? ` (${delivery.addressName})` : ''} ${locationLink}</td>
            <td>${delivery.deliveryLocation}</td>
            <td>${delivery.packageWeight}</td>
            <td>${delivery.deliveryPrice} MVR</td>
            <td>${formatDate(delivery.deliveryDate)}</td>
            <td>
                <div class="countdown-timer" id="countdown-${delivery.id}">
                    <div class="countdown-label">Time Remaining</div>
                    <div class="countdown-display">
                        <div class="countdown-unit">
                            <span class="countdown-value" id="days-${delivery.id}">00</span>
                            <span class="countdown-label-small">Days</span>
                        </div>
                        <div class="countdown-unit">
                            <span class="countdown-value" id="hours-${delivery.id}">00</span>
                            <span class="countdown-label-small">Hours</span>
                        </div>
                        <div class="countdown-unit">
                            <span class="countdown-value" id="minutes-${delivery.id}">00</span>
                            <span class="countdown-label-small">Minutes</span>
                        </div>
                    </div>
                </div>
            </td>
            <td>
                <span class="status-badge ${statusClass}">${delivery.status}</span>
            </td>
            <td>
                <span class="status-badge ${paymentClass}">${paymentText}</span>
                ${delivery.paymentSlip ? `<br><button class="action-btn view-btn" onclick="viewPaymentSlip('${delivery.paymentSlip}')">View Slip</button>` : ''}
            </td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn update-btn" onclick="openStatusModal('cargo', ${delivery.id})">Update</button>
                    ${currentUser.role === 'admin' && delivery.paymentStatus === 'under_review' ? 
                        `<button class="action-btn review-btn" onclick="approvePayment('cargo', ${delivery.id})">Approve</button>` : ''}
                    <button class="action-btn delete-btn" onclick="deleteDelivery('cargo', ${delivery.id})">Delete</button>
                </div>
            </td>
        `;
        cargoTableBody.appendChild(row);
        
        // Start countdown timer for this delivery
        startCountdownTimer(delivery.id, delivery.deliveryDate);
    });
}

// Load boat data into table
function loadBoatData() {
    if (!boatTableBody) return;
    
    boatTableBody.innerHTML = '';
    
    // Filter data based on user role
    let displayBoatDeliveries = boatDeliveries;
    if (currentUser.role !== 'admin') {
        displayBoatDeliveries = boatDeliveries.filter(d => d.createdBy === currentUser.email);
    }
    
    if (displayBoatDeliveries.length === 0) {
        if (boatEmptyMessage) boatEmptyMessage.style.display = 'block';
        return;
    }
    
    if (boatEmptyMessage) boatEmptyMessage.style.display = 'none';
    
    displayBoatDeliveries.forEach(delivery => {
        const statusClass = getStatusClass(delivery.status);
        const paymentClass = getPaymentStatusClass(delivery.paymentStatus);
        const paymentText = getPaymentStatusText(delivery.paymentStatus);
        
        // Create location link for boat deliveries
        let locationLink = '';
        if (delivery.island) {
            const locationQuery = encodeURIComponent(`${delivery.island}`);
            locationLink = `<a href="https://www.google.com/maps/search/?api=1&query=${locationQuery}" target="_blank" class="location-link">View Island</a>`;
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <a class="reference-link ${delivery.status === 'Delivered' ? 'reference-completed' : 'reference-pending'}" onclick="trackDeliveryByReference('${delivery.referenceNumber}')">
                    ${delivery.referenceNumber}
                </a>
            </td>
            <td>${delivery.customerName}</td>
            <td>${delivery.customerContact}</td>
            <td>${delivery.boatName}</td>
            <td>${delivery.island} ${locationLink}</td>
            <td>${delivery.packageLabel}</td>
            <td>${delivery.packageWeight}</td>
            <td>${delivery.deliveryPrice} MVR</td>
            <td>${formatDate(delivery.deliveryDate)}</td>
            <td>
                <div class="countdown-timer" id="countdown-${delivery.id}">
                    <div class="countdown-label">Time Remaining</div>
                    <div class="countdown-display">
                        <div class="countdown-unit">
                            <span class="countdown-value" id="days-${delivery.id}">00</span>
                            <span class="countdown-label-small">Days</span>
                        </div>
                        <div class="countdown-unit">
                            <span class="countdown-value" id="hours-${delivery.id}">00</span>
                            <span class="countdown-label-small">Hours</span>
                        </div>
                        <div class="countdown-unit">
                            <span class="countdown-value" id="minutes-${delivery.id}">00</span>
                            <span class="countdown-label-small">Minutes</span>
                        </div>
                    </div>
                </div>
            </td>
            <td>
                <span class="status-badge ${statusClass}">${delivery.status}</span>
            </td>
            <td>
                <span class="status-badge ${paymentClass}">${paymentText}</span>
                ${delivery.paymentSlip ? `<br><button class="action-btn view-btn" onclick="viewPaymentSlip('${delivery.paymentSlip}')">View Slip</button>` : ''}
            </td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn update-btn" onclick="openStatusModal('boat', ${delivery.id})">Update</button>
                    ${currentUser.role === 'admin' && delivery.paymentStatus === 'under_review' ? 
                        `<button class="action-btn review-btn" onclick="approvePayment('boat', ${delivery.id})">Approve</button>` : ''}
                    <button class="action-btn delete-btn" onclick="deleteDelivery('boat', ${delivery.id})">Delete</button>
                </div>
            </td>
        `;
        boatTableBody.appendChild(row);
        
        // Start countdown timer for this delivery
        startCountdownTimer(delivery.id, delivery.deliveryDate);
    });
}

// Load Greater Male City data into table
function loadGreaterMaleData() {
    if (!greaterMaleTableBody) return;
    
    greaterMaleTableBody.innerHTML = '';
    
    // Filter data based on user role
    let displayGreaterMaleDeliveries = greaterMaleDeliveries;
    if (currentUser.role !== 'admin') {
        displayGreaterMaleDeliveries = greaterMaleDeliveries.filter(d => d.createdBy === currentUser.email);
    }
    
    if (displayGreaterMaleDeliveries.length === 0) {
        if (greaterMaleEmptyMessage) greaterMaleEmptyMessage.style.display = 'block';
        return;
    }
    
    if (greaterMaleEmptyMessage) greaterMaleEmptyMessage.style.display = 'none';
    
    displayGreaterMaleDeliveries.forEach(delivery => {
        const statusClass = getStatusClass(delivery.status);
        const paymentClass = getPaymentStatusClass(delivery.paymentStatus);
        const paymentText = getPaymentStatusText(delivery.paymentStatus);
        
        // Create location link for map-based deliveries
        let locationLink = '';
        if (delivery.pickupLatitude && delivery.pickupLongitude && 
            delivery.destinationLatitude && delivery.destinationLongitude) {
            const mapUrl = `https://www.google.com/maps/dir/${delivery.pickupLatitude},${delivery.pickupLongitude}/${delivery.destinationLatitude},${delivery.destinationLongitude}`;
            locationLink = `<a href="${mapUrl}" target="_blank" class="records-location-link">View Route</a>`;
        } else if (delivery.pickupLocation && delivery.addressName) {
            // For manual entries, create a simple location search
            const locationQuery = encodeURIComponent(`${delivery.pickupLocation} ${delivery.addressName}`);
            locationLink = `<a href="https://www.google.com/maps/search/?api=1&query=${locationQuery}" target="_blank" class="records-location-link">View Location</a>`;
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <a class="reference-link ${delivery.status === 'Delivered' ? 'reference-completed' : 'reference-pending'}" onclick="trackDeliveryByReference('${delivery.referenceNumber}')">
                    ${delivery.referenceNumber}
                </a>
            </td>
            <td>${delivery.customerName}</td>
            <td>${delivery.customerContact}</td>
            <td>${delivery.pickupLocation}${delivery.addressName ? ` (${delivery.addressName})` : delivery.packageDetails ? ` (${delivery.packageDetails})` : ''} ${locationLink}</td>
            <td>${delivery.itemSizeDisplay}</td>
            <td>${delivery.quantity}</td>
            <td>${delivery.vehicleDisplay}</td>
            <td>${delivery.destination}${delivery.boatName ? ` (${delivery.boatName})` : delivery.destinationAddress ? ` (${delivery.destinationAddress})` : ''}</td>
            <td>${delivery.totalPrice} MVR</td>
            <td>
                <span class="status-badge ${statusClass}">${delivery.status}</span>
            </td>
            <td>
                <span class="status-badge ${paymentClass}">${paymentText}</span>
                ${delivery.paymentSlip ? `<br><button class="action-btn view-btn" onclick="viewPaymentSlip('${delivery.paymentSlip}')">View Slip</button>` : ''}
            </td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn update-btn" onclick="openStatusModal('greater-male', ${delivery.id})">Update</button>
                    ${currentUser.role === 'admin' && delivery.paymentStatus === 'under_review' ? 
                        `<button class="action-btn review-btn" onclick="approvePayment('greater-male', ${delivery.id})">Approve</button>` : ''}
                    <button class="action-btn delete-btn" onclick="deleteDelivery('greater-male', ${delivery.id})">Delete</button>
                </div>
            </td>
        `;
        greaterMaleTableBody.appendChild(row);
    });
}

// Start countdown timer for a delivery
function startCountdownTimer(id, deliveryDate) {
    function updateCountdown() {
        const now = new Date().getTime();
        const deliveryTime = new Date(deliveryDate).getTime();
        const timeRemaining = deliveryTime - now;
        
        if (timeRemaining < 0) {
            // Delivery time has passed
            const daysElement = document.getElementById(`days-${id}`);
            const hoursElement = document.getElementById(`hours-${id}`);
            const minutesElement = document.getElementById(`minutes-${id}`);
            
            if (daysElement) daysElement.textContent = '00';
            if (hoursElement) hoursElement.textContent = '00';
            if (minutesElement) minutesElement.textContent = '00';
            return;
        }
        
        // Calculate days, hours, minutes
        const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
        
        // Update display
        const daysElement = document.getElementById(`days-${id}`);
        const hoursElement = document.getElementById(`hours-${id}`);
        const minutesElement = document.getElementById(`minutes-${id}`);
        
        if (daysElement) daysElement.textContent = days.toString().padStart(2, '0');
        if (hoursElement) hoursElement.textContent = hours.toString().padStart(2, '0');
        if (minutesElement) minutesElement.textContent = minutes.toString().padStart(2, '0');
    }
    
    // Update immediately and then every minute
    updateCountdown();
    setInterval(updateCountdown, 60000);
}

// IMPROVED TRACKING SYSTEM - Search customer by contact number
if (searchBtn) {
    searchBtn.addEventListener('click', function() {
        const contact = document.getElementById('searchContact').value.trim();
        
        if (!contact) {
            showNotification('Please enter a contact number');
            return;
        }
        
        // Search in all deliveries
        const customerCargoDeliveries = cargoDeliveries.filter(d => d.customerContact === contact);
        const customerBoatDeliveries = boatDeliveries.filter(d => d.customerContact === contact);
        const customerGreaterMaleDeliveries = greaterMaleDeliveries.filter(d => d.customerContact === contact);
        const customerAreaBasedDeliveries = areaBasedDeliveries.filter(d => d.customerContact === contact);
        
        const allCustomerDeliveries = [
            ...customerCargoDeliveries,
            ...customerBoatDeliveries,
            ...customerGreaterMaleDeliveries,
            ...customerAreaBasedDeliveries
        ];
        
        if (allCustomerDeliveries.length === 0) {
            showNotification('No delivery found for this contact number');
            if (customerDetails) customerDetails.classList.remove('active');
            if (customerReferences) customerReferences.classList.remove('active');
            return;
        }
        
        // Display all customer references
        displayCustomerReferences(allCustomerDeliveries);
        
        // Show the first delivery by default
        if (allCustomerDeliveries.length > 0) {
            currentDelivery = allCustomerDeliveries[0];
            displayCustomerDetails(currentDelivery);
            updateProgressTracker(currentDelivery.progress);
            if (customerDetails) customerDetails.classList.add('active');
        }
    });
}

// Display all customer references
function displayCustomerReferences(deliveries) {
    if (!referenceList) return;
    
    referenceList.innerHTML = '';
    
    if (deliveries.length === 0) {
        if (customerReferences) customerReferences.classList.remove('active');
        return;
    }
    
    // Sort deliveries by creation date (newest first)
    deliveries.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    deliveries.forEach(delivery => {
        const referenceCard = document.createElement('div');
        referenceCard.className = 'reference-card';
        
        let typeText = '';
        if (delivery.type === 'cargo') typeText = 'Cargo';
        else if (delivery.type === 'boat') typeText = 'Boat';
        else if (delivery.type === 'greater-male') typeText = 'Greater Male';
        else if (delivery.type === 'area') typeText = 'Area-Based';
        
        referenceCard.innerHTML = `
            <div class="reference-card-header">
                <div class="reference-number">${delivery.referenceNumber}</div>
                <div class="reference-card-type">${typeText}</div>
            </div>
            <div class="reference-card-details">
                <div><strong>Status:</strong> ${delivery.status}</div>
                <div><strong>Price:</strong> ${delivery.deliveryPrice || delivery.totalPrice} MVR</div>
            </div>
            <div class="reference-card-date">Created: ${formatDate(delivery.createdAt)}</div>
        `;
        
        // Add click event to select this delivery
        referenceCard.addEventListener('click', function() {
            currentDelivery = delivery;
            displayCustomerDetails(delivery);
            updateProgressTracker(delivery.progress);
            
            // Highlight selected card
            document.querySelectorAll('.reference-card').forEach(card => {
                card.style.border = '1px solid #e0e0e0';
            });
            this.style.border = '2px solid #4cc9f0';
        });
        
        referenceList.appendChild(referenceCard);
    });
    
    if (customerReferences) customerReferences.classList.add('active');
}

// Track delivery by reference number
function trackDeliveryByReference(referenceNumber) {
    // Search in cargo deliveries
    let delivery = cargoDeliveries.find(d => d.referenceNumber === referenceNumber);
    
    // If not found in cargo, search in boat deliveries
    if (!delivery) {
        delivery = boatDeliveries.find(d => d.referenceNumber === referenceNumber);
    }
    
    // If not found in boat, search in Greater Male City deliveries
    if (!delivery) {
        delivery = greaterMaleDeliveries.find(d => d.referenceNumber === referenceNumber);
    }
    
    // If not found in Greater Male City, search in area-based deliveries
    if (!delivery) {
        delivery = areaBasedDeliveries.find(d => d.referenceNumber === referenceNumber);
    }
    
    if (delivery) {
        // Switch to track delivery section
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        const trackDeliveryLink = document.querySelector('[data-section="track-delivery"]');
        if (trackDeliveryLink) {
            trackDeliveryLink.classList.add('active');
        }
        
        dashboardSections.forEach(section => {
            section.classList.remove('active');
            if (section.id === 'track-delivery') {
                section.classList.add('active');
            }
        });
        
        // Set search contact and trigger search
        const searchContact = document.getElementById('searchContact');
        if (searchContact) {
            searchContact.value = delivery.customerContact;
            if (searchBtn) searchBtn.click();
        }
    } else {
        showNotification('Delivery not found with this reference number');
    }
}

// Approve payment
function approvePayment(type, id) {
    if (confirm('Are you sure you want to approve this payment?')) {
        let delivery;
        if (type === 'cargo') {
            delivery = cargoDeliveries.find(d => d.id === id);
        } else if (type === 'boat') {
            delivery = boatDeliveries.find(d => d.id === id);
        } else if (type === 'greater-male') {
            delivery = greaterMaleDeliveries.find(d => d.id === id);
        } else if (type === 'area') {
            delivery = areaBasedDeliveries.find(d => d.id === id);
        }
        
        if (delivery) {
            delivery.paymentStatus = 'paid';
            saveUpdatedData(type);
            
            // Add notification for the user who created the delivery
            addNotification(
                'Payment Approved',
                `Payment for your ${type} delivery to ${delivery.customerName} has been approved. Reference: ${delivery.referenceNumber}`,
                delivery.createdBy
            );
            
            showNotification('Payment approved successfully');
        }
    }
}

// View payment slip
function viewPaymentSlip(slipData) {
    if (slipImage) {
        slipImage.src = slipData;
        if (slipModal) slipModal.classList.add('active');
    }
}

// Close slip modal
if (closeSlip) {
    closeSlip.addEventListener('click', function() {
        if (slipModal) slipModal.classList.remove('active');
    });
}

// Get status class for styling
function getStatusClass(status) {
    switch(status) {
        case 'Order Placed': return 'status-placed';
        case 'Processing': return 'status-processing';
        case 'In Transit': return 'status-transit';
        case 'Out for Delivery': return 'status-out';
        case 'Delivered': return 'status-delivered';
        default: return 'status-placed';
    }
}

// Get payment status class for styling
function getPaymentStatusClass(paymentStatus) {
    switch(paymentStatus) {
        case 'pending': return 'status-pending';
        case 'under_review': return 'status-under-review';
        case 'paid': return 'status-paid';
        default: return 'status-pending';
    }
}

// Get payment status text
function getPaymentStatusText(paymentStatus) {
    switch(paymentStatus) {
        case 'pending': return 'Pending';
        case 'under_review': return 'Under Review';
        case 'paid': return 'Paid';
        default: return 'Pending';
    }
}

// Open status update modal
function openStatusModal(type, id) {
    currentDeliveryType = type;
    currentDeliveryId = id;
    
    let delivery;
    if (type === 'cargo') {
        delivery = cargoDeliveries.find(d => d.id === id);
    } else if (type === 'boat') {
        delivery = boatDeliveries.find(d => d.id === id);
    } else if (type === 'greater-male') {
        delivery = greaterMaleDeliveries.find(d => d.id === id);
    } else if (type === 'area') {
        delivery = areaBasedDeliveries.find(d => d.id === id);
    }
    
    if (!delivery) return;
    
    // Set current status in dropdown
    if (statusSelect) statusSelect.value = delivery.status;
    
    // Show/hide proof upload based on selected status
    toggleProofUpload();
    
    // Show modal
    if (statusModal) statusModal.classList.add('active');
}

// Toggle proof upload visibility
function toggleProofUpload() {
    if (proofUploadContainer && statusSelect) {
        if (statusSelect.value === 'Delivered') {
            proofUploadContainer.style.display = 'block';
        } else {
            proofUploadContainer.style.display = 'none';
        }
    }
}

// Status select change listener
if (statusSelect) {
    statusSelect.addEventListener('change', toggleProofUpload);
}

// Cancel status update
if (cancelStatus) {
    cancelStatus.addEventListener('click', function() {
        if (statusModal) statusModal.classList.remove('active');
        currentDeliveryType = null;
        currentDeliveryId = null;
        if (proofImage) proofImage.value = '';
    });
}

// Confirm status update
if (confirmStatus) {
    confirmStatus.addEventListener('click', function() {
        const newStatus = statusSelect ? statusSelect.value : '';
        const requiresProof = newStatus === 'Delivered';
        
        if (requiresProof && (!proofImage || !proofImage.files[0])) {
            showNotification('Proof image is required for completed deliveries');
            return;
        }
        
        let delivery;
        if (currentDeliveryType === 'cargo') {
            delivery = cargoDeliveries.find(d => d.id === currentDeliveryId);
        } else if (currentDeliveryType === 'boat') {
            delivery = boatDeliveries.find(d => d.id === currentDeliveryId);
        } else if (currentDeliveryType === 'greater-male') {
            delivery = greaterMaleDeliveries.find(d => d.id === currentDeliveryId);
        } else if (currentDeliveryType === 'area') {
            delivery = areaBasedDeliveries.find(d => d.id === currentDeliveryId);
        }
        
        if (!delivery) return;
        
        const oldStatus = delivery.status;
        
        // Update delivery status
        delivery.status = newStatus;
        
        // Map status to progress value
        const statusProgressMap = {
            'Order Placed': 1,
            'Processing': 2,
            'In Transit': 3,
            'Out for Delivery': 4,
            'Delivered': 5
        };
        
        delivery.progress = statusProgressMap[newStatus];
        
        // Handle proof image if provided
        if (requiresProof && proofImage && proofImage.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                delivery.deliveryImage = e.target.result;
                delivery.completedAt = new Date().toISOString();
                
                // Save the updated data
                saveUpdatedData(currentDeliveryType);
                
                // Close the modal
                if (statusModal) statusModal.classList.remove('active');
                
                // Reset modal state
                currentDeliveryType = null;
                currentDeliveryId = null;
                if (proofImage) proofImage.value = '';
                
                // Show success notification
                showNotification('Delivery status updated successfully!');
                
                // Add notification for the user who created the delivery
                if (delivery.createdBy !== currentUser.email) {
                    addNotification(
                        'Delivery Status Updated',
                        `Your ${delivery.type} delivery for ${delivery.customerName} has been updated from ${oldStatus} to ${newStatus}. Reference: ${delivery.referenceNumber}`,
                        delivery.createdBy
                    );
                }
                
                // Reload user references to update colors
                loadUserReferences();
            };
            reader.readAsDataURL(proofImage.files[0]);
        } else {
            if (newStatus === 'Delivered') {
                delivery.completedAt = new Date().toISOString();
            }
            
            // Save the updated data
            saveUpdatedData(currentDeliveryType);
            
            // Close the modal
            if (statusModal) statusModal.classList.remove('active');
            
            // Reset modal state
            currentDeliveryType = null;
            currentDeliveryId = null;
            if (proofImage) proofImage.value = '';
            
            // Show success notification
            showNotification('Delivery status updated successfully!');
            
            // Add notification for the user who created the delivery
            if (delivery.createdBy !== currentUser.email) {
                addNotification(
                    'Delivery Status Updated',
                    `Your ${delivery.type} delivery for ${delivery.customerName} has been updated from ${oldStatus} to ${newStatus}. Reference: ${delivery.referenceNumber}`,
                    delivery.createdBy
                );
            }
            
            // Reload user references to update colors
            loadUserReferences();
        }
    });
}

// Display customer details
function displayCustomerDetails(delivery) {
    if (!customerInfo) return;
    
    let detailsHTML = '';
    
    if (delivery.type === 'cargo') {
        detailsHTML = `
            <div class="info-item">
                <div class="info-label">Reference Number</div>
                <div class="info-value">${delivery.referenceNumber}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Customer Name</div>
                <div class="info-value">${delivery.customerName}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Contact</div>
                <div class="info-value">${delivery.customerContact}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Pickup Location</div>
                <div class="info-value">${delivery.pickupLocation}${delivery.packageDetails ? ` (${delivery.packageDetails})` : delivery.addressName ? ` (${delivery.addressName})` : ''}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Delivery Location</div>
                <div class="info-value">${delivery.deliveryLocation}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Weight</div>
                <div class="info-value">${delivery.packageWeight}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Price</div>
                <div class="info-value">${delivery.deliveryPrice} MVR</div>
            </div>
            <div class="info-item">
                <div class="info-label">Expected Delivery</div>
                <div class="info-value">${formatDate(delivery.deliveryDate)}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Current Status</div>
                <div class="info-value"><span class="status-badge ${getStatusClass(delivery.status)}">${delivery.status}</span></div>
            </div>
            <div class="info-item">
                <div class="info-label">Payment Status</div>
                <div class="info-value"><span class="status-badge ${getPaymentStatusClass(delivery.paymentStatus)}">${getPaymentStatusText(delivery.paymentStatus)}</span></div>
            </div>
        `;
    } else if (delivery.type === 'boat') {
        detailsHTML = `
            <div class="info-item">
                <div class="info-label">Reference Number</div>
                <div class="info-value">${delivery.referenceNumber}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Customer Name</div>
                <div class="info-value">${delivery.customerName}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Contact</div>
                <div class="info-value">${delivery.customerContact}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Pickup Message</div>
                <div class="info-value">${delivery.pickupMessage}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Boat Name</div>
                <div class="info-value">${delivery.boatName}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Island</div>
                <div class="info-value">${delivery.island}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Package Label</div>
                <div class="info-value">${delivery.packageLabel}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Weight</div>
                <div class="info-value">${delivery.packageWeight}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Price</div>
                <div class="info-value">${delivery.deliveryPrice} MVR</div>
            </div>
            <div class="info-item">
                <div class="info-label">Expected Delivery</div>
                <div class="info-value">${formatDate(delivery.deliveryDate)}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Current Status</div>
                <div class="info-value"><span class="status-badge ${getStatusClass(delivery.status)}">${delivery.status}</span></div>
            </div>
            <div class="info-item">
                <div class="info-label">Payment Status</div>
                <div class="info-value"><span class="status-badge ${getPaymentStatusClass(delivery.paymentStatus)}">${getPaymentStatusText(delivery.paymentStatus)}</span></div>
            </div>
        `;
    } else if (delivery.type === 'greater-male') {
        // Create location link for map-based deliveries
        let locationLink = '';
        if (delivery.pickupLatitude && delivery.pickupLongitude && 
            delivery.destinationLatitude && delivery.destinationLongitude) {
            const mapUrl = `https://www.google.com/maps/dir/${delivery.pickupLatitude},${delivery.pickupLongitude}/${delivery.destinationLatitude},${delivery.destinationLongitude}`;
            locationLink = `<a href="${mapUrl}" target="_blank" class="location-link">View Route on Google Maps</a>`;
        }
        
        detailsHTML = `
            <div class="info-item">
                <div class="info-label">Reference Number</div>
                <div class="info-value">${delivery.referenceNumber}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Customer Name</div>
                <div class="info-value">${delivery.customerName}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Contact</div>
                <div class="info-value">${delivery.customerContact}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Pickup Location</div>
                <div class="info-value">${delivery.pickupLocation}${delivery.addressName ? ` (${delivery.addressName})` : delivery.packageDetails ? ` (${delivery.packageDetails})` : ''} ${locationLink}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Item Size</div>
                <div class="info-value">${delivery.itemSizeDisplay}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Quantity</div>
                <div class="info-value">${delivery.quantity}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Vehicle</div>
                <div class="info-value">${delivery.vehicleDisplay}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Destination</div>
                <div class="info-value">${delivery.destination}${delivery.boatName ? ` (${delivery.boatName})` : delivery.destinationAddress ? ` (${delivery.destinationAddress})` : ''}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Price</div>
                <div class="info-value">${delivery.totalPrice} MVR</div>
            </div>
            <div class="info-item">
                <div class="info-label">Current Status</div>
                <div class="info-value"><span class="status-badge ${getStatusClass(delivery.status)}">${delivery.status}</span></div>
            </div>
            <div class="info-item">
                <div class="info-label">Payment Status</div>
                <div class="info-value"><span class="status-badge ${getPaymentStatusClass(delivery.paymentStatus)}">${getPaymentStatusText(delivery.paymentStatus)}</span></div>
            </div>
        `;
    } else if (delivery.type === 'area') {
        detailsHTML = `
            <div class="info-item">
                <div class="info-label">Reference Number</div>
                <div class="info-value">${delivery.referenceNumber}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Customer Name</div>
                <div class="info-value">${delivery.customerName}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Contact</div>
                <div class="info-value">${delivery.customerContact}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Area</div>
                <div class="info-value">${delivery.areaName}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Coordinates</div>
                <div class="info-value">${delivery.coordinates ? `${delivery.coordinates.length} points` : 'N/A'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Price</div>
                <div class="info-value">${delivery.totalPrice} MVR</div>
            </div>
            <div class="info-item">
                <div class="info-label">Current Status</div>
                <div class="info-value"><span class="status-badge ${getStatusClass(delivery.status)}">${delivery.status}</span></div>
            </div>
            <div class="info-item">
                <div class="info-label">Payment Status</div>
                <div class="info-value"><span class="status-badge ${getPaymentStatusClass(delivery.paymentStatus)}">${getPaymentStatusText(delivery.paymentStatus)}</span></div>
            </div>
        `;
    }
    
    customerInfo.innerHTML = detailsHTML;
    
    // Show delivery image if exists
    if (deliveryPreview && noImageMessage) {
        if (delivery.deliveryImage) {
            deliveryPreview.src = delivery.deliveryImage;
            deliveryPreview.classList.add('active');
            noImageMessage.style.display = 'none';
        } else {
            deliveryPreview.classList.remove('active');
            noImageMessage.style.display = 'block';
        }
    }
}

// Update progress tracker
function updateProgressTracker(progress) {
    // Reset all steps
    progressSteps.forEach(step => {
        step.classList.remove('active', 'completed');
    });
    
    // Set active and completed steps
    for (let i = 0; i < progress; i++) {
        if (i < progress - 1) {
            progressSteps[i].classList.add('completed');
        } else {
            progressSteps[i].classList.add('active');
        }
    }
    
    // Update progress bar
    const progressPercentage = ((progress - 1) / (progressSteps.length - 1)) * 100;
    if (progressBar) progressBar.style.width = `${progressPercentage}%`;
}

// Save updated data
function saveUpdatedData(type) {
    if (type === 'cargo') {
        saveCargoData();
        loadCargoData();
    } else if (type === 'boat') {
        saveBoatData();
        loadBoatData();
    } else if (type === 'greater-male') {
        saveGreaterMaleData();
        loadGreaterMaleData();
    } else if (type === 'area') {
        saveAreaBasedData();
        loadAreaData();
    }
}

// Reset search
function resetSearch() {
    const searchContact = document.getElementById('searchContact');
    if (searchContact) searchContact.value = '';
    if (customerDetails) customerDetails.classList.remove('active');
    if (customerReferences) customerReferences.classList.remove('active');
    currentDelivery = null;
    if (deliveryPreview) deliveryPreview.classList.remove('active');
    if (noImageMessage) noImageMessage.style.display = 'block';
}

// Delete delivery
function deleteDelivery(type, id) {
    if (confirm('Are you sure you want to delete this delivery?')) {
        if (type === 'cargo') {
            cargoDeliveries = cargoDeliveries.filter(d => d.id !== id);
            saveCargoData();
            loadCargoData();
            loadUserReferences();
        } else if (type === 'boat') {
            boatDeliveries = boatDeliveries.filter(d => d.id !== id);
            saveBoatData();
            loadBoatData();
            loadUserReferences();
        } else if (type === 'greater-male') {
            greaterMaleDeliveries = greaterMaleDeliveries.filter(d => d.id !== id);
            saveGreaterMaleData();
            loadGreaterMaleData();
            loadUserReferences();
        } else if (type === 'area') {
            areaBasedDeliveries = areaBasedDeliveries.filter(d => d.id !== id);
            saveAreaBasedData();
            loadAreaData();
            loadUserReferences();
        }
        showNotification('Delivery deleted successfully');
    }
}

// Price management
if (addCargoPriceBtn) {
    addCargoPriceBtn.addEventListener('click', function() {
        const minWeight = parseFloat(cargoMinWeight ? cargoMinWeight.value : 0);
        const maxWeight = parseFloat(cargoMaxWeight ? cargoMaxWeight.value : 0);
        const price = parseFloat(cargoPriceValue ? cargoPriceValue.value : 0);
        
        if (isNaN(minWeight) || isNaN(maxWeight) || isNaN(price)) {
            showNotification('Please enter valid values for all fields');
            return;
        }
        
        if (minWeight >= maxWeight) {
            showNotification('Minimum weight must be less than maximum weight');
            return;
        }
        
        // Check for overlapping ranges
        for (let range of cargoPriceRanges) {
            if ((minWeight >= range.min && minWeight <= range.max) || 
                (maxWeight >= range.min && maxWeight <= range.max) ||
                (minWeight <= range.min && maxWeight >= range.max)) {
                showNotification('Weight range overlaps with existing range');
                return;
            }
        }
        
        // Add new price range
        cargoPriceRanges.push({ min: minWeight, max: maxWeight, price: price });
        saveCargoPriceRanges();
        loadCargoPriceList();
        loadWeightOptions();
        
        // Reset form
        if (cargoMinWeight) cargoMinWeight.value = '';
        if (cargoMaxWeight) cargoMaxWeight.value = '';
        if (cargoPriceValue) cargoPriceValue.value = '';
        
        showNotification('Cargo price range added successfully');
    });
}

if (addBoatPriceBtn) {
    addBoatPriceBtn.addEventListener('click', function() {
        const minWeight = parseFloat(boatMinWeight ? boatMinWeight.value : 0);
        const maxWeight = parseFloat(boatMaxWeight ? boatMaxWeight.value : 0);
        const price = parseFloat(boatPriceValue ? boatPriceValue.value : 0);
        
        if (isNaN(minWeight) || isNaN(maxWeight) || isNaN(price)) {
            showNotification('Please enter valid values for all fields');
            return;
        }
        
        if (minWeight >= maxWeight) {
            showNotification('Minimum weight must be less than maximum weight');
            return;
        }
        
        // Check for overlapping ranges
        for (let range of boatPriceRanges) {
            if ((minWeight >= range.min && minWeight <= range.max) || 
                (maxWeight >= range.min && maxWeight <= range.max) ||
                (minWeight <= range.min && maxWeight >= range.max)) {
                showNotification('Weight range overlaps with existing range');
                return;
            }
        }
        
        // Add new price range
        boatPriceRanges.push({ min: minWeight, max: maxWeight, price: price });
        saveBoatPriceRanges();
        loadBoatPriceList();
        loadWeightOptions();
        
        // Reset form
        if (boatMinWeight) boatMinWeight.value = '';
        if (boatMaxWeight) boatMaxWeight.value = '';
        if (boatPriceValue) boatPriceValue.value = '';
        
        showNotification('Boat price range added successfully');
    });
}

// Greater Male City price management
if (addItemPriceBtn) {
    addItemPriceBtn.addEventListener('click', function() {
        const itemTypeValue = itemType ? itemType.value : '';
        const price = parseFloat(document.getElementById('itemPrice') ? document.getElementById('itemPrice').value : 0);
        
        if (isNaN(price)) {
            showNotification('Please enter a valid price');
            return;
        }
        
        // Update item price
        greaterMaleItemPrices[itemTypeValue] = price;
        saveGreaterMaleItemPrices();
        loadItemPriceList();
        
        // Reset form
        const itemPriceInput = document.getElementById('itemPrice');
        if (itemPriceInput) itemPriceInput.value = '';
        
        showNotification('Item price updated successfully');
    });
}

if (addDestinationPriceBtn) {
    addDestinationPriceBtn.addEventListener('click', function() {
        const destinationTypeValue = destinationType ? destinationType.value : '';
        const price = parseFloat(document.getElementById('destinationPrice') ? document.getElementById('destinationPrice').value : 0);
        
        if (isNaN(price)) {
            showNotification('Please enter a valid price');
            return;
        }
        
        // Update destination price
        greaterMaleDestinationPrices[destinationTypeValue] = price;
        saveGreaterMaleDestinationPrices();
        loadDestinationPriceList();
        
        // Reset form
        const destinationPriceInput = document.getElementById('destinationPrice');
        if (destinationPriceInput) destinationPriceInput.value = '';
        
        showNotification('Destination price updated successfully');
    });
}

// Load price lists
function loadCargoPriceList() {
    if (!cargoPriceList) return;
    
    cargoPriceList.innerHTML = '';
    
    if (cargoPriceRanges.length === 0) {
        cargoPriceList.innerHTML = '<div class="empty-message">No cargo price ranges defined</div>';
        return;
    }
    
    // Sort price ranges by min weight
    cargoPriceRanges.sort((a, b) => a.min - b.min);
    
    cargoPriceRanges.forEach((range, index) => {
        const item = document.createElement('div');
        item.className = 'price-item';
        item.innerHTML = `
            <div class="price-range">${range.min}-${range.max} kg</div>
            <div class="price-amount">${range.price} MVR</div>
            <div class="price-actions">
                <button class="edit-price-btn" onclick="editCargoPriceRange(${index})">Edit</button>
                <button class="remove-price-btn" onclick="removeCargoPriceRange(${index})">Remove</button>
            </div>
        `;
        cargoPriceList.appendChild(item);
    });
}

function loadBoatPriceList() {
    if (!boatPriceList) return;
    
    boatPriceList.innerHTML = '';
    
    if (boatPriceRanges.length === 0) {
        boatPriceList.innerHTML = '<div class="empty-message">No boat price ranges defined</div>';
        return;
    }
    
    // Sort price ranges by min weight
    boatPriceRanges.sort((a, b) => a.min - b.min);
    
    boatPriceRanges.forEach((range, index) => {
        const item = document.createElement('div');
        item.className = 'price-item';
        item.innerHTML = `
            <div class="price-range">${range.min}-${range.max} kg</div>
            <div class="price-amount">${range.price} MVR</div>
            <div class="price-actions">
                <button class="edit-price-btn" onclick="editBoatPriceRange(${index})">Edit</button>
                <button class="remove-price-btn" onclick="removeBoatPriceRange(${index})">Remove</button>
            </div>
        `;
        boatPriceList.appendChild(item);
    });
}

function loadItemPriceList() {
    if (!itemPriceList) return;
    
    itemPriceList.innerHTML = '';
    
    if (Object.keys(greaterMaleItemPrices).length === 0) {
        itemPriceList.innerHTML = '<div class="empty-message">No item prices defined</div>';
        return;
    }
    
    Object.entries(greaterMaleItemPrices).forEach(([itemType, price]) => {
        const item = document.createElement('div');
        item.className = 'price-item';
        
        item.innerHTML = `
            <div class="price-range">${itemType}</div>
            <div class="price-amount">${price} MVR</div>
        `;
        itemPriceList.appendChild(item);
    });
}

function loadDestinationPriceList() {
    if (!destinationPriceList) return;
    
    destinationPriceList.innerHTML = '';
    
    if (Object.keys(greaterMaleDestinationPrices).length === 0) {
        destinationPriceList.innerHTML = '<div class="empty-message">No destination prices defined</div>';
        return;
    }
    
    Object.entries(greaterMaleDestinationPrices).forEach(([destinationType, price]) => {
        const item = document.createElement('div');
        item.className = 'price-item';
        
        item.innerHTML = `
            <div class="price-range">${destinationType}</div>
            <div class="price-amount">${price} MVR</div>
        `;
        destinationPriceList.appendChild(item);
    });
}

// Load all price lists
function loadPriceLists() {
    loadCargoPriceList();
    loadBoatPriceList();
    loadItemPriceList();
    loadDestinationPriceList();
}

// Edit price range
function editCargoPriceRange(index) {
    const range = cargoPriceRanges[index];
    if (cargoMinWeight) cargoMinWeight.value = range.min;
    if (cargoMaxWeight) cargoMaxWeight.value = range.max;
    if (cargoPriceValue) cargoPriceValue.value = range.price;
    
    // Remove the range being edited
    cargoPriceRanges.splice(index, 1);
    saveCargoPriceRanges();
    loadCargoPriceList();
    loadWeightOptions();
}

function editBoatPriceRange(index) {
    const range = boatPriceRanges[index];
    if (boatMinWeight) boatMinWeight.value = range.min;
    if (boatMaxWeight) boatMaxWeight.value = range.max;
    if (boatPriceValue) boatPriceValue.value = range.price;
    
    // Remove the range being edited
    boatPriceRanges.splice(index, 1);
    saveBoatPriceRanges();
    loadBoatPriceList();
    loadWeightOptions();
}

// Remove price range
function removeCargoPriceRange(index) {
    if (confirm('Are you sure you want to remove this price range?')) {
        cargoPriceRanges.splice(index, 1);
        saveCargoPriceRanges();
        loadCargoPriceList();
        loadWeightOptions();
        showNotification('Cargo price range removed successfully');
    }
}

function removeBoatPriceRange(index) {
    if (confirm('Are you sure you want to remove this price range?')) {
        boatPriceRanges.splice(index, 1);
        saveBoatPriceRanges();
        loadBoatPriceList();
        loadWeightOptions();
        showNotification('Boat price range removed successfully');
    }
}

// User management
if (addUserBtn) {
    addUserBtn.addEventListener('click', function() {
        const username = document.getElementById('newUsername').value;
        const email = document.getElementById('newUserEmail').value;
        const contact = document.getElementById('newUserContact').value;
        const password = document.getElementById('newUserPassword').value;
        
        if (!username || !email || !contact || !password) {
            showNotification('Please fill all fields');
            return;
        }
        
        // Check if user already exists
        if (users.find(user => user.email === email)) {
            showNotification('User with this email already exists');
            return;
        }
        
        // Add new user with staff role
        users.push({
            id: Date.now(),
            username: username,
            email: email,
            contact: contact,
            password: password,
            role: 'staff'
        });
        
        saveUsers();
        loadUsers();
        
        // Reset form
        document.getElementById('newUsername').value = '';
        document.getElementById('newUserEmail').value = '';
        document.getElementById('newUserContact').value = '';
        document.getElementById('newUserPassword').value = '';
        
        showNotification('User added successfully');
    });
}

// Load users
function loadUsers() {
    if (!userList) return;
    
    userList.innerHTML = '';
    
    if (users.length === 0) {
        userList.innerHTML = '<div class="empty-message">No users found</div>';
        return;
    }
    
    users.forEach((user, index) => {
        // Don't show current user in the list
        if (user.email === currentUser.email) return;
        
        const item = document.createElement('div');
        item.className = 'user-item';
        item.innerHTML = `
            <div class="user-details">
                <div class="user-name">${user.username}</div>
                <div class="user-email">${user.email} • ${user.contact}</div>
            </div>
            <div>
                <span class="user-role ${user.role}">${user.role}</span>
            </div>
            <div class="user-actions">
                <button class="edit-user-btn" onclick="editUser(${index})">Edit</button>
                <button class="remove-user-btn" onclick="removeUser(${index})">Remove</button>
            </div>
        `;
        userList.appendChild(item);
    });
}

// Edit user
function editUser(index) {
    const user = users[index];
    if (editUsername) editUsername.value = user.username;
    if (editUserEmail) editUserEmail.value = user.email;
    if (editUserContact) editUserContact.value = user.contact;
    if (editUserPassword) editUserPassword.value = '';
    if (editUserRole) editUserRole.value = user.role;
    
    editingUserId = index;
    if (userEditModal) userEditModal.classList.add('active');
}

// Cancel user edit
if (cancelUserEdit) {
    cancelUserEdit.addEventListener('click', function() {
        if (userEditModal) userEditModal.classList.remove('active');
        editingUserId = null;
    });
}

// Confirm user edit
if (confirmUserEdit) {
    confirmUserEdit.addEventListener('click', function() {
        if (editingUserId === null) return;
        
        const user = users[editingUserId];
        if (!user) {
            showNotification('User not found');
            return;
        }
        
        user.username = editUsername ? editUsername.value : '';
        user.email = editUserEmail ? editUserEmail.value : '';
        user.contact = editUserContact ? editUserContact.value : '';
        user.role = editUserRole ? editUserRole.value : '';
        
        // Update password if provided
        if (editUserPassword && editUserPassword.value) {
            user.password = editUserPassword.value;
        }
        
        saveUsers();
        loadUsers();
        if (userEditModal) userEditModal.classList.remove('active');
        editingUserId = null;
        
        showNotification('User updated successfully');
    });
}

// Remove user
function removeUser(index) {
    if (confirm('Are you sure you want to remove this user?')) {
        if (index >= 0 && index < users.length) {
            users.splice(index, 1);
            saveUsers();
            loadUsers();
            showNotification('User removed successfully');
        } else {
            showNotification('Invalid user index');
        }
    }
}

// Global functions that are called from HTML onclick attributes
window.trackDeliveryByReference = function(referenceNumber) {
    // Search in cargo deliveries
    let delivery = cargoDeliveries.find(d => d.referenceNumber === referenceNumber);
    
    // If not found in cargo, search in boat deliveries
    if (!delivery) {
        delivery = boatDeliveries.find(d => d.referenceNumber === referenceNumber);
    }
    
    // If not found in boat, search in Greater Male City deliveries
    if (!delivery) {
        delivery = greaterMaleDeliveries.find(d => d.referenceNumber === referenceNumber);
    }
    
    // If not found in Greater Male City, search in area-based deliveries
    if (!delivery) {
        delivery = areaBasedDeliveries.find(d => d.referenceNumber === referenceNumber);
    }
    
    if (delivery) {
        // Switch to track delivery section
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        const trackDeliveryLink = document.querySelector('[data-section="track-delivery"]');
        if (trackDeliveryLink) {
            trackDeliveryLink.classList.add('active');
        }
        
        dashboardSections.forEach(section => {
            section.classList.remove('active');
            if (section.id === 'track-delivery') {
                section.classList.add('active');
            }
        });
        
        // Set search contact and trigger search
        const searchContact = document.getElementById('searchContact');
        if (searchContact) {
            searchContact.value = delivery.customerContact;
            if (searchBtn) searchBtn.click();
        }
    } else {
        showNotification('Delivery not found with this reference number');
    }
};

window.viewPaymentSlip = function(slipData) {
    if (slipImage) {
        slipImage.src = slipData;
        if (slipModal) slipModal.classList.add('active');
    }
};

window.openStatusModal = function(type, id) {
    currentDeliveryType = type;
    currentDeliveryId = id;
    
    let delivery;
    if (type === 'cargo') {
        delivery = cargoDeliveries.find(d => d.id === id);
    } else if (type === 'boat') {
        delivery = boatDeliveries.find(d => d.id === id);
    } else if (type === 'greater-male') {
        delivery = greaterMaleDeliveries.find(d => d.id === id);
    } else if (type === 'area') {
        delivery = areaBasedDeliveries.find(d => d.id === id);
    }
    
    if (!delivery) return;
    
    // Set current status in dropdown
    if (statusSelect) statusSelect.value = delivery.status;
    
    // Show/hide proof upload based on selected status
    toggleProofUpload();
    
    // Show modal
    if (statusModal) statusModal.classList.add('active');
};

window.approvePayment = function(type, id) {
    if (confirm('Are you sure you want to approve this payment?')) {
        let delivery;
        if (type === 'cargo') {
            delivery = cargoDeliveries.find(d => d.id === id);
        } else if (type === 'boat') {
            delivery = boatDeliveries.find(d => d.id === id);
        } else if (type === 'greater-male') {
            delivery = greaterMaleDeliveries.find(d => d.id === id);
        } else if (type === 'area') {
            delivery = areaBasedDeliveries.find(d => d.id === id);
        }
        
        if (delivery) {
            delivery.paymentStatus = 'paid';
            saveUpdatedData(type);
            
            // Add notification for the user who created the delivery
            addNotification(
                'Payment Approved',
                `Payment for your ${type} delivery to ${delivery.customerName} has been approved. Reference: ${delivery.referenceNumber}`,
                delivery.createdBy
            );
            
            showNotification('Payment approved successfully');
        }
    }
};

window.deleteDelivery = function(type, id) {
    if (confirm('Are you sure you want to delete this delivery?')) {
        if (type === 'cargo') {
            cargoDeliveries = cargoDeliveries.filter(d => d.id !== id);
            saveCargoData();
            loadCargoData();
            loadUserReferences();
        } else if (type === 'boat') {
            boatDeliveries = boatDeliveries.filter(d => d.id !== id);
            saveBoatData();
            loadBoatData();
            loadUserReferences();
        } else if (type === 'greater-male') {
            greaterMaleDeliveries = greaterMaleDeliveries.filter(d => d.id !== id);
            saveGreaterMaleData();
            loadGreaterMaleData();
            loadUserReferences();
        } else if (type === 'area') {
            areaBasedDeliveries = areaBasedDeliveries.filter(d => d.id !== id);
            saveAreaBasedData();
            loadAreaData();
            loadUserReferences();
        }
        showNotification('Delivery deleted successfully');
    }
};

window.editCargoPriceRange = function(index) {
    const range = cargoPriceRanges[index];
    if (cargoMinWeight) cargoMinWeight.value = range.min;
    if (cargoMaxWeight) cargoMaxWeight.value = range.max;
    if (cargoPriceValue) cargoPriceValue.value = range.price;
    
    // Remove the range being edited
    cargoPriceRanges.splice(index, 1);
    saveCargoPriceRanges();
    loadCargoPriceList();
    loadWeightOptions();
};

window.editBoatPriceRange = function(index) {
    const range = boatPriceRanges[index];
    if (boatMinWeight) boatMinWeight.value = range.min;
    if (boatMaxWeight) boatMaxWeight.value = range.max;
    if (boatPriceValue) boatPriceValue.value = range.price;
    
    // Remove the range being edited
    boatPriceRanges.splice(index, 1);
    saveBoatPriceRanges();
    loadBoatPriceList();
    loadWeightOptions();
};

window.removeCargoPriceRange = function(index) {
    if (confirm('Are you sure you want to remove this price range?')) {
        cargoPriceRanges.splice(index, 1);
        saveCargoPriceRanges();
        loadCargoPriceList();
        loadWeightOptions();
        showNotification('Cargo price range removed successfully');
    }
};

window.removeBoatPriceRange = function(index) {
    if (confirm('Are you sure you want to remove this price range?')) {
        boatPriceRanges.splice(index, 1);
        saveBoatPriceRanges();
        loadBoatPriceList();
        loadWeightOptions();
        showNotification('Boat price range removed successfully');
    }
};

window.editManagementItem = function(type, id) {
    currentManagementType = type;
    editingManagementId = id;
    
    let item;
    let collection;
    
    switch(type) {
        case 'pickupLocation':
            collection = pickupLocations;
            if (managementModalTitle) managementModalTitle.textContent = 'Edit Pickup Location';
            if (managementPriceField) managementPriceField.style.display = 'none';
            break;
        case 'destination':
            collection = destinations;
            if (managementModalTitle) managementModalTitle.textContent = 'Edit Destination';
            if (managementPriceField) managementPriceField.style.display = 'block';
            break;
        case 'itemSize':
            collection = itemSizes;
            if (managementModalTitle) managementModalTitle.textContent = 'Edit Item Size';
            if (managementPriceField) managementPriceField.style.display = 'block';
            break;
        case 'vehicle':
            collection = vehicles;
            if (managementModalTitle) managementModalTitle.textContent = 'Edit Vehicle';
            if (managementPriceField) managementPriceField.style.display = 'block';
            break;
    }
    
    item = collection.find(i => i.id === id);
    if (item) {
        if (managementName) managementName.value = item.name;
        if (managementDescription) managementDescription.value = item.description;
        if (type !== 'pickupLocation' && managementPrice) {
            managementPrice.value = item.price;
        }
        if (managementModal) managementModal.classList.add('active');
    }
};

window.removeManagementItem = function(type, id) {
    if (confirm('Are you sure you want to remove this item?')) {
        let collection;
        
        switch(type) {
            case 'pickupLocation':
                collection = pickupLocations;
                break;
            case 'destination':
                collection = destinations;
                break;
            case 'itemSize':
                collection = itemSizes;
                break;
            case 'vehicle':
                collection = vehicles;
                break;
        }
        
        const index = collection.findIndex(i => i.id === id);
        if (index !== -1) {
            collection.splice(index, 1);
            saveManagementData(type);
            loadManagementData();
            showNotification('Item removed successfully');
        }
    }
};

window.editAreaPricing = function(id) {
    const area = areaPricing.find(a => a.id === id);
    if (!area) return;
    
    if (areaName) areaName.value = area.name;
    if (areaPrice) areaPrice.value = area.price;
    
    // Remove the area being edited
    areaPricing = areaPricing.filter(a => a.id !== id);
    saveAreaPricing();
    loadAreaPricing();
    
    // Draw the polygon on the map
    if (selectedPolygon) {
        selectedPolygon.setMap(null);
    }
    
    const polygonCoords = area.coordinates.map(coord => new google.maps.LatLng(coord.lat, coord.lng));
    selectedPolygon = new google.maps.Polygon({
        paths: polygonCoords,
        strokeColor: '#1a2a6c',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: '#4cc9f0',
        fillOpacity: 0.3
    });
    
    selectedPolygon.setMap(areaMap);
    selectedAreaCoordinates = polygonCoords;
    
    // Update area coordinates info
    updateAreaCoordinatesInfo();
    
    // Fit map to polygon bounds
    const bounds = new google.maps.LatLngBounds();
    polygonCoords.forEach(coord => bounds.extend(coord));
    if (areaMap) areaMap.fitBounds(bounds);
};

window.removeAreaPricing = function(id) {
    if (confirm('Are you sure you want to remove this area pricing?')) {
        areaPricing = areaPricing.filter(a => a.id !== id);
        saveAreaPricing();
        loadAreaPricing();
        showNotification('Area pricing removed successfully');
    }
};

// Firebase Data Management Functions
function saveCargoData() {
    if (cargoRef) {
        cargoRef.set(cargoDeliveries)
            .then(() => console.log('Cargo data saved to Firebase'))
            .catch(error => console.error('Error saving cargo data:', error));
    } else {
        // Fallback to localStorage if Firebase not available
        localStorage.setItem('cargoDeliveries', JSON.stringify(cargoDeliveries));
    }
}

function saveBoatData() {
    if (boatRef) {
        boatRef.set(boatDeliveries)
            .then(() => console.log('Boat data saved to Firebase'))
            .catch(error => console.error('Error saving boat data:', error));
    } else {
        localStorage.setItem('boatDeliveries', JSON.stringify(boatDeliveries));
    }
}

function saveGreaterMaleData() {
    if (greaterMaleRef) {
        greaterMaleRef.set(greaterMaleDeliveries)
            .then(() => console.log('Greater Male City data saved to Firebase'))
            .catch(error => console.error('Error saving Greater Male City data:', error));
    } else {
        localStorage.setItem('greaterMaleDeliveries', JSON.stringify(greaterMaleDeliveries));
    }
}

function saveAreaBasedData() {
    if (areaBasedRef) {
        areaBasedRef.set(areaBasedDeliveries)
            .then(() => console.log('Area-based data saved to Firebase'))
            .catch(error => console.error('Error saving area-based data:', error));
    } else {
        localStorage.setItem('areaBasedDeliveries', JSON.stringify(areaBasedDeliveries));
    }
}

function saveCargoPriceRanges() {
    if (cargoPriceRangesRef) {
        cargoPriceRangesRef.set(cargoPriceRanges)
            .then(() => console.log('Cargo price ranges saved to Firebase'))
            .catch(error => console.error('Error saving cargo price ranges:', error));
    } else {
        localStorage.setItem('cargoPriceRanges', JSON.stringify(cargoPriceRanges));
    }
}

function saveBoatPriceRanges() {
    if (boatPriceRangesRef) {
        boatPriceRangesRef.set(boatPriceRanges)
            .then(() => console.log('Boat price ranges saved to Firebase'))
            .catch(error => console.error('Error saving boat price ranges:', error));
    } else {
        localStorage.setItem('boatPriceRanges', JSON.stringify(boatPriceRanges));
    }
}

function saveAreaPricing() {
    if (areaPricingRef) {
        areaPricingRef.set(areaPricing)
            .then(() => console.log('Area pricing saved to Firebase'))
            .catch(error => console.error('Error saving area pricing:', error));
    } else {
        localStorage.setItem('areaPricing', JSON.stringify(areaPricing));
    }
}

function saveManagementData(type) {
    switch(type) {
        case 'pickupLocation':
            if (pickupLocationsRef) {
                pickupLocationsRef.set(pickupLocations)
                    .then(() => console.log('Pickup locations saved to Firebase'))
                    .catch(error => console.error('Error saving pickup locations:', error));
            } else {
                localStorage.setItem('pickupLocations', JSON.stringify(pickupLocations));
            }
            break;
        case 'destination':
            if (destinationsRef) {
                destinationsRef.set(destinations)
                    .then(() => console.log('Destinations saved to Firebase'))
                    .catch(error => console.error('Error saving destinations:', error));
            } else {
                localStorage.setItem('destinations', JSON.stringify(destinations));
            }
            break;
        case 'itemSize':
            if (itemSizesRef) {
                itemSizesRef.set(itemSizes)
                    .then(() => console.log('Item sizes saved to Firebase'))
                    .catch(error => console.error('Error saving item sizes:', error));
            } else {
                localStorage.setItem('itemSizes', JSON.stringify(itemSizes));
            }
            break;
        case 'vehicle':
            if (vehiclesRef) {
                vehiclesRef.set(vehicles)
                    .then(() => console.log('Vehicles saved to Firebase'))
                    .catch(error => console.error('Error saving vehicles:', error));
            } else {
                localStorage.setItem('vehicles', JSON.stringify(vehicles));
            }
            break;
    }
}

function saveGreaterMaleItemPrices() {
    if (greaterMaleItemPricesRef) {
        greaterMaleItemPricesRef.set(greaterMaleItemPrices)
            .then(() => console.log('Greater Male City item prices saved to Firebase'))
            .catch(error => console.error('Error saving Greater Male City item prices:', error));
    } else {
        localStorage.setItem('greaterMaleItemPrices', JSON.stringify(greaterMaleItemPrices));
    }
}

function saveGreaterMaleDestinationPrices() {
    if (greaterMaleDestinationPricesRef) {
        greaterMaleDestinationPricesRef.set(greaterMaleDestinationPrices)
            .then(() => console.log('Greater Male City destination prices saved to Firebase'))
            .catch(error => console.error('Error saving Greater Male City destination prices:', error));
    } else {
        localStorage.setItem('greaterMaleDestinationPrices', JSON.stringify(greaterMaleDestinationPrices));
    }
}

function saveGreaterMaleVehiclePrices() {
    if (greaterMaleVehiclePricesRef) {
        greaterMaleVehiclePricesRef.set(greaterMaleVehiclePrices)
            .then(() => console.log('Greater Male City vehicle prices saved to Firebase'))
            .catch(error => console.error('Error saving Greater Male City vehicle prices:', error));
    } else {
        localStorage.setItem('greaterMaleVehiclePrices', JSON.stringify(greaterMaleVehiclePrices));
    }
}

function saveUsers() {
    if (usersRef) {
        usersRef.set(users)
            .then(() => console.log('Users saved to Firebase'))
            .catch(error => console.error('Error saving users:', error));
    } else {
        localStorage.setItem('users', JSON.stringify(users));
    }
}

function saveNotifications() {
    if (notificationsRef) {
        notificationsRef.set(notifications)
            .then(() => console.log('Notifications saved to Firebase'))
            .catch(error => console.error('Error saving notifications:', error));
    } else {
        localStorage.setItem('notifications', JSON.stringify(notifications));
    }
}

// Load data from Firebase or localStorage
function loadStoredData() {
    // Try Firebase first, then fallback to localStorage
    if (cargoRef) {
        // Load cargo deliveries
        cargoRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                cargoDeliveries = data;
                loadCargoData();
            }
        });
        
        // Load boat deliveries
        boatRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                boatDeliveries = data;
                loadBoatData();
            }
        });
        
        // Load Greater Male City deliveries
        greaterMaleRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                greaterMaleDeliveries = data;
                loadGreaterMaleData();
            }
        });
        
        // Load area-based deliveries
        areaBasedRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                areaBasedDeliveries = data;
                loadAreaData();
            }
        });
        
        // Load cargo price ranges
        cargoPriceRangesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                cargoPriceRanges = data;
                loadCargoPriceList();
                loadWeightOptions();
            }
        });
        
        // Load boat price ranges
        boatPriceRangesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                boatPriceRanges = data;
                loadBoatPriceList();
                loadWeightOptions();
            }
        });
        
        // Load area pricing
        areaPricingRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                areaPricing = data;
                loadAreaPricing();
            }
        });
        
        // Load pickup locations
        pickupLocationsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                pickupLocations = data;
                loadManagementData();
            }
        });
        
        // Load destinations
        destinationsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                destinations = data;
                loadManagementData();
            }
        });
        
        // Load item sizes
        itemSizesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                itemSizes = data;
                loadManagementData();
            }
        });
        
        // Load vehicles
        vehiclesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                vehicles = data;
                loadManagementData();
            }
        });
        
        // Load Greater Male City item prices
        greaterMaleItemPricesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                greaterMaleItemPrices = data;
                loadItemPriceList();
            }
        });
        
        // Load Greater Male City destination prices
        greaterMaleDestinationPricesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                greaterMaleDestinationPrices = data;
                loadDestinationPriceList();
            }
        });
        
        // Load Greater Male City vehicle prices
        greaterMaleVehiclePricesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                greaterMaleVehiclePrices = data;
            }
        });
        
        // Load users
        usersRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                users = data;
            }
        });
        
        // Load notifications
        notificationsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                notifications = data;
                loadNotifications();
                updateNotificationBadge();
            }
        });
    } else {
        // Fallback to localStorage
        const savedCargo = localStorage.getItem('cargoDeliveries');
        const savedBoat = localStorage.getItem('boatDeliveries');
        const savedGreaterMale = localStorage.getItem('greaterMaleDeliveries');
        const savedAreaBased = localStorage.getItem('areaBasedDeliveries');
        const savedCargoPrices = localStorage.getItem('cargoPriceRanges');
        const savedBoatPrices = localStorage.getItem('boatPriceRanges');
        const savedAreaPricing = localStorage.getItem('areaPricing');
        const savedPickupLocations = localStorage.getItem('pickupLocations');
        const savedDestinations = localStorage.getItem('destinations');
        const savedItemSizes = localStorage.getItem('itemSizes');
        const savedVehicles = localStorage.getItem('vehicles');
        const savedGreaterMaleItemPrices = localStorage.getItem('greaterMaleItemPrices');
        const savedGreaterMaleDestinationPrices = localStorage.getItem('greaterMaleDestinationPrices');
        const savedGreaterMaleVehiclePrices = localStorage.getItem('greaterMaleVehiclePrices');
        const savedUsers = localStorage.getItem('users');
        const savedNotifications = localStorage.getItem('notifications');
        
        if (savedCargo) cargoDeliveries = JSON.parse(savedCargo);
        if (savedBoat) boatDeliveries = JSON.parse(savedBoat);
        if (savedGreaterMale) greaterMaleDeliveries = JSON.parse(savedGreaterMale);
        if (savedAreaBased) areaBasedDeliveries = JSON.parse(savedAreaBased);
        if (savedCargoPrices) cargoPriceRanges = JSON.parse(savedCargoPrices);
        if (savedBoatPrices) boatPriceRanges = JSON.parse(savedBoatPrices);
        if (savedAreaPricing) areaPricing = JSON.parse(savedAreaPricing);
        if (savedPickupLocations) pickupLocations = JSON.parse(savedPickupLocations);
        if (savedDestinations) destinations = JSON.parse(savedDestinations);
        if (savedItemSizes) itemSizes = JSON.parse(savedItemSizes);
        if (savedVehicles) vehicles = JSON.parse(savedVehicles);
        if (savedGreaterMaleItemPrices) greaterMaleItemPrices = JSON.parse(savedGreaterMaleItemPrices);
        if (savedGreaterMaleDestinationPrices) greaterMaleDestinationPrices = JSON.parse(savedGreaterMaleDestinationPrices);
        if (savedGreaterMaleVehiclePrices) greaterMaleVehiclePrices = JSON.parse(savedGreaterMaleVehiclePrices);
        if (savedUsers) users = JSON.parse(savedUsers);
        if (savedNotifications) notifications = JSON.parse(savedNotifications);
        
        loadCargoData();
        loadBoatData();
        loadGreaterMaleData();
        loadAreaData();
        loadCargoPriceList();
        loadBoatPriceList();
        loadItemPriceList();
        loadDestinationPriceList();
        loadAreaPricing();
        loadWeightOptions();
        loadManagementData();
        loadNotifications();
        updateNotificationBadge();
    }
}

// Format date for display
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return new Date(dateString).toLocaleDateString(undefined, options);
    } catch (error) {
        return 'Invalid Date';
    }
}

// Show notification
function showNotification(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'toast-notification';
    notification.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-info-circle"></i>
            <span>${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Add styles if not already added
    if (!document.querySelector('#toast-styles')) {
        const toastStyles = document.createElement('style');
        toastStyles.id = 'toast-styles';
        toastStyles.textContent = `
            .toast-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff;
                border-left: 4px solid #4cc9f0;
                border-radius: 8px;
                padding: 15px 20px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: space-between;
                min-width: 300px;
                max-width: 500px;
                animation: slideInRight 0.3s ease-out;
            }
            .toast-content {
                display: flex;
                align-items: center;
                gap: 10px;
                flex: 1;
            }
            .toast-content i {
                color: #4cc9f0;
            }
            .toast-close {
                background: none;
                border: none;
                color: #666;
                cursor: pointer;
                padding: 5px;
                margin-left: 10px;
            }
            .toast-close:hover {
                color: #333;
            }
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(toastStyles);
    }
    
    // Add to document
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// Initialize the application when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Set minimum date for delivery date fields to today
    const today = new Date().toISOString().split('T')[0];
    const deliveryDate = document.getElementById('deliveryDate');
    const boatDeliveryDate = document.getElementById('boatDeliveryDate');
    
    if (deliveryDate) deliveryDate.min = today;
    if (boatDeliveryDate) boatDeliveryDate.min = today;
    
    // Initialize any other components that need setup
    initializeDateFilters();
});

// Initialize date filters for revenue dashboard
function initializeDateFilters() {
    // Set default dates for revenue filter
    const today = new Date();
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(today.getDate() - 7);
    
    if (startDate) startDate.value = oneWeekAgo.toISOString().split('T')[0];
    if (endDate) endDate.value = today.toISOString().split('T')[0];
    
    // Apply filter button
    if (applyFilter) {
        applyFilter.addEventListener('click', function() {
            loadRevenueData();
        });
    }
    
    // Reset filter button
    if (resetFilter) {
        resetFilter.addEventListener('click', function() {
            const today = new Date();
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(today.getDate() - 7);
            
            if (startDate) startDate.value = oneWeekAgo.toISOString().split('T')[0];
            if (endDate) endDate.value = today.toISOString().split('T')[0];
            
            loadRevenueData();
        });
    }
}

// Enhanced revenue chart functionality
function initializeRevenueChart() {
    const ctx = document.getElementById('revenueChart');
    if (!ctx) return;
    
    // Sample data - in a real app, this would come from your revenue data
    const revenueData = {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
            label: 'Daily Revenue (MVR)',
            data: [1200, 1900, 1500, 2200, 1800, 2500, 2000],
            backgroundColor: 'rgba(76, 201, 240, 0.2)',
            borderColor: 'rgba(76, 201, 240, 1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true
        }]
    };
    
    // Check if Chart is available
    if (typeof Chart !== 'undefined') {
        const revenueChart = new Chart(ctx, {
            type: 'line',
            data: revenueData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Weekly Revenue Trend'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + ' MVR';
                            }
                        }
                    }
                }
            }
        });
    }
}

// Enhanced search functionality with real-time filtering
function initializeEnhancedSearch() {
    const searchContact = document.getElementById('searchContact');
    
    if (searchContact) {
        // Add real-time search as user types
        searchContact.addEventListener('input', function() {
            const contact = this.value.trim();
            if (contact.length >= 3) {
                // Perform search automatically after 3 characters
                setTimeout(() => {
                    if (this.value === contact) { // Ensure value hasn't changed
                        if (searchBtn) searchBtn.click();
                    }
                }, 500);
            }
        });
        
        // Add enter key support
        searchContact.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (searchBtn) searchBtn.click();
            }
        });
    }
}

// Enhanced notification system
function initializeNotificationSystem() {
    // Check for new notifications periodically
    setInterval(() => {
        if (currentUser) {
            checkNewNotifications();
        }
    }, 30000); // Check every 30 seconds
    
    // Initialize notification sound
    if (notificationSound) {
        notificationSound.volume = 0.3; // Set appropriate volume
    }
}

// Enhanced form validation
function initializeFormValidation() {
    // Add real-time validation to forms
    const forms = document.querySelectorAll('form');
    
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            // Basic validation for required fields
            const requiredFields = this.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = '#f44336';
                    
                    // Add error message
                    let errorMsg = field.parentElement.querySelector('.field-error');
                    if (!errorMsg) {
                        errorMsg = document.createElement('div');
                        errorMsg.className = 'field-error';
                        errorMsg.style.color = '#f44336';
                        errorMsg.style.fontSize = '12px';
                        errorMsg.style.marginTop = '5px';
                        field.parentElement.appendChild(errorMsg);
                    }
                    errorMsg.textContent = 'This field is required';
                } else {
                    field.style.borderColor = '';
                    const errorMsg = field.parentElement.querySelector('.field-error');
                    if (errorMsg) {
                        errorMsg.remove();
                    }
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                showNotification('Please fill all required fields');
            }
        });
    });
}

// Enhanced mobile responsiveness
function initializeMobileOptimizations() {
    // Handle viewport adjustments for mobile
    function handleViewport() {
        const viewport = document.querySelector('meta[name="viewport"]');
        if (window.innerWidth <= 768) {
            viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
        } else {
            viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');
        }
    }
    
    // Initial call
    handleViewport();
    
    // Update on resize
    window.addEventListener('resize', handleViewport);
    
    // Enhanced touch interactions for mobile
    document.addEventListener('touchstart', function() {}, { passive: true });
}

// Enhanced data export functionality
function initializeDataExport() {
    // Add export buttons to records management
    const exportButtons = `
        <div style="margin-bottom: 15px; display: flex; gap: 10px;">
            <button class="export-btn" onclick="exportData('cargo')">Export Cargo Data</button>
            <button class="export-btn" onclick="exportData('boat')">Export Boat Data</button>
            <button class="export-btn" onclick="exportData('greater-male')">Export Greater Male Data</button>
            <button class="export-btn" onclick="exportData('area')">Export Area Data</button>
        </div>
    `;
    
    // Add export buttons to records management sections
    const recordsSections = document.querySelectorAll('.records-content');
    recordsSections.forEach(section => {
        const dataContainer = section.querySelector('.data-container');
        if (dataContainer) {
            dataContainer.insertAdjacentHTML('afterbegin', exportButtons);
        }
    });
}

// Export data to CSV
function exportData(type) {
    let data = [];
    let filename = '';
    
    switch(type) {
        case 'cargo':
            data = cargoDeliveries;
            filename = 'cargo_deliveries.csv';
            break;
        case 'boat':
            data = boatDeliveries;
            filename = 'boat_deliveries.csv';
            break;
        case 'greater-male':
            data = greaterMaleDeliveries;
            filename = 'greater_male_deliveries.csv';
            break;
        case 'area':
            data = areaBasedDeliveries;
            filename = 'area_based_deliveries.csv';
            break;
    }
    
    if (data.length === 0) {
        showNotification('No data to export');
        return;
    }
    
    // Convert to CSV
    const headers = Object.keys(data[0]);
    const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => {
            const value = row[header];
            // Handle values that might contain commas
            return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
        }).join(','))
    ].join('\n');
    
    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
    
    showNotification(`Exported ${data.length} ${type} records`);
}

// Enhanced error handling
function initializeErrorHandling() {
    window.addEventListener('error', function(e) {
        console.error('Global error:', e.error);
        showNotification('An unexpected error occurred. Please refresh the page.');
    });
    
    // Handle promise rejections
    window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled promise rejection:', e.reason);
        showNotification('An unexpected error occurred. Please try again.');
    });
}

// Enhanced performance optimizations
function initializePerformanceOptimizations() {
    // Lazy load images
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.classList.remove('lazy');
                    imageObserver.unobserve(img);
                }
            });
        });
        
        document.querySelectorAll('img[data-src]').forEach(img => {
            imageObserver.observe(img);
        });
    }
    
    // Debounce resize events
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            // Handle resize operations
            if (window.innerWidth <= 768) {
                // Mobile-specific adjustments
                document.body.classList.add('mobile-view');
            } else {
                document.body.classList.remove('mobile-view');
            }
        }, 250);
    });
}

// Initialize all enhanced features when the app is ready
function initializeEnhancedFeatures() {
    initializeRevenueChart();
    initializeEnhancedSearch();
    initializeNotificationSystem();
    initializeFormValidation();
    initializeMobileOptimizations();
    initializeDataExport();
    initializeErrorHandling();
    initializePerformanceOptimizations();
}

// Final initialization when everything is loaded
window.addEventListener('load', function() {
    // Initialize enhanced features
    initializeEnhancedFeatures();
    
    // Show welcome message for first-time users
    const firstVisit = !localStorage.getItem('hasVisitedBefore');
    if (firstVisit && currentUser) {
        showNotification(`Welcome to EasyCargo, ${currentUser.username}!`);
        localStorage.setItem('hasVisitedBefore', 'true');
    }
    
    // Initialize any third-party integrations
    initializeThirdPartyIntegrations();
});

// Third-party integrations placeholder
function initializeThirdPartyIntegrations() {
    // This function can be extended to integrate with:
    // - Payment gateways
    // - SMS services
    // - Email services
    // - Analytics
    // - Other APIs
    
    console.log('Third-party integrations initialized');
}

// Service Worker registration for PWA capabilities (optional)
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
            .then(function(registration) {
                console.log('SW registered: ', registration);
            })
            .catch(function(registrationError) {
                console.log('SW registration failed: ', registrationError);
            });
    });
}

// Export functions for global access (if needed in other scripts)
window.EasyCargo = {
    trackDeliveryByReference,
    viewPaymentSlip,
    openStatusModal,
    approvePayment,
    deleteDelivery,
    editCargoPriceRange,
    editBoatPriceRange,
    removeCargoPriceRange,
    removeBoatPriceRange,
    editManagementItem,
    removeManagementItem,
    editAreaPricing,
    removeAreaPricing,
    exportData,
    showNotification
};

// Final app initialization call
initApp();</script>

</body>
</html>